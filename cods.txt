Esse √© meu projeto:

Chat_Online/:

route.py:

# Chat_Online/route.py
from app.controllers.application import Application
from bottle import Bottle, route, run, request, static_file
from bottle import redirect, template, response, post, get

app = Bottle()
ctl = Application()

#-----------------------------------------------------------------------------
# ROTAS P√öBLICAS (N√£o requerem autentica√ß√£o)
#-----------------------------------------------------------------------------

@app.route('/static/<filepath:path>')
def serve_static(filepath):
    return static_file(filepath, root='./app/static')

@app.route('/')
def index():
    return redirect('/portal')

@app.route('/portal')
def portal():
    return ctl.portal_get()

#-----------------------------------------------------------------------------
# CRUD DE AUTENTICA√á√ÉO (Login/Logout/Cadastro)
#-----------------------------------------------------------------------------

@app.post('/cadastrar')
def cadastrar():
    return ctl.cadastrar_post()

@app.post('/login')
def login():
    return ctl.login_post()

@app.post('/logout')
def logout():
    return ctl.logout_post()

#-----------------------------------------------------------------------------
# CRUD DE USU√ÅRIOS
#-----------------------------------------------------------------------------

@app.get('/user-info')
def user_info():
    return ctl.user_info()

@app.get('/user-list')
def user_list():
    return ctl.user_list()

@app.get('/search-users')
def search_users():
    return ctl.search_users()

@app.post('/delete-account')
def delete_account():
    return ctl.delete_account()

#-----------------------------------------------------------------------------
# CRUD DE MENSAGENS (CREATE, READ, UPDATE, DELETE)
#-----------------------------------------------------------------------------

@app.post('/send')
def send_message():
    return ctl.send_message()

@app.get('/messages')
def get_messages():
    return ctl.get_messages()

@app.post('/edit-message')
def edit_message():
    return ctl.edit_message()

@app.post('/delete-message') 
def delete_message():
    return ctl.delete_message()

#-----------------------------------------------------------------------------
# CRUD DE AMIZADES (Sistema Social)
#-----------------------------------------------------------------------------

@app.post('/send-friend-request')
def send_friend_request():
    return ctl.send_friend_request()

@app.post('/accept-friend-request')
def accept_friend_request():
    return ctl.accept_friend_request()

@app.post('/reject-friend-request')
def reject_friend_request():
    return ctl.reject_friend_request()

@app.get('/friends')
def get_friends():
    return ctl.get_friends()

@app.get('/friend-requests')
def get_friend_requests():
    return ctl.get_friend_requests()

@app.post('/remove-friend')
def remove_friend():
    return ctl.remove_friend()

#-----------------------------------------------------------------------------
# CRUD DE CONVERSAS E GRUPOS
#-----------------------------------------------------------------------------

@app.get('/conversas')
def get_conversas():
    return ctl.get_conversas()

@app.post('/criar-grupo')
def criar_grupo():
    return ctl.criar_grupo()

@app.get('/abrir-conversa')
def abrir_conversa():
    return ctl.abrir_conversa()

@app.post('/excluir-grupo')
def excluir_grupo():
    return ctl.excluir_grupo()
#-----------------------------------------------------------------------------
# SERVI√áOS DE M√çDIA (Uploads)
#-----------------------------------------------------------------------------

@app.route('/uploads/images/<filename:path>')
def serve_image(filename):
    return ctl.serve_image(filename)

@app.route('/uploads/audios/<filename:path>')
def serve_audio(filename):
    return ctl.serve_audio(filename)

#-----------------------------------------------------------------------------
# ROTAS DE P√ÅGINAS (Views)
#-----------------------------------------------------------------------------

@app.get('/home')
def home_page():
    return ctl.home_get()

#-----------------------------------------------------------------------------
# ROTAS DE DEBUG (Desenvolvimento)
#-----------------------------------------------------------------------------

@app.post('/debug-request')
def debug_request():
    return ctl.debug_request()

#-----------------------------------------------------------------------------

if __name__ == '__main__':
    # Inicializar banco de dados
    from app.models.database import Database
    db = Database()
    db.init_db()
    
    run(app, host='localhost', port=8080, debug=True)

test_bcrypt.py:

# test_bcrypt.py
import bcrypt

def test_bcrypt():
    print("üß™ Testando bcrypt...")
    
    # Teste de hash
    password = "minhasenha123"
    hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
    print(f"‚úÖ Hash gerado: {hashed.decode('utf-8')}")
    
    # Teste de verifica√ß√£o
    check = bcrypt.checkpw(password.encode('utf-8'), hashed)
    print(f"‚úÖ Verifica√ß√£o: {check}")
    
    # Teste com senha errada
    wrong_check = bcrypt.checkpw("senhaerrada".encode('utf-8'), hashed)
    print(f"‚úÖ Verifica√ß√£o com senha errada: {wrong_check}")

if __name__ == '__main__':
    test_bcrypt()

test_db.py:

# test_db.py
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.models.database import Database

def test_connection():
    print("üß™ Testando conex√£o com o banco...")
    try:
        db = Database()
        with db.get_cursor() as cur:
            cur.execute("SELECT version();")
            version = cur.fetchone()
            print(f"‚úÖ Conectado ao PostgreSQL: {version[0]}")
            
            # Testar se o usu√°rio tem permiss√µes
            cur.execute("SELECT current_user, current_database();")
            user, database = cur.fetchone()
            print(f"üë§ Usu√°rio: {user}, Banco: {database}")
            
        return True
    except Exception as e:
        print(f"‚ùå Falha na conex√£o: {e}")
        print("\nüîß Verifique:")
        print("1. PostgreSQL est√° rodando?")
        print("2. As credenciais no .env est√£o corretas?")
        print("3. O usu√°rio chat_user existe e tem permiss√µes?")
        return False

if __name__ == '__main__':
    if test_connection():
        print("\nüéâ Conex√£o bem-sucedida! Agora execute: python init_db.py")
    else:
        input("\nPressione Enter para sair...")

init_db.py:

# init_db.py - VERS√ÉO CORRIGIDA
import sys
import os

sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.models.database import Database

def main():
    print("üîÑ Inicializando banco de dados...")
    try:
        db = Database()
        db.init_db()
        print("‚úÖ Banco de dados inicializado com sucesso!")
        print("üìä Tabelas criadas:")
        print("   - usuarios")
        print("   - mensagens") 
        print("   - sessoes")
        print("   - pedidos_amizade")
        print("   - amizades")
        print("   - conversas")
        print("   - participantes_conversa")
        
    except Exception as e:
        print(f"‚ùå Erro ao inicializar banco: {e}")
        print("\nüîß Solu√ß√£o de problemas:")
        print("1. Verifique se o PostgreSQL est√° rodando")
        print("2. Confirme as credenciais no arquivo .env")
        print("3. Certifique-se que o usu√°rio chat_user existe")
        input("Pressione Enter para sair...")
        sys.exit(1)

if __name__ == '__main__':
    main()

.env:

DB_HOST=localhost
DB_NAME=chat_online
DB_USER=chat_user
DB_PASSWORD=chat_password
DB_PORT=5432

Chat_Online/app/controllers/:

__init__.py

application.py:

# app/controllers/application.py 
import json
from datetime import datetime, timedelta
from bottle import template, request, response, redirect, static_file

from app.models.usuario import Usuario
from app.models.mensagem import Mensagem
from app.models.chat import Chat
from app.models.database import Database
from app.models.conversa import Conversa

class Application():
    def __init__(self):
        self.chat = Chat()
        self.pages = {
            'portal': self.portal_page,
            'chat': self.chat_page,
            'home': self.home_page
        }

    def get_usuario_autenticado(self):
        session_token = request.get_cookie('session_token')
        if session_token:
            return Usuario.validar_sessao(session_token)
        return None

    def render(self, page, **kwargs):
        content = self.pages.get(page, self.portal_page)
        return content(**kwargs)

    def portal_page(self, **kwargs):
        return template('app/views/html/portal', **kwargs)

    def chat_page(self, **kwargs):
        return template('app/views/html/chat', **kwargs)

    def home_page(self, **kwargs):
        return template('app/views/html/home', **kwargs)

    # Rotas do Portal
    def portal_get(self):
        usuario = self.get_usuario_autenticado()
        if usuario:
            return redirect('/home')
        return self.render('portal')

    def cadastrar_post(self):
        try:
            data = request.json
            username = data.get('username', '').strip()
            password = data.get('password', '').strip()

            if not username or not password:
                response.status = 400
                return json.dumps({'error': 'Nome de usu√°rio e senha s√£o obrigat√≥rios'})

            if len(username) < 3:
                response.status = 400
                return json.dumps({'error': 'Nome de usu√°rio deve ter pelo menos 3 caracteres'})

            # ‚úÖ VALIDA√á√ÉO DE SENHA NO BACKEND TAMB√âM
            if len(password) < 8:
                response.status = 400
                return json.dumps({'error': 'Senha deve ter pelo menos 8 caracteres'})
            
            if not any(c.isupper() for c in password):
                response.status = 400
                return json.dumps({'error': 'Senha deve conter pelo menos uma letra mai√∫scula'})
                
            if not any(c.islower() for c in password):
                response.status = 400
                return json.dumps({'error': 'Senha deve conter pelo menos uma letra min√∫scula'})
                
            if not any(c.isdigit() for c in password):
                response.status = 400
                return json.dumps({'error': 'Senha deve conter pelo menos um n√∫mero'})

            usuario = Usuario.criar(username, password)
            if usuario:
                session_token = usuario.criar_sessao()
                response.set_cookie('session_token', session_token, path='/')
                return json.dumps({'success': True, 'message': 'Cadastro realizado com sucesso!'})
            else:
                response.status = 400
                return json.dumps({'error': 'Nome de usu√°rio j√° existe'})

        except Exception as e:
            response.status = 500
            return json.dumps({'error': str(e)})

    def login_post(self):
        try:
            data = request.json
            username = data.get('username', '').strip()
            password = data.get('password', '').strip()

            if not username or not password:
                response.status = 400
                return json.dumps({'error': 'Nome de usu√°rio e senha s√£o obrigat√≥rios'})

            usuario = Usuario.autenticar(username, password)
            if usuario:
                usuario.atualizar_online_status(True)
                session_token = usuario.criar_sessao()
                response.set_cookie('session_token', session_token, path='/')
                return json.dumps({'success': True, 'message': 'Login realizado com sucesso!'})
            else:
                response.status = 401
                return json.dumps({'error': 'Credenciais inv√°lidas'})

        except Exception as e:
            response.status = 500
            return json.dumps({'error': str(e)})

    def logout_post(self):
        usuario = self.get_usuario_autenticado()
        if usuario:
            session_token = request.get_cookie('session_token')
            if session_token:
                usuario.invalidar_sessao(session_token)
            usuario.atualizar_online_status(False)
        
        response.delete_cookie('session_token')
        return json.dumps({'success': True, 'message': 'Logout realizado'})

    def send_friend_request(self):
        """Enviar pedido de amizade para outro usu√°rio"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            target_username = data.get('username', '').strip()

            if not target_username:
                response.status = 400
                return json.dumps({'error': 'Nome de usu√°rio √© obrigat√≥rio'})

            if target_username == usuario.username:
                response.status = 400
                return json.dumps({'error': 'Voc√™ n√£o pode adicionar a si mesmo'})

            # Buscar usu√°rio alvo
            target_user = Usuario.buscar_por_username(target_username)
            if not target_user:
                response.status = 404
                return json.dumps({'error': 'Usu√°rio n√£o encontrado'})

            db = Database()  # ‚Üê AGORA EST√Å DEFINIDO!
            with db.get_cursor() as cur:
                # Verificar se j√° existe pedido pendente
                cur.execute('''
                    SELECT id FROM pedidos_amizade 
                    WHERE de_usuario_id = %s AND para_usuario_id = %s AND status = 'pending'
                ''', (usuario.id, target_user.id))
                
                if cur.fetchone():
                    response.status = 400
                    return json.dumps({'error': 'Pedido de amizade j√° enviado para este usu√°rio'})

                # Verificar se j√° s√£o amigos
                cur.execute('''
                    SELECT id FROM amizades 
                    WHERE (usuario_id1 = %s AND usuario_id2 = %s) 
                    OR (usuario_id1 = %s AND usuario_id2 = %s)
                ''', (usuario.id, target_user.id, target_user.id, usuario.id))
                
                if cur.fetchone():
                    response.status = 400
                    return json.dumps({'error': 'Voc√™s j√° s√£o amigos'})

                # Inserir pedido de amizade
                cur.execute('''
                    INSERT INTO pedidos_amizade (de_usuario_id, para_usuario_id, status)
                    VALUES (%s, %s, 'pending')
                    RETURNING id
                ''', (usuario.id, target_user.id))

            return json.dumps({
                'success': True, 
                'message': f'Pedido de amizade enviado para {target_username}'
            })

        except Exception as e:
            print(f"‚ùå Erro ao enviar pedido de amizade: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def get_friends(self):
        """Obter lista de amigos do usu√°rio"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            print(f"üîç [BACKEND] Buscando amigos para: {usuario.username} (ID: {usuario.id})")
            
            db = Database()
            with db.get_cursor() as cur:
                # Buscar amigos do usu√°rio
                cur.execute('''
                    SELECT u.id, u.username, u.is_online
                    FROM usuarios u
                    INNER JOIN amizades a ON (
                        (a.usuario_id1 = %s AND a.usuario_id2 = u.id) OR 
                        (a.usuario_id1 = u.id AND a.usuario_id2 = %s)
                    )
                    WHERE u.id != %s
                    ORDER BY u.is_online DESC, u.username
                ''', (usuario.id, usuario.id, usuario.id))
                
                friends = []
                rows = cur.fetchall()
                print(f"üìä [BACKEND] Amigos encontrados no banco: {len(rows)}")
                
                for row in rows:
                    # ‚úÖ GARANTIR que todos os campos necess√°rios existem
                    friend_data = {
                        'id': row['id'],
                        'username': row['username'] or 'Usu√°rio Desconhecido',  # Fallback se for NULL
                        'online': bool(row['is_online'])  # Garantir que √© booleano
                    }
                    print(f"üë• [BACKEND] Amigo: {friend_data['username']} (ID: {friend_data['id']}, Online: {friend_data['online']})")
                    friends.append(friend_data)
                
                print(f"‚úÖ [BACKEND] Retornando {len(friends)} amigos")
                
                # ‚úÖ SEMPRE retornar no formato correto
                return json.dumps({
                    'friends': friends  # Garantir que √© um array, mesmo que vazio
                })

        except Exception as e:
            print(f"‚ùå [BACKEND] Erro ao buscar amigos: {e}")
            import traceback
            traceback.print_exc()
            # ‚úÖ Retornar array vazio em caso de erro, n√£o undefined
            return json.dumps({'friends': []})

    def get_friend_requests(self):
        """Obter pedidos de amizade pendentes"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            db = Database()
            with db.get_cursor() as cur:
                # Buscar pedidos pendentes para o usu√°rio
                cur.execute('''
                    SELECT p.id, u.username, p.created_at
                    FROM pedidos_amizade p
                    JOIN usuarios u ON p.de_usuario_id = u.id
                    WHERE p.para_usuario_id = %s AND p.status = 'pending'
                    ORDER BY p.created_at DESC
                ''', (usuario.id,))
                
                requests = []
                for row in cur.fetchall():
                    # Calcular tempo relativo
                    time_ago = self._get_time_ago(row['created_at'])
                    requests.append({
                        'id': row['id'],
                        'from_username': row['username'],
                        'time': time_ago
                    })
                
                return json.dumps({'requests': requests})

        except Exception as e:
            print(f"‚ùå Erro ao buscar pedidos de amizade: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def accept_friend_request(self):
        """Aceitar um pedido de amizade"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            request_id = data.get('request_id')

            db = Database()
            with db.get_cursor() as cur:
                # Buscar pedido
                cur.execute('''
                    SELECT p.*, u.username as from_username 
                    FROM pedidos_amizade p
                    JOIN usuarios u ON p.de_usuario_id = u.id
                    WHERE p.id = %s AND p.para_usuario_id = %s AND p.status = 'pending'
                ''', (request_id, usuario.id))
                
                pedido = cur.fetchone()
                if not pedido:
                    response.status = 404
                    return json.dumps({'error': 'Pedido n√£o encontrado'})

                # ‚úÖ AGORA COM updated_at (que voc√™ adicionou)
                cur.execute('''
                    UPDATE pedidos_amizade 
                    SET status = 'accepted', updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                ''', (request_id,))

                # Criar amizade (em ambas as dire√ß√µes)
                cur.execute('''
                    INSERT INTO amizades (usuario_id1, usuario_id2)
                    VALUES (%s, %s)
                ''', (pedido['de_usuario_id'], pedido['para_usuario_id']))

            return json.dumps({
                'success': True,
                'message': f'Voc√™ e {pedido["from_username"]} agora s√£o amigos!'
            })

        except Exception as e:
            print(f"‚ùå Erro ao aceitar pedido de amizade: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def reject_friend_request(self):
        """Rejeitar um pedido de amizade"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            request_id = data.get('request_id')

            db = Database()
            with db.get_cursor() as cur:
                # Buscar pedido
                cur.execute('''
                    SELECT p.*, u.username as from_username 
                    FROM pedidos_amizade p
                    JOIN usuarios u ON p.de_usuario_id = u.id
                    WHERE p.id = %s AND p.para_usuario_id = %s AND p.status = 'pending'
                ''', (request_id, usuario.id))
                
                pedido = cur.fetchone()
                if not pedido:
                    response.status = 404
                    return json.dumps({'error': 'Pedido n√£o encontrado'})

                # ‚úÖ AGORA COM updated_at (que voc√™ adicionou)
                cur.execute('''
                    UPDATE pedidos_amizade 
                    SET status = 'rejected', updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                ''', (request_id,))

            return json.dumps({
                'success': True,
                'message': f'Pedido de amizade de {pedido["from_username"]} rejeitado'
            })

        except Exception as e:
            print(f"‚ùå Erro ao rejeitar pedido de amizade: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def remove_friend(self):
        """Remover um amigo da lista"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            friend_id = data.get('friend_id')
            friend_username = data.get('friend_username')

            print(f"üóëÔ∏è [BACKEND] Removendo amigo: ID {friend_id}, Username {friend_username}")
            print(f"üë§ [BACKEND] Usu√°rio autenticado: {usuario.username} (ID: {usuario.id})")

            if not friend_id:
                response.status = 400
                return json.dumps({'error': 'ID do amigo √© obrigat√≥rio'})

            db = Database()
            with db.get_cursor() as cur:
                # ‚úÖ Verificar se a amizade existe
                cur.execute('''
                    SELECT id FROM amizades 
                    WHERE (usuario_id1 = %s AND usuario_id2 = %s) 
                    OR (usuario_id1 = %s AND usuario_id2 = %s)
                ''', (usuario.id, friend_id, friend_id, usuario.id))
                
                amizade = cur.fetchone()
                print(f"üîç [BACKEND] Amizade encontrada: {amizade}")

                if not amizade:
                    response.status = 404
                    return json.dumps({'error': 'Amizade n√£o encontrada'})

                # ‚úÖ Remover amizade
                cur.execute('''
                    DELETE FROM amizades 
                    WHERE (usuario_id1 = %s AND usuario_id2 = %s) 
                    OR (usuario_id1 = %s AND usuario_id2 = %s)
                ''', (usuario.id, friend_id, friend_id, usuario.id))
                
                linhas_afetadas = cur.rowcount
                print(f"‚úÖ [BACKEND] Amizade removida. Linhas afetadas: {linhas_afetadas}")

                # ‚úÖ Tamb√©m remover qualquer pedido relacionado
                cur.execute('''
                    DELETE FROM pedidos_amizade 
                    WHERE ((de_usuario_id = %s AND para_usuario_id = %s) 
                    OR (de_usuario_id = %s AND para_usuario_id = %s))
                ''', (usuario.id, friend_id, friend_id, usuario.id))

            return json.dumps({
                'success': True,
                'message': f'{friend_username} foi removido da sua lista de amigos'
            })

        except Exception as e:
            print(f"‚ùå [BACKEND] Erro ao remover amigo: {e}")
            import traceback
            traceback.print_exc()
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def search_users(self):
        """Buscar usu√°rios pelo nome"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            query = request.query.get('q', '').strip()
            
            if len(query) < 2:
                return json.dumps({'users': []})

            db = Database()
            with db.get_cursor() as cur:
                # Buscar usu√°rios que correspondem √† query
                cur.execute('''
                    SELECT id, username, is_online 
                    FROM usuarios 
                    WHERE username ILIKE %s AND id != %s
                    ORDER BY is_online DESC, username
                    LIMIT 10
                ''', (f'%{query}%', usuario.id))
                
                users = []
                for row in cur.fetchall():
                    users.append({
                        'username': row['username'],
                        'online': row['is_online']
                    })
                
                return json.dumps({'users': users})

        except Exception as e:
            print(f"‚ùå Erro na busca de usu√°rios: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def _get_time_ago(self, dt):
        """Fun√ß√£o auxiliar para calcular tempo relativo"""
        from datetime import datetime, timezone
        
        if isinstance(dt, str):
            # Se for string, converter para datetime
            dt = datetime.fromisoformat(dt.replace('Z', '+00:00'))
        
        now = datetime.now(timezone.utc)
        if dt.tzinfo is None:
            dt = dt.replace(tzinfo=timezone.utc)
        
        diff = now - dt
        minutes = diff.total_seconds() / 60
        
        if minutes < 1:
            return "Agora"
        elif minutes < 60:
            return f"{int(minutes)} min atr√°s"
        elif minutes < 1440:
            hours = int(minutes / 60)
            return f"{hours} h atr√°s"
        else:
            days = int(minutes / 1440)
            return f"{days} dias atr√°s"
    
    # Rotas protegidas
    def home_get(self):
        usuario = self.get_usuario_autenticado()
        if not usuario:
            return redirect('/portal')
        return self.render('home', usuario=usuario)

    def send_message(self):
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            content = data.get('content', '').strip()
            message_type = data.get('type', 'texto')
            image_data = data.get('image_data')
            audio_data = data.get('audio_data')
            audio_duration = data.get('audio_duration')
            chat_id = data.get('chat_id', 'general')
            chat_type = data.get('chat_type', 'group')
            conversa_id = data.get('conversa_id')  # ‚úÖ NOVO: Receber conversa_id

            print(f"üì® [SEND_MESSAGE] Enviando mensagem: usuario_id={usuario.id}, chat_id={chat_id}, conversa_id={conversa_id}")

            # ‚úÖ PROCESSAR MENSAGEM (c√≥digo existente)
            kwargs = {
                'chat_id': chat_id,
                'chat_type': chat_type,
                'participants': data.get('participants', [])
            }

            if conversa_id:
                kwargs['conversa_id'] = conversa_id

            if message_type == 'imagem':
                if not image_data:
                    response.status = 400
                    return json.dumps({'error': 'image_data √© obrigat√≥rio para imagem'})
                
                kwargs['image_data'] = image_data
                msg = self.chat.adicionar_mensagem(usuario.id, content, 'imagem', **kwargs)
                
            elif message_type == 'audio':
                if not audio_data:
                    response.status = 400
                    return json.dumps({'error': 'audio_data √© obrigat√≥rio para √°udio'})
                
                kwargs['audio_data'] = audio_data
                kwargs['audio_duration'] = audio_duration
                msg = self.chat.adicionar_mensagem(usuario.id, content, 'audio', **kwargs)
                
            else:
                if not content:
                    response.status = 400
                    return json.dumps({'error': 'Conte√∫do √© obrigat√≥rio'})
                msg = self.chat.adicionar_mensagem(usuario.id, content, 'texto', **kwargs)

            if msg:
                # ‚úÖ ATUALIZAR √öLTIMA MENSAGEM NA CONVERSA
                self._atualizar_ultima_mensagem_conversa(msg, conversa_id)
                
                usuario.atualizar_online_status(True)
                return json.dumps(msg.to_dict())
            else:
                response.status = 400
                return json.dumps({'error': 'Falha ao criar mensagem'})
                
        except Exception as e:
            response.status = 500
            return json.dumps({'error': str(e)})

    def _atualizar_ultima_mensagem_conversa(self, mensagem, conversa_id):
        """Atualiza a √∫ltima mensagem da conversa - VERS√ÉO CORRIGIDA"""
        if not conversa_id:
            print("‚ö†Ô∏è [ULTIMA_MENSAGEM] conversa_id n√£o fornecido - pulando atualiza√ß√£o")
            return
            
        try:
            print(f"üîÑ [ULTIMA_MENSAGEM] Atualizando conversa {conversa_id} com nova mensagem")
            
            from app.models.conversa import Conversa
            conversa = Conversa.buscar_por_id(conversa_id)
            
            if conversa:
                # Criar preview da mensagem
                preview = self._criar_preview_mensagem(mensagem)
                
                # Atualizar no banco
                conversa.atualizar_ultima_mensagem(preview)
                print(f"‚úÖ [ULTIMA_MENSAGEM] Conversa {conversa_id} atualizada: '{preview}'")
            else:
                print(f"‚ùå [ULTIMA_MENSAGEM] Conversa {conversa_id} n√£o encontrada")
                
        except Exception as e:
            print(f"‚ùå [ULTIMA_MENSAGEM] Erro ao atualizar conversa {conversa_id}: {e}")
            import traceback
            traceback.print_exc()

    def _criar_preview_mensagem(self, mensagem):
        """Cria um preview resumido da mensagem"""
        if mensagem.tipo == 'imagem':
            return 'üì∑ Imagem'
        elif mensagem.tipo == 'audio':
            return 'üé§ √Åudio'
        else:
            # Texto - limitar a 30 caracteres
            conteudo = mensagem.conteudo or ''
            if len(conteudo) > 30:
                return conteudo[:30] + '...'
            return conteudo

    def get_messages(self):
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        usuario.atualizar_online_status(True)
        
        since = request.query.get('since', '').strip()
        chat_id = request.query.get('chat', 'general')
        chat_type = request.query.get('type', 'group')
        conversa_id = request.query.get('conversa_id')  # ‚úÖ NOVO PAR√ÇMETRO
        
        # ‚úÖ USAR O NOVO M√âTODO UNIFICADO
        data = self.chat.get_data_desde(since, chat_id, conversa_id)
        return json.dumps(data)

    def edit_message(self):
        """UPDATE - Editar uma mensagem existente"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            message_id = data.get('message_id')
            new_content = data.get('content', '').strip()

            if not message_id or not new_content:
                response.status = 400
                return json.dumps({'error': 'ID e conte√∫do s√£o obrigat√≥rios'})

            db = Database()
            with db.get_cursor() as cur:
                # Verificar se a mensagem pertence ao usu√°rio
                cur.execute('''
                    SELECT id, usuario_id, tipo FROM mensagens 
                    WHERE id = %s AND usuario_id = %s
                ''', (message_id, usuario.id))
                
                mensagem = cur.fetchone()
                if not mensagem:
                    response.status = 403
                    return json.dumps({'error': 'Voc√™ s√≥ pode editar suas pr√≥prias mensagens'})

                # N√£o permitir editar mensagens de m√≠dia
                if mensagem['tipo'] != 'texto':
                    response.status = 400
                    return json.dumps({'error': 'S√≥ √© poss√≠vel editar mensagens de texto'})

                # UPDATE da mensagem
                cur.execute('''
                    UPDATE mensagens 
                    SET conteudo = %s, edited_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                    RETURNING id, conteudo, created_at, edited_at
                ''', (new_content, message_id))
                
                updated_msg = cur.fetchone()
                
                return json.dumps({
                    'success': True,
                    'message': 'Mensagem editada com sucesso',
                    'data': {
                        'id': updated_msg['id'],
                        'conteudo': updated_msg['conteudo'],
                        'edited_at': updated_msg['edited_at'].isoformat() if updated_msg['edited_at'] else None
                    }
                })

        except Exception as e:
            response.status = 500
            return json.dumps({'error': f'Erro ao editar mensagem: {str(e)}'})

    def delete_message(self):
        """DELETE - Excluir uma mensagem"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            message_id = data.get('message_id')

            if not message_id:
                response.status = 400
                return json.dumps({'error': 'ID da mensagem √© obrigat√≥rio'})

            db = Database()
            with db.get_cursor() as cur:
                # Verificar se a mensagem pertence ao usu√°rio
                cur.execute('''
                    SELECT usuario_id FROM mensagens 
                    WHERE id = %s AND usuario_id = %s
                ''', (message_id, usuario.id))
                
                if not cur.fetchone():
                    response.status = 403
                    return json.dumps({'error': 'Voc√™ s√≥ pode excluir suas pr√≥prias mensagens'})

                # DELETE da mensagem
                cur.execute('DELETE FROM mensagens WHERE id = %s', (message_id,))
                
                return json.dumps({
                    'success': True,
                    'message': 'Mensagem exclu√≠da com sucesso'
                })

        except Exception as e:
            response.status = 500
            return json.dumps({'error': f'Erro ao excluir mensagem: {str(e)}'})

    def serve_image(self, filename):
        """Serve imagens do diret√≥rio de upload"""
        try:
            safe_filename = filename.split('/')[-1]
            return static_file(safe_filename, root=f"{self.chat.upload_folder}/images")
        except Exception as e:
            response.status = 404
            return f"Imagem n√£o encontrada: {e}"

    def serve_audio(self, filename):
        """Serve √°udios do diret√≥rio de upload"""
        try:
            safe_filename = filename.split('/')[-1]
            return static_file(safe_filename, root=f"{self.chat.upload_folder}/audios")
        except Exception as e:
            response.status = 404
            return f"√Åudio n√£o encontrado: {e}"
        
    def user_info(self):
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})
        
        return json.dumps({
            'username': usuario.username,
            'id': usuario.id
        })
        
    def get_conversas(self):
        """Obter lista de conversas do usu√°rio - VERS√ÉO COM LOGS DETALHADOS"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            print(f"üîç [API CONVERSAS] Buscando conversas para: {usuario.username} (ID: {usuario.id})")
            
            from app.models.conversa import Conversa
            conversas = Conversa.buscar_por_usuario(usuario.id)
            
            print(f"‚úÖ [API CONVERSAS] {len(conversas)} conversas encontradas no modelo")

            conversas_data = []
            for conversa in conversas:
                # Determinar nome de exibi√ß√£o
                if conversa.tipo == 'private':
                    participantes = conversa.obter_participantes()
                    outro_usuario = next((p for p in participantes if p['id'] != usuario.id), None)
                    nome_exibicao = outro_usuario['username'] if outro_usuario else 'Usu√°rio'
                else:
                    nome_exibicao = conversa.nome or 'Grupo sem nome'
                
                conversa_data = {
                    'id': conversa.id,
                    'nome': nome_exibicao,
                    'tipo': conversa.tipo,
                    'ultima_mensagem': conversa.ultima_mensagem,
                    'ultima_mensagem_em': conversa.ultima_mensagem_em.isoformat() if conversa.ultima_mensagem_em else None
                }
                
                print(f"üìã [API CONVERSAS] Adicionando: ID={conversa.id}, Nome='{nome_exibicao}'")
                conversas_data.append(conversa_data)

            print(f"üéØ [API CONVERSAS] Retornando {len(conversas_data)} conversas para o frontend")
            return json.dumps({'conversas': conversas_data})

        except Exception as e:
            print(f"‚ùå [API CONVERSAS] Erro ao buscar conversas: {e}")
            import traceback
            traceback.print_exc()
            return json.dumps({'conversas': []})

    def user_list(self):
        """Retorna lista completa de usu√°rios com IDs - VERS√ÉO CORRIGIDA"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            from app.models.usuario import Usuario
            
            # Buscar todos os usu√°rios (n√£o apenas online)
            db = Database()
            with db.get_cursor() as cur:
                cur.execute('''
                    SELECT id, username, is_online 
                    FROM usuarios 
                    WHERE id != %s
                    ORDER BY is_online DESC, username
                ''', (usuario.id,))
                
                users_data = []
                for row in cur.fetchall():
                    users_data.append({
                        'id': row['id'],
                        'username': row['username'],
                        'online': row['is_online']
                    })
                
                print(f"üìã Retornando {len(users_data)} usu√°rios para a lista")
                return json.dumps({'users': users_data})
                
        except Exception as e:
            print(f"‚ùå Erro ao buscar lista de usu√°rios: {e}")
            return json.dumps({'users': []})
        
    def delete_account(self):
        """DELETE - Excluir permanentemente a conta do usu√°rio"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            confirmation = data.get('confirmation', '').strip()
            
            # Verifica√ß√£o extra de seguran√ßa
            if confirmation != 'CONFIRMAR EXCLUS√ÉO':
                response.status = 400
                return json.dumps({'error': 'Confirma√ß√£o incorreta. Digite exatamente: CONFIRMAR EXCLUS√ÉO'})

            db = Database()
            with db.get_cursor() as cur:
                print(f"üóëÔ∏è Iniciando exclus√£o da conta do usu√°rio: {usuario.username} (ID: {usuario.id})")
                
                # 1. Primeiro, excluir todas as mensagens do usu√°rio
                cur.execute('DELETE FROM mensagens WHERE usuario_id = %s', (usuario.id,))
                mensagens_excluidas = cur.rowcount
                print(f"‚úÖ Mensagens exclu√≠das: {mensagens_excluidas}")
                
                # 2. Excluir sess√µes do usu√°rio
                cur.execute('DELETE FROM sessoes WHERE usuario_id = %s', (usuario.id,))
                sessoes_excluidas = cur.rowcount
                print(f"‚úÖ Sess√µes exclu√≠das: {sessoes_excluidas}")
                
                # 3. Excluir pedidos de amizade relacionados
                cur.execute('''
                    DELETE FROM pedidos_amizade 
                    WHERE de_usuario_id = %s OR para_usuario_id = %s
                ''', (usuario.id, usuario.id))
                pedidos_excluidos = cur.rowcount
                print(f"‚úÖ Pedidos de amizade exclu√≠dos: {pedidos_excluidos}")
                
                # 4. Excluir amizades
                cur.execute('''
                    DELETE FROM amizades 
                    WHERE usuario_id1 = %s OR usuario_id2 = %s
                ''', (usuario.id, usuario.id))
                amizades_excluidas = cur.rowcount
                print(f"‚úÖ Amizades exclu√≠das: {amizades_excluidas}")
                
                # 5. Excluir participa√ß√£o em conversas
                cur.execute('DELETE FROM participantes_conversa WHERE usuario_id = %s', (usuario.id,))
                participantes_excluidos = cur.rowcount
                print(f"‚úÖ Participa√ß√µes em conversas exclu√≠das: {participantes_excluidos}")
                
                # 6. Excluir conversas criadas pelo usu√°rio (se for o criador)
                cur.execute('''
                    DELETE FROM conversas 
                    WHERE criado_por = %s AND tipo = 'group'
                ''', (usuario.id,))
                conversas_excluidas = cur.rowcount
                print(f"‚úÖ Conversas/grupos exclu√≠dos: {conversas_excluidas}")
                
                # 7. FINALMENTE: Excluir o usu√°rio
                cur.execute('DELETE FROM usuarios WHERE id = %s', (usuario.id,))
                usuario_excluido = cur.rowcount
                
                if usuario_excluido == 1:
                    print(f"üéâ Conta do usu√°rio {usuario.username} exclu√≠da com sucesso!")
                    
                    # Limpar cookie de sess√£o
                    response.delete_cookie('session_token')
                    
                    return json.dumps({
                        'success': True,
                        'message': 'Sua conta foi exclu√≠da permanentemente. Todos os seus dados foram removidos do sistema.',
                        'stats': {
                            'mensagens': mensagens_excluidas,
                            'sessoes': sessoes_excluidas,
                            'pedidos_amizade': pedidos_excluidos,
                            'amizades': amizades_excluidas,
                            'conversas': conversas_excluidas
                        }
                    })
                else:
                    response.status = 500
                    return json.dumps({'error': 'Erro ao excluir conta do usu√°rio'})

        except Exception as e:
            print(f"‚ùå Erro cr√≠tico ao excluir conta: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno ao excluir conta: {str(e)}'})
      
    def criar_grupo(self):
        """Criar um novo grupo - VERS√ÉO CORRIGIDA COM TRATAMENTO DE ERRO"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            # ‚úÖ VERIFICAR SE request.json √â NONE
            if request.json is None:
                print("‚ùå [CRIAR-GRUPO] request.json √© None - corpo da requisi√ß√£o vazio ou inv√°lido")
                
                # Tentar ler o corpo manualmente
                try:
                    body = request.body.read().decode('utf-8')
                    print(f"üì® [CRIAR-GRUPO] Corpo bruto: {body}")
                    if body:
                        data = json.loads(body)
                    else:
                        response.status = 400
                        return json.dumps({'error': 'Corpo da requisi√ß√£o vazio'})
                except Exception as e:
                    print(f"‚ùå [CRIAR-GRUPO] Erro ao parsear corpo: {e}")
                    response.status = 400
                    return json.dumps({'error': 'Formato JSON inv√°lido'})
            else:
                data = request.json

            print(f"üì¶ [CRIAR-GRUPO] Dados recebidos: {data}")

            nome_grupo = data.get('nome', '').strip()
            participantes = data.get('participantes', [])  # Lista de IDs

            print(f"üéØ [CRIAR-GRUPO] Processando: nome='{nome_grupo}', participantes={participantes}")

            if not nome_grupo:
                response.status = 400
                return json.dumps({'error': 'Nome do grupo √© obrigat√≥rio'})

            if not participantes or not isinstance(participantes, list):
                response.status = 400
                return json.dumps({'error': 'Selecione pelo menos um participante'})

            # Converter para inteiros
            participantes_ids = []
            for p in participantes:
                try:
                    participantes_ids.append(int(p))
                except (ValueError, TypeError):
                    print(f"‚ö†Ô∏è [CRIAR-GRUPO] ID de participante inv√°lido ignorado: {p}")

            print(f"üî¢ [CRIAR-GRUPO] IDs convertidos: {participantes_ids}")

            if not participantes_ids:
                response.status = 400
                return json.dumps({'error': 'Nenhum participante v√°lido selecionado'})

            from app.models.conversa import Conversa
            conversa = Conversa.criar_grupo(nome_grupo, usuario.id, participantes_ids)

            if conversa:
                print(f"‚úÖ [CRIAR-GRUPO] Grupo criado com sucesso: {conversa.id}")
                return json.dumps({
                    'success': True,
                    'conversa': {
                        'id': conversa.id,
                        'nome': conversa.nome,
                        'tipo': conversa.tipo
                    },
                    'message': f'Grupo "{nome_grupo}" criado com sucesso!'
                })
            else:
                print("‚ùå [CRIAR-GRUPO] Falha ao criar grupo no modelo")
                response.status = 500
                return json.dumps({'error': 'Falha ao criar grupo'})

        except Exception as e:
            print(f"üí• [CRIAR-GRUPO] Erro inesperado: {e}")
            import traceback
            traceback.print_exc()
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})

    def debug_request(self):
        """M√©todo tempor√°rio para debug da requisi√ß√£o"""
        print("üîç [DEBUG] Headers da requisi√ß√£o:")
        for key, value in request.headers.items():
            print(f"   {key}: {value}")
        
        print("üîç [DEBUG] request.json:", request.json)
        
        try:
            body = request.body.read().decode('utf-8')
            print("üîç [DEBUG] Corpo bruto:", body)
            request.body.seek(0)  # Reset para poder ler novamente
        except Exception as e:
            print("üîç [DEBUG] Erro ao ler corpo:", e)
        
        return json.dumps({'debug': 'ok'})

    def abrir_conversa(self):
        """Abrir uma conversa espec√≠fica"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            conversa_id = request.query.get('id')
            if not conversa_id:
                response.status = 400
                return json.dumps({'error': 'ID da conversa √© obrigat√≥rio'})

            conversa = Conversa.buscar_por_id(conversa_id)
            if not conversa:
                response.status = 404
                return json.dumps({'error': 'Conversa n√£o encontrada'})

            # Buscar participantes
            participantes = conversa.obter_participantes()
            
            # Determinar nome de exibi√ß√£o
            if conversa.tipo == 'private':
                outro_usuario = next((p for p in participantes if p['id'] != usuario.id), None)
                nome_exibicao = outro_usuario['username'] if outro_usuario else 'Usu√°rio'
            else:
                nome_exibicao = conversa.nome or 'Grupo'

            return json.dumps({
                'id': conversa.id,
                'nome': nome_exibicao,
                'tipo': conversa.tipo,
                'participantes': participantes
            })

        except Exception as e:
            print(f"‚ùå Erro ao abrir conversa: {e}")
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})
        
    def excluir_grupo(self):
        """Excluir um grupo permanentemente"""
        usuario = self.get_usuario_autenticado()
        if not usuario:
            response.status = 401
            return json.dumps({'error': 'N√£o autenticado'})

        try:
            data = request.json
            grupo_id = data.get('grupo_id')
            
            print(f"üóëÔ∏è [EXCLUIR-GRUPO] Iniciando exclus√£o do grupo: {grupo_id}")
            print(f"üë§ [EXCLUIR-GRUPO] Usu√°rio solicitante: {usuario.username} (ID: {usuario.id})")

            if not grupo_id:
                response.status = 400
                return json.dumps({'error': 'ID do grupo √© obrigat√≥rio'})

            # Buscar informa√ß√µes do grupo
            from app.models.conversa import Conversa
            conversa = Conversa.buscar_por_id(grupo_id)
            
            if not conversa:
                response.status = 404
                return json.dumps({'error': 'Grupo n√£o encontrado'})

            # Verificar se o grupo √© realmente um grupo
            if conversa.tipo != 'group':
                response.status = 400
                return json.dumps({'error': 'Esta conversa n√£o √© um grupo'})

            # Verificar se o usu√°rio √© o criador do grupo
            if conversa.criado_por != usuario.id:
                response.status = 403
                return json.dumps({'error': 'Apenas o criador do grupo pode exclu√≠-lo'})

            # Excluir o grupo
            resultado = Conversa.excluir_grupo(grupo_id, usuario.id)
            
            if resultado:
                print(f"‚úÖ [EXCLUIR-GRUPO] Grupo {grupo_id} exclu√≠do com sucesso")
                return json.dumps({
                    'success': True,
                    'message': f'Grupo "{conversa.nome}" foi exclu√≠do permanentemente'
                })
            else:
                response.status = 500
                return json.dumps({'error': 'Erro ao excluir grupo'})

        except Exception as e:
            print(f"üí• [EXCLUIR-GRUPO] Erro inesperado: {e}")
            import traceback
            traceback.print_exc()
            response.status = 500
            return json.dumps({'error': f'Erro interno: {str(e)}'})


Chat_Online/app/models/:

__init__.py:

# Chat_Online/app/models/__init__.py
from .usuario import Usuario
from .mensagem import Mensagem
from .chat import Chat

chat.py:

# app/models/chat.py - VERS√ÉO CORRIGIDA
from datetime import datetime, timezone
import os
import base64
from app.models.mensagem import Mensagem
from app.models.conversa import Conversa
from app.models.database import Database  # ‚úÖ ADICIONAR IMPORT

class Chat:
    def __init__(self):
        self.upload_folder = "app/static/uploads"
        os.makedirs(f"{self.upload_folder}/images", exist_ok=True)
        os.makedirs(f"{self.upload_folder}/audios", exist_ok=True)

    def adicionar_mensagem(self, usuario_id, conteudo, tipo='texto', **kwargs):
        """Processa e cria mensagens"""
        try:
            # ‚úÖ CORRE√á√ÉO: USAR PAR√ÇMETROS DIRETAMENTE, N√ÉO kwargs
            chat_id = kwargs.get('chat_id', 'general')
            chat_type = kwargs.get('chat_type', 'group')
            participants = kwargs.get('participants', [])
            
            # Determinar conversa_id
            conversa_id = self._obter_conversa_id(chat_id, chat_type, usuario_id, participants)
            
            # ‚úÖ CRIAR DICT LIMPO COM APENAS OS PAR√ÇMETROS NECESS√ÅRIOS
            message_data = {
                'chat_id': chat_id,
                'chat_type': chat_type,
                'conversa_id': conversa_id
            }
            
            # Adicionar par√¢metros espec√≠ficos por tipo
            if tipo == 'imagem':
                image_data = kwargs.get('image_data')
                if not image_data:
                    return None
                    
                message_data['image_filename'] = self._processar_imagem_upload(usuario_id, image_data, conteudo)
                
            elif tipo == 'audio':
                audio_data = kwargs.get('audio_data')
                if not audio_data:
                    return None
                    
                message_data['audio_filename'] = self._processar_audio_upload(usuario_id, audio_data)
                message_data['audio_duration'] = kwargs.get('audio_duration')
            
            # Criar mensagem
            return Mensagem.criar(conteudo, usuario_id, tipo, **message_data)
                
        except Exception as e:
            print(f"‚ùå Erro em adicionar_mensagem: {e}")
            return None

    def _obter_conversa_id(self, chat_id, chat_type, usuario_id, participantes):
        """Obt√©m ID da conversa - CORRE√á√ÉO: PAR√ÇMETROS EXPL√çCITOS"""
        try:
            if not chat_id or not chat_type:
                return None
                
            # ‚úÖ CORRE√á√ÉO: USAR PAR√ÇMETROS DIRETAMENTE
            print(f"üîç Buscando conversa_id: chat_id={chat_id}, chat_type={chat_type}, usuario_id={usuario_id}")
            
            if chat_type == 'private':
                # Para chats privados: private-user1-user2
                if chat_id.startswith('private-'):
                    partes = chat_id.replace('private-', '').split('-')
                    if len(partes) == 2:
                        from app.models.usuario import Usuario
                        
                        usuario1 = Usuario.buscar_por_username(partes[0])
                        usuario2 = Usuario.buscar_por_username(partes[1])
                        
                        if usuario1 and usuario2:
                            conversa = Conversa.buscar_ou_criar_privada(usuario1.id, usuario2.id)
                            return conversa.id if conversa else None
            
            elif chat_type == 'group':
                if chat_id == 'general':
                    return None  # Chat geral n√£o tem conversa_id
                else:
                    # Para grupos: o chat_id j√° √© o ID da conversa
                    try:
                        return int(chat_id)
                    except ValueError:
                        print(f"‚ö†Ô∏è chat_id n√£o √© um ID v√°lido: {chat_id}")
                        return None
            
            return None
        except Exception as e:
            print(f"‚ùå Erro ao obter conversa_id: {e}")
            return None

    def _processar_imagem_upload(self, usuario_id, image_data, conteudo):
        """Processa upload de imagem e retorna filename"""
        try:
            if ',' in image_data:
                format_info, image_data = image_data.split(',', 1)
            
            image_bytes = base64.b64decode(image_data)
            
            file_extension = self._get_image_extension(conteudo)
            filename = f"{datetime.now(timezone.utc).strftime('%Y%m%d_%H%M%S')}_{usuario_id}{file_extension}"
            filepath = os.path.join(f"{self.upload_folder}/images", filename)
            
            with open(filepath, 'wb') as f:
                f.write(image_bytes)
            
            return filename
            
        except Exception as e:
            print(f"‚ùå Erro ao processar imagem: {e}")
            raise

    def _processar_audio_upload(self, usuario_id, audio_data):
        """Processa upload de √°udio e retorna filename"""
        try:
            if ',' in audio_data:
                format_info, audio_data = audio_data.split(',', 1)
            
            audio_bytes = base64.b64decode(audio_data)
            
            filename = f"{datetime.now(timezone.utc).strftime('%Y%m%d_%H%M%S')}_{usuario_id}.wav"
            filepath = os.path.join(f"{self.upload_folder}/audios", filename)
            
            with open(filepath, 'wb') as f:
                f.write(audio_bytes)
            
            return filename
            
        except Exception as e:
            print(f"‚ùå Erro ao processar √°udio: {e}")
            raise

    def _get_image_extension(self, conteudo):
        if 'jpeg' in conteudo.lower() or 'jpg' in conteudo.lower():
            return '.jpg'
        elif 'png' in conteudo.lower():
            return '.png'
        elif 'gif' in conteudo.lower():
            return '.gif'
        elif 'webp' in conteudo.lower():
            return '.webp'
        else:
            return '.jpg'

    def get_data_desde(self, since_str: str, chat_id=None, conversa_id=None):
        """M√©todo unificado para buscar mensagens"""
        since = None
        if since_str:
            try:
                since = datetime.fromisoformat(since_str.replace('Z', '+00:00'))
            except ValueError:
                since = None
        
        # ‚úÖ PRIORIDADE PARA CONVERSAS
        if conversa_id:
            mensagens = Mensagem.buscar_por_conversa(conversa_id, since)
        else:
            mensagens = Mensagem.buscar_por_chat(chat_id or 'general', since)
        
        from app.models.usuario import Usuario
        usuarios_online = [user.username for user in Usuario.listar_online()]
        
        return {
            'messages': [m.to_dict() for m in mensagens],
            'online': usuarios_online
        }

conversa.py:

# app/models/conversa.py - VERS√ÉO CORRIGIDA
from app.models.database import Database
from datetime import datetime

class Conversa:
    def __init__(self, id, nome, tipo, criado_por=None, criado_em=None, 
                 ultima_mensagem=None, ultima_mensagem_em=None):
        self.id = id
        self.nome = nome
        self.tipo = tipo
        self.criado_por = criado_por
        self.criado_em = criado_em
        self.ultima_mensagem = ultima_mensagem
        self.ultima_mensagem_em = ultima_mensagem_em

    @classmethod
    def criar_grupo(cls, nome, criado_por_id, participantes_ids):
        """Cria um grupo e adiciona TODOS os participantes - VERS√ÉO 100% FUNCIONAL"""
        db = Database()
        with db.get_cursor() as cur:
            try:
                print(f"üë• [GRUPO] Iniciando cria√ß√£o do grupo: '{nome}'")
                print(f"üë§ [GRUPO] Criado por: {criado_por_id}")
                print(f"üë• [GRUPO] Participantes recebidos: {participantes_ids}")
                
                # ‚úÖ 1. CRIAR A CONVERSA
                cur.execute('''
                    INSERT INTO conversas (nome, tipo, criado_por)
                    VALUES (%s, 'group', %s)
                    RETURNING id, nome, tipo, criado_por, criado_em
                ''', (nome, criado_por_id))
                
                result = cur.fetchone()
                if not result:
                    print("‚ùå [GRUPO] Falha ao criar conversa no banco")
                    return None
                    
                conversa_id = result['id']
                print(f"‚úÖ [GRUPO] Conversa criada: ID={conversa_id}")
                
                # ‚úÖ 2. ADICIONAR TODOS OS PARTICIPANTES (INCLUINDO O CRIADOR!)
                todos_participantes = [criado_por_id] + participantes_ids
                print(f"üë• [GRUPO] Adicionando {len(todos_participantes)} participantes: {todos_participantes}")
                
                participantes_adicionados = 0
                for usuario_id in todos_participantes:
                    try:
                        # ‚úÖ VERIFICAR SE O USU√ÅRIO EXISTE
                        cur.execute('SELECT id FROM usuarios WHERE id = %s', (usuario_id,))
                        usuario_existe = cur.fetchone()
                        
                        if usuario_existe:
                            cur.execute('''
                                INSERT INTO participantes_conversa (conversa_id, usuario_id)
                                VALUES (%s, %s)
                                ON CONFLICT (conversa_id, usuario_id) DO NOTHING
                                RETURNING id
                            ''', (conversa_id, usuario_id))
                            
                            if cur.fetchone():
                                participantes_adicionados += 1
                                print(f"  ‚úÖ [GRUPO] Participante {usuario_id} adicionado com sucesso")
                            else:
                                print(f"  ‚ö†Ô∏è [GRUPO] Participante {usuario_id} j√° estava no grupo")
                        else:
                            print(f"  ‚ùå [GRUPO] Usu√°rio ID {usuario_id} n√£o existe!")
                            
                    except Exception as e:
                        print(f"  üí• [GRUPO] Erro ao adicionar participante {usuario_id}: {e}")
                
                # ‚úÖ 3. VERIFICAR SE OS PARTICIPANTES FORAM REALMENTE ADICIONADOS
                cur.execute('''
                    SELECT COUNT(*) as total, string_agg(usuario_id::text, ', ') as ids
                    FROM participantes_conversa 
                    WHERE conversa_id = %s
                ''', (conversa_id,))
                
                verificacao = cur.fetchone()
                print(f"‚úÖ [GRUPO] VERIFICA√á√ÉO: {verificacao['total']} participantes no grupo: {verificacao['ids']}")
                
                # ‚úÖ 4. RETORNAR CONVERSA COMPLETA
                conversa = cls(
                    conversa_id, 
                    result['nome'], 
                    result['tipo'],
                    result['criado_por'], 
                    result['criado_em']
                )
                
                print(f"üéâ [GRUPO] Grupo '{nome}' criado com sucesso! ID: {conversa_id}, {participantes_adicionados} participantes")
                return conversa
                
            except Exception as e:
                print(f"‚ùå [GRUPO] Erro cr√≠tico ao criar grupo: {e}")
                import traceback
                traceback.print_exc()
                return None

    @classmethod
    def excluir_grupo(cls, conversa_id, usuario_id):
        """Exclui um grupo permanentemente com verifica√ß√µes de seguran√ßa"""
        db = Database()
        with db.get_cursor() as cur:
            try:
                print(f"üóëÔ∏è [MODELO] Iniciando exclus√£o do grupo {conversa_id} pelo usu√°rio {usuario_id}")
                
                # 1. Verificar se o grupo existe e se o usu√°rio √© o criador
                cur.execute('''
                    SELECT id, nome, criado_por, tipo
                    FROM conversas 
                    WHERE id = %s AND tipo = 'group' AND criado_por = %s
                ''', (conversa_id, usuario_id))
                
                grupo = cur.fetchone()
                if not grupo:
                    print(f"‚ùå [MODELO] Grupo n√£o encontrado ou usu√°rio n√£o √© o criador")
                    return False

                print(f"‚úÖ [MODELO] Grupo encontrado: {grupo['nome']} (Tipo: {grupo['tipo']})")

                # 2. Contar quantas mensagens ser√£o exclu√≠das (apenas para log)
                cur.execute('SELECT COUNT(*) as total FROM mensagens WHERE conversa_id = %s', (conversa_id,))
                total_mensagens = cur.fetchone()['total']
                print(f"üìä [MODELO] Total de mensagens no grupo: {total_mensagens}")

                # 3. Contar quantos participantes ser√£o removidos (apenas para log)
                cur.execute('SELECT COUNT(*) as total FROM participantes_conversa WHERE conversa_id = %s', (conversa_id,))
                total_participantes = cur.fetchone()['total']
                print(f"üìä [MODELO] Total de participantes no grupo: {total_participantes}")

                # 4. Excluir todas as mensagens do grupo
                cur.execute('DELETE FROM mensagens WHERE conversa_id = %s', (conversa_id,))
                mensagens_excluidas = cur.rowcount
                print(f"‚úÖ [MODELO] Mensagens exclu√≠das: {mensagens_excluidas}")

                # 5. Excluir todos os participantes do grupo
                cur.execute('DELETE FROM participantes_conversa WHERE conversa_id = %s', (conversa_id,))
                participantes_excluidos = cur.rowcount
                print(f"‚úÖ [MODELO] Participantes removidos: {participantes_excluidos}")

                # 6. Excluir o grupo
                cur.execute('DELETE FROM conversas WHERE id = %s', (conversa_id,))
                grupo_excluido = cur.rowcount
                
                if grupo_excluido == 1:
                    print(f"üéâ [MODELO] Grupo {conversa_id} exclu√≠do com sucesso!")
                    print(f"üìã [MODELO] Resumo: {mensagens_excluidas} mensagens e {participantes_excluidos} participantes removidos")
                    return True
                else:
                    print(f"‚ùå [MODELO] Falha ao excluir grupo")
                    return False

            except Exception as e:
                print(f"üí• [MODELO] Erro ao excluir grupo: {e}")
                raise
    
    @classmethod
    def _adicionar_participante_db(cls, conversa_id, usuario_id):
        """M√©todo auxiliar para adicionar participante"""
        db = Database()
        with db.get_cursor() as cur:
            try:
                cur.execute('''
                    INSERT INTO participantes_conversa (conversa_id, usuario_id)
                    VALUES (%s, %s)
                    ON CONFLICT (conversa_id, usuario_id) DO NOTHING
                    RETURNING id
                ''', (conversa_id, usuario_id))
                
                return cur.fetchone() is not None
            except Exception as e:
                print(f"‚ùå [GRUPO] Erro ao adicionar participante {usuario_id}: {e}")
                return False

    @classmethod
    def criar_privada(cls, usuario1_id, usuario2_id):
        # Ordena os IDs para garantir que a conversa seja √∫nica
        ids_ordenados = sorted([usuario1_id, usuario2_id])
        nome_conversa = f"private_{ids_ordenados[0]}_{ids_ordenados[1]}"
        
        db = Database()
        with db.get_cursor() as cur:
            # Verifica se j√° existe conversa privada
            cur.execute('''
                SELECT c.id, c.nome, c.tipo, c.criado_em
                FROM conversas c
                WHERE c.tipo = 'private' AND c.nome = %s
            ''', (nome_conversa,))
            
            existing = cur.fetchone()
            
            if existing:
                return cls(existing['id'], existing['nome'], existing['tipo'], 
                          None, existing['criado_em'])
            
            # Cria nova conversa privada
            cur.execute('''
                INSERT INTO conversas (nome, tipo)
                VALUES (%s, 'private')
                RETURNING id, criado_em
            ''', (nome_conversa,))
            
            result = cur.fetchone()
            conversa = cls(result['id'], nome_conversa, 'private', None, result['criado_em'])
            
            # Adiciona ambos os usu√°rios como participantes
            conversa.adicionar_participante(usuario1_id)
            conversa.adicionar_participante(usuario2_id)
            
            return conversa

    def adicionar_participante(self, usuario_id):
        """Adiciona um usu√°rio como participante da conversa"""
        db = Database()
        with db.get_cursor() as cur:
            try:
                cur.execute('''
                    INSERT INTO participantes_conversa (conversa_id, usuario_id)
                    VALUES (%s, %s)
                    ON CONFLICT (conversa_id, usuario_id) DO NOTHING
                ''', (self.id, usuario_id))
                return True
            except Exception as e:
                print(f"‚ùå Erro ao adicionar participante {usuario_id}: {e}")
                return False

    @classmethod
    def buscar_por_id(cls, conversa_id):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT id, nome, tipo, criado_por, criado_em, 
                       ultima_mensagem, ultima_mensagem_em
                FROM conversas 
                WHERE id = %s
            ''', (conversa_id,))
            
            result = cur.fetchone()
            if result:
                return cls(
                    result['id'], result['nome'], result['tipo'],
                    result['criado_por'], result['criado_em'],
                    result['ultima_mensagem'], result['ultima_mensagem_em']
                )
        return None

    @classmethod
    def buscar_por_usuario(cls, usuario_id):
        """Busca todas as conversas de um usu√°rio - VERS√ÉO CORRIGIDA COM ORDENA√á√ÉO"""
        db = Database()
        with db.get_cursor() as cur:
            try:
                print(f"üîç [CONVERSA] Buscando conversas para usu√°rio ID: {usuario_id}")
                
                # ‚úÖ QUERY CORRIGIDA - ORDENAR POR ATIVIDADE RECENTE
                cur.execute('''
                    SELECT 
                        c.id, c.nome, c.tipo, c.criado_por, c.criado_em,
                        c.ultima_mensagem, c.ultima_mensagem_em
                    FROM conversas c
                    INNER JOIN participantes_conversa pc ON c.id = pc.conversa_id
                    WHERE pc.usuario_id = %s
                    ORDER BY 
                        COALESCE(c.ultima_mensagem_em, c.criado_em) DESC,
                        c.criado_em DESC
                ''', (usuario_id,))
                
                rows = cur.fetchall()
                print(f"‚úÖ [CONVERSA] Encontradas {len(rows)} conversas no banco para usu√°rio {usuario_id}")
                
                conversas = []
                for row in rows:
                    print(f"üìã [CONVERSA] Conversa: ID={row['id']}, Nome='{row['nome']}', √öltimaMsg='{row['ultima_mensagem']}'")
                    
                    conversa = cls(
                        row['id'], 
                        row['nome'], 
                        row['tipo'],
                        row['criado_por'], 
                        row['criado_em'],
                        row['ultima_mensagem'], 
                        row['ultima_mensagem_em']
                    )
                    conversas.append(conversa)
                
                return conversas
                
            except Exception as e:
                print(f"‚ùå [CONVERSA] Erro ao buscar conversas: {e}")
                import traceback
                traceback.print_exc()
                return []

    def atualizar_ultima_mensagem(self, mensagem_conteudo):
        """Atualiza a √∫ltima mensagem da conversa"""
        db = Database()
        with db.get_cursor() as cur:
            try:
                cur.execute('''
                    UPDATE conversas 
                    SET ultima_mensagem = %s, ultima_mensagem_em = CURRENT_TIMESTAMP
                    WHERE id = %s
                ''', (mensagem_conteudo, self.id))
                
                print(f"‚úÖ [CONVERSA] √öltima mensagem atualizada: '{mensagem_conteudo}' para conversa {self.id}")
            except Exception as e:
                print(f"‚ùå [CONVERSA] Erro ao atualizar √∫ltima mensagem: {e}")

    def obter_participantes(self):
        """Retorna todos os participantes da conversa"""
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT u.id, u.username
                FROM participantes_conversa pc
                JOIN usuarios u ON pc.usuario_id = u.id
                WHERE pc.conversa_id = %s
            ''', (self.id,))
            
            return [dict(row) for row in cur.fetchall()]

    @classmethod
    def buscar_ou_criar_privada(cls, usuario1_id, usuario2_id):
        return cls.criar_privada(usuario1_id, usuario2_id)

    def usuario_eh_participante(self, usuario_id):
        """Verifica se um usu√°rio √© participante da conversa"""
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT 1 FROM participantes_conversa 
                WHERE conversa_id = %s AND usuario_id = %s
            ''', (self.id, usuario_id))
            
            return cur.fetchone() is not None

database.py:

# app/models/database.py - VERS√ÉO COMPLETA E CORRIGIDA
import psycopg2
import psycopg2.extras
from contextlib import contextmanager
import os
from dotenv import load_dotenv

load_dotenv()

class Database:
    def __init__(self):
        self.conn_params = {
            'host': os.getenv('DB_HOST', 'localhost'),
            'database': os.getenv('DB_NAME', 'chat_online'),
            'user': os.getenv('DB_USER', 'chat_user'),
            'password': os.getenv('DB_PASSWORD', 'chat_password'),
            'port': os.getenv('DB_PORT', '5432')
        }

    @contextmanager
    def get_connection(self):
        """Context manager para conex√£o"""
        conn = None
        try:
            conn = psycopg2.connect(**self.conn_params)
            yield conn
        except Exception as e:
            print(f"‚ùå Erro de conex√£o: {e}")
            raise
        finally:
            if conn:
                conn.close()

    @contextmanager
    def get_cursor(self):
        """Context manager para cursor"""
        with self.get_connection() as conn:
            cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
            try:
                yield cursor
                conn.commit()  # Commit se n√£o houve erro
            except Exception as e:
                conn.rollback()  # Rollback em caso de erro
                print(f"‚ùå Erro no cursor: {e}")
                raise

    def init_db(self):
        """Inicializa√ß√£o completa do banco de dados"""
        print("üîÑ Criando tabelas...")
        
        try:
            with self.get_cursor() as cur:
                # ‚úÖ TABELA USUARIOS (base de tudo)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS usuarios (
                        id SERIAL PRIMARY KEY,
                        username VARCHAR(50) UNIQUE NOT NULL,
                        email VARCHAR(100) UNIQUE,
                        password_hash VARCHAR(255) NOT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        is_online BOOLEAN DEFAULT FALSE,
                        last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                print("‚úÖ Tabela 'usuarios' criada/verificada")
                
                # ‚úÖ TABELA SESSOES (depende de usuarios)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS sessoes (
                        id SERIAL PRIMARY KEY,
                        usuario_id INTEGER REFERENCES usuarios(id),
                        session_token VARCHAR(255) UNIQUE NOT NULL,
                        expires_at TIMESTAMP NOT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                print("‚úÖ Tabela 'sessoes' criada/verificada")
                
                # ‚úÖ TABELA CONVERSAS (depende de usuarios)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS conversas (
                        id SERIAL PRIMARY KEY,
                        nome VARCHAR(255),
                        tipo VARCHAR(20) NOT NULL,
                        criado_por INTEGER REFERENCES usuarios(id),
                        criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        ultima_mensagem TEXT,
                        ultima_mensagem_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                print("‚úÖ Tabela 'conversas' criada/verificada")
                
                # ‚úÖ TABELA PARTICIPANTES_CONVERSA (depende de conversas e usuarios)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS participantes_conversa (
                        id SERIAL PRIMARY KEY,
                        conversa_id INTEGER REFERENCES conversas(id) ON DELETE CASCADE,
                        usuario_id INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
                        entrou_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        ultima_mensagem_vista INTEGER DEFAULT 0,
                        UNIQUE(conversa_id, usuario_id)
                    )
                ''')
                print("‚úÖ Tabela 'participantes_conversa' criada/verificada")
                
                # ‚úÖ TABELA MENSAGENS (depende de usuarios e conversas)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS mensagens (
                        id SERIAL PRIMARY KEY,
                        usuario_id INTEGER REFERENCES usuarios(id),
                        conteudo TEXT,
                        tipo VARCHAR(20) DEFAULT 'texto',
                        image_filename VARCHAR(255),
                        audio_filename VARCHAR(255),
                        audio_duration INTEGER,
                        chat_id VARCHAR(100) DEFAULT 'general',
                        chat_type VARCHAR(20) DEFAULT 'group',
                        conversa_id INTEGER REFERENCES conversas(id) ON DELETE SET NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                print("‚úÖ Tabela 'mensagens' criada/verificada")
                
                # ‚úÖ TABELA PEDIDOS_AMIZADE (depende de usuarios)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS pedidos_amizade (
                        id SERIAL PRIMARY KEY,
                        de_usuario_id INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
                        para_usuario_id INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
                        status VARCHAR(20) DEFAULT 'pending',
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                print("‚úÖ Tabela 'pedidos_amizade' criada/verificada")
                
                # ‚úÖ TABELA AMIZADES (depende de usuarios)
                cur.execute('''
                    CREATE TABLE IF NOT EXISTS amizades (
                        id SERIAL PRIMARY KEY,
                        usuario_id1 INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
                        usuario_id2 INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        UNIQUE(usuario_id1, usuario_id2)
                    )
                ''')
                print("‚úÖ Tabela 'amizades' criada/verificada")
                
                # ‚úÖ ADICIONAR COLUNAS FALTANTES SE NECESS√ÅRIO
                try:
                    # Garantir que a coluna conversa_id existe em mensagens
                    cur.execute('''
                        ALTER TABLE mensagens 
                        ADD COLUMN IF NOT EXISTS conversa_id INTEGER REFERENCES conversas(id) ON DELETE SET NULL
                    ''')
                    print("‚úÖ Coluna 'conversa_id' em mensagens verificada")
                except Exception as e:
                    print(f"‚ö†Ô∏è Aviso na coluna conversa_id: {e}")
                
                try:
                    # Garantir que a coluna ultima_mensagem_vista existe em participantes_conversa
                    cur.execute('''
                        ALTER TABLE participantes_conversa 
                        ADD COLUMN IF NOT EXISTS ultima_mensagem_vista INTEGER DEFAULT 0
                    ''')
                    print("‚úÖ Coluna 'ultima_mensagem_vista' em participantes_conversa verificada")
                except Exception as e:
                    print(f"‚ö†Ô∏è Aviso na coluna ultima_mensagem_vista: {e}")

            print("üéâ Todas as tabelas foram criadas/verificadas com sucesso!")
            
        except Exception as e:
            print(f"‚ùå Erro fatal ao inicializar banco: {e}")
            raise

    def test_connection(self):
        """Testa a conex√£o com o banco"""
        try:
            with self.get_cursor() as cur:
                cur.execute("SELECT version();")
                version = cur.fetchone()
                print(f"‚úÖ Conectado ao PostgreSQL: {version[0]}")
                return True
        except Exception as e:
            print(f"‚ùå Falha na conex√£o: {e}")
            return False

# ‚úÖ SCRIPT DE VERIFICA√á√ÉO R√ÅPIDA
if __name__ == '__main__':
    db = Database()
    if db.test_connection():
        print("‚úÖ Conex√£o com banco OK!")
        try:
            db.init_db()
            print("üéâ Banco inicializado com sucesso!")
        except Exception as e:
            print(f"‚ùå Erro na inicializa√ß√£o: {e}")
    else:
        print("‚ùå Problemas na conex√£o com o banco")
        
mensagem.py:

# app/models/mensagem.py - VERS√ÉO CORRIGIDA
from datetime import datetime, timezone
from app.models.database import Database

class Mensagem:
    def __init__(self, id, conteudo, usuario_id, tipo='texto', 
                 image_filename=None, audio_filename=None, audio_duration=None,
                 conversa_id=None, chat_id=None, chat_type=None, created_at=None, **kwargs):
        self.id = id
        self.conteudo = conteudo
        self.usuario_id = usuario_id
        self.tipo = tipo
        self.image_filename = image_filename
        self.audio_filename = audio_filename
        self.audio_duration = audio_duration
        self.conversa_id = conversa_id
        self.chat_id = chat_id
        self.chat_type = chat_type
        self.created_at = created_at or datetime.now(timezone.utc)
        
        # ‚úÖ CORRE√á√ÉO: Obter username de forma segura
        if hasattr(self, 'username') and self.username:
            self.nome = self.username
        else:
            from app.models.usuario import Usuario
            usuario = Usuario.buscar_por_id(self.usuario_id)
            self.nome = usuario.username if usuario else 'Usu√°rio Desconhecido'

    @classmethod
    def criar(cls, conteudo, usuario_id, tipo='texto', **kwargs):
        """Cria uma nova mensagem - VERS√ÉO 100% CORRIGIDA"""
        db = Database()
        with db.get_cursor() as cur:
            # ‚úÖ EXTRAIR TODOS OS PAR√ÇMETROS CORRETAMENTE
            image_filename = kwargs.get('image_filename')
            audio_filename = kwargs.get('audio_filename')
            audio_duration = kwargs.get('audio_duration')
            conversa_id = kwargs.get('conversa_id')  # ‚úÖ AGORA EST√Å SENDO USADO
            chat_id = kwargs.get('chat_id', 'general')
            chat_type = kwargs.get('chat_type', 'group')

            print(f"üéØ [MENSAGEM-CRIAR] Criando mensagem:")
            print(f"   üìù Conte√∫do: '{conteudo}'")
            print(f"   üë§ Usu√°rio: {usuario_id}")
            print(f"   üí¨ Conversa: {conversa_id}")
            print(f"   üÜî Chat: {chat_id}")

            # ‚úÖ QUERY CORRETA - INCLUIR conversa_id
            cur.execute('''
                INSERT INTO mensagens 
                (usuario_id, conteudo, tipo, image_filename, audio_filename, 
                audio_duration, conversa_id, chat_id, chat_type)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                RETURNING id, created_at
            ''', (
                usuario_id, conteudo, tipo, 
                image_filename, audio_filename, audio_duration,
                conversa_id, chat_id, chat_type  # ‚úÖ conversa_id INCLU√çDO
            ))
            
            result = cur.fetchone()
            
            print(f"‚úÖ [MENSAGEM-CRIAR] Mensagem criada: ID {result['id']}, Conversa: {conversa_id}")

            # ‚úÖ ATUALIZAR √öLTIMA MENSAGEM DA CONVERSA (se tiver conversa_id)
            if conversa_id:
                try:
                    from app.models.conversa import Conversa
                    conversa = Conversa.buscar_por_id(conversa_id)
                    if conversa:
                        # Criar preview
                        preview = conteudo
                        if tipo == 'imagem':
                            preview = 'üì∑ Imagem'
                        elif tipo == 'audio':
                            preview = 'üé§ √Åudio'
                        elif len(conteudo) > 30:
                            preview = conteudo[:30] + '...'
                        
                        conversa.atualizar_ultima_mensagem(preview)
                        print(f"‚úÖ [MENSAGEM-CRIAR] Preview atualizado: '{preview}'")
                except Exception as e:
                    print(f"‚ö†Ô∏è [MENSAGEM-CRIAR] Erro ao atualizar preview: {e}")
            
            # ‚úÖ RETORNAR INST√ÇNCIA
            return cls(
                result['id'], conteudo, usuario_id, tipo,
                image_filename, audio_filename, audio_duration,
                conversa_id, chat_id, chat_type, result['created_at']
            )

    def to_dict(self):
        data = {
            'id': self.id,
            'nome': self.nome,
            'conteudo': self.conteudo,
            'timestamp': self.created_at.isoformat(),
            'type': self.tipo,
            'chat_id': self.chat_id,
            'chat_type': self.chat_type
        }
        
        if self.conversa_id:
            data['conversa_id'] = self.conversa_id
            
        if self.tipo == 'imagem' and self.image_filename:
            data['image_filename'] = self.image_filename
        elif self.tipo == 'audio' and self.audio_filename:
            data['audio_filename'] = self.audio_filename
            data['audio_duration'] = self.audio_duration
        
        if hasattr(self, 'edited_at') and self.edited_at:
            data['edited_at'] = self.edited_at.isoformat()
            data['is_edited'] = True
        else:
            data['is_edited'] = False
           
        return data

    @classmethod
    def buscar_por_conversa(cls, conversa_id, since=None):
        db = Database()
        with db.get_cursor() as cur:
            query = '''
                SELECT m.*, u.username 
                FROM mensagens m
                JOIN usuarios u ON m.usuario_id = u.id
                WHERE m.conversa_id = %s
            '''
            params = [conversa_id]
            
            if since:
                query += ' AND m.created_at > %s'
                params.append(since)
                
            query += ' ORDER BY m.created_at ASC'
            
            cur.execute(query, params)
            
            mensagens = []
            for row in cur.fetchall():
                mensagem_data = {
                    'id': row['id'],
                    'conteudo': row['conteudo'],
                    'usuario_id': row['usuario_id'],
                    'tipo': row['tipo'],
                    'image_filename': row['image_filename'],
                    'audio_filename': row['audio_filename'],
                    'audio_duration': row['audio_duration'],
                    'conversa_id': row['conversa_id'],
                    'chat_id': row['chat_id'],
                    'chat_type': row['chat_type'],
                    'created_at': row['created_at'],
                    'username': row['username']
                }
                
                mensagem_data = {k: v for k, v in mensagem_data.items() if v is not None}
                mensagens.append(cls(**mensagem_data))
                
            return mensagens

    @classmethod
    def buscar_por_chat(cls, chat_id, since=None):
        db = Database()
        with db.get_cursor() as cur:
            query = '''
                SELECT m.*, u.username 
                FROM mensagens m
                JOIN usuarios u ON m.usuario_id = u.id
                WHERE m.chat_id = %s
            '''
            params = [chat_id]
            
            if since:
                query += ' AND m.created_at > %s'
                params.append(since)
                
            query += ' ORDER BY m.created_at ASC'
            
            cur.execute(query, params)
            
            mensagens = []
            for row in cur.fetchall():
                mensagem_data = {
                    'id': row['id'],
                    'conteudo': row['conteudo'],
                    'usuario_id': row['usuario_id'],
                    'tipo': row['tipo'],
                    'image_filename': row['image_filename'],
                    'audio_filename': row['audio_filename'],
                    'audio_duration': row['audio_duration'],
                    'conversa_id': row['conversa_id'],
                    'chat_id': row['chat_id'],
                    'chat_type': row['chat_type'],
                    'created_at': row['created_at'],
                    'username': row['username']
                }
                
                mensagem_data = {k: v for k, v in mensagem_data.items() if v is not None}
                mensagens.append(cls(**mensagem_data))
                
            return mensagens

usuario.py:

# app/models/usuario.py 
import bcrypt
import secrets
from datetime import datetime, timedelta
from app.models.database import Database
import psycopg2

class Usuario:
    def __init__(self, id, username, created_at=None, is_online=False):
        self.id = id
        self.username = username
        self.created_at = created_at
        self.is_online = is_online

    @classmethod
    def criar(cls, username, password):
        db = Database()
        password_hash = cls._hash_password(password)
        
        with db.get_cursor() as cur:
            try:
                cur.execute('''
                    INSERT INTO usuarios (username, password_hash)
                    VALUES (%s, %s) RETURNING id, created_at
                ''', (username, password_hash))
                
                result = cur.fetchone()
                return cls(result['id'], username, result['created_at'])
            except psycopg2.IntegrityError:
                return None  # Usu√°rio j√° existe
            except Exception as e:
                print(f"Erro ao criar usu√°rio: {e}")
                return None

    @classmethod
    def autenticar(cls, username, password):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT id, username, password_hash, created_at, is_online
                FROM usuarios WHERE username = %s
            ''', (username,))
            
            result = cur.fetchone()
            if result and cls._verify_password(password, result['password_hash']):
                return cls(
                    result['id'], 
                    result['username'],
                    result['created_at'],
                    result['is_online']
                )
        return None

    @classmethod
    def buscar_por_id(cls, user_id):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT id, username, created_at, is_online
                FROM usuarios WHERE id = %s
            ''', (user_id,))
            
            result = cur.fetchone()
            if result:
                return cls(
                    result['id'], 
                    result['username'],
                    result['created_at'],
                    result['is_online']
                )
        return None

    @classmethod
    def buscar_por_username(cls, username):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT id, username, created_at, is_online
                FROM usuarios WHERE username = %s
            ''', (username,))
            
            result = cur.fetchone()
            if result:
                return cls(
                    result['id'], 
                    result['username'],
                    result['created_at'],
                    result['is_online']
                )
        return None

    @staticmethod
    def _hash_password(password):
        # BCRYPT - MUITO MAIS SEGURO!
        salt = bcrypt.gensalt()
        return bcrypt.hashpw(password.encode('utf-8'), salt).decode('utf-8')

    @staticmethod
    def _verify_password(password, password_hash):
        # BCRYPT - Verifica√ß√£o segura
        try:
            return bcrypt.checkpw(password.encode('utf-8'), password_hash.encode('utf-8'))
        except Exception:
            return False

    def atualizar_online_status(self, is_online=True):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                UPDATE usuarios 
                SET is_online = %s, last_seen = CURRENT_TIMESTAMP
                WHERE id = %s
            ''', (is_online, self.id))

    @classmethod
    def listar_online(cls):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT id, username, created_at, is_online
                FROM usuarios 
                WHERE is_online = TRUE 
                ORDER BY username
            ''')
            
            results = cur.fetchall()
            usuarios = []
            for row in results:
                usuarios.append(cls(
                    row['id'], 
                    row['username'],
                    row['created_at'],
                    row['is_online']
                ))
            return usuarios

    def criar_sessao(self):
        db = Database()
        session_token = secrets.token_urlsafe(32)
        expires_at = datetime.now() + timedelta(days=7)
        
        with db.get_cursor() as cur:
            cur.execute('''
                INSERT INTO sessoes (usuario_id, session_token, expires_at)
                VALUES (%s, %s, %s)
            ''', (self.id, session_token, expires_at))
            
        return session_token

    @classmethod
    def validar_sessao(cls, session_token):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('''
                SELECT u.id, u.username, u.created_at, u.is_online
                FROM usuarios u
                JOIN sessoes s ON u.id = s.usuario_id
                WHERE s.session_token = %s AND s.expires_at > CURRENT_TIMESTAMP
            ''', (session_token,))
            
            result = cur.fetchone()
            if result:
                return cls(
                    result['id'], 
                    result['username'],
                    result['created_at'],
                    result['is_online']
                )
        return None

    def invalidar_sessao(self, session_token):
        db = Database()
        with db.get_cursor() as cur:
            cur.execute('DELETE FROM sessoes WHERE usuario_id = %s AND session_token = %s', 
                       (self.id, session_token))

Chat_Online/app/static/css/:

chat.css:

/* static/css/chat.css */
/* Ajustes para centralizar a tela de login */

* {
    box-sizing: border-box;
}

body {
    font-family: 'Open Sans', sans-serif;
    background: linear-gradient(135deg, #044f48, #2a7561);
    margin: 0;
    padding: 10; /* ‚úÖ MUDAR de 10px para 0 */
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
    height: auto
}

/* Ajustes para o container do chat */
.chat-container {
    width: 100%; /* ‚úÖ MUDAR de 95% para 100% */
    max-width: 800px;
    height: 90vh; /* ‚úÖ Garantir 100% da tela */
    background: rgba(0, 0, 0, 0.5);
    border-radius: 20px; /* ‚úÖ REMOVER bordas para ocupar toda tela */
    overflow: hidden;
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    position: relative;
    margin: 0 auto;
}

/* TELA DE LOGIN - CENTRALIZADA */
.name-setup {
    background: rgba(0, 0, 0, 0.6);
    padding: 40px 30px;
    text-align: center;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    flex: 1;  /* Preenche espa√ßo dispon√≠vel */
    height: 100%;
    width: 100%;
}

.name-setup h2 {
    margin-bottom: 30px;
    color: #fff;
    font-size: 28px;
    font-weight: 300;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.name-setup input {
    width: 100%;
    max-width: 280px;
    padding: 15px 20px;
    margin-bottom: 25px;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.15);
    color: white;
    font-size: 16px;
    text-align: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.name-setup input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.name-setup input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.name-setup button {
    padding: 15px 30px;
    border: none;
    background: linear-gradient(120deg, #248A52, #257287);
    color: white;
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 180px;
    box-shadow: 0 4px 15px rgba(36, 138, 82, 0.3);
    letter-spacing: 0.5px;
}

.name-setup button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(36, 138, 82, 0.4);
    background: linear-gradient(120deg, #2a9c5f, #2d87a1);
}

.name-setup button:active {
    transform: translateY(-1px);
}

/* Resto do CSS permanece igual */
.chat-area {
    display: flex;
    flex-direction: column;
    height: 100%; /* ‚úÖ 100% do container */
    flex: 1; /* ‚úÖ CRESCER para preencher espa√ßo */
}

/* Header do chat */
.chat-header {
    background: rgba(0, 0, 0, 0.2);
    color: white;
    padding: 12px 15px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0; /* ‚úÖ N√ÉO ENCOLHER */
    box-sizing: border-box;
}

.chat-header h1 {
    margin: 0 0 8px 0; /* Reduzi a margem inferior */
    font-size: 22px; /* Reduzi levemente */
}

.online-users {
    margin-top: 8px;
}

.online-users h3 {
    margin: 0 0 4px 0; /* Margens reduzidas */
    font-size: 13px; /* Tamanho reduzido */
}

#online-list {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    padding: 0;
    margin: 0;
    gap: 4px; /* Uso gap em vez de margin */
}

#online-list li {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 8px; /* Padding reduzido */
    border-radius: 10px; /* Border-radius reduzido */
    color: white;
    font-size: 12px; /* Tamanho reduzido */
    font-weight: 600;
}

.chat-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.back-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background 0.2s;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.chat-title-container {
    flex: 1;
}

#chat-title {
    margin: 0 0 4px 0;
    font-size: 20px;
}

.chat-info {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.7);
    margin: 0;
}

/* √Årea de mensagens */
.messages {
    flex: 1; /* ‚úÖ CRESCER para preencher espa√ßo dispon√≠vel */
    padding: 12px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.1);
    min-height: 0; /* ‚úÖ IMPORTANTE para flexbox */
    scroll-behavior: smooth;
    box-sizing: border-box;
}

.messages::-webkit-scrollbar {
    width: 6px;  /* Barra fina */
}

.messages::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

.messages::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.messages::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Mensagens individuais - ajuste de largura */
.message {
    max-width: 85%; /* Aumentei de 80% para 85% */
    padding: 8px 12px 6px;
    margin-bottom: 8px;
    border-radius: 18px;
    animation: fadeIn 0.3s ease-in;
    word-wrap: break-word;
    box-sizing: border-box;
}

.message.hidden {
    opacity: 0;
    max-height: 0;
    margin-bottom: 0;
    overflow: hidden;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    gap: 10px; /* ‚Üê ADICIONE ISSO para espa√ßo entre nome e hor√°rio */
}


.message.self {
    background: linear-gradient(120deg, #248A52, #257287);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.message.other {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.message strong {
    font-weight: 600;
}

.message-content {
    margin-bottom: 2px;
}

.message .timestamp {
    font-size: 0.6em;
    color: rgba(255, 255, 255, 0.5);
    margin-left: 8px;
}

.message.other .timestamp {
    left: 12px;
    right: auto;
    margin-left: 2px; /* Espa√ßo entre o nome e o hor√°rio */
}

/* Estilos para a√ß√µes de mensagem */
.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    padding: 5px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    animation: fadeIn 0.2s ease-in;
}

.message-actions button {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 4px;
    color: white;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.message-actions button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
}

.edit-indicator {
    font-size: 0.7em;
    color: rgba(255, 255, 255, 0.6);
    font-style: italic;
    margin-left: 5px;
}

/* Feedback visual para mensagem sendo exclu√≠da */
.message.deleting {
    opacity: 0.5;
    background: rgba(255, 0, 0, 0.1) !important;
    transition: all 0.3s ease;
}

.input-area {
    display: flex;
    padding: 10px 12px;
    background: rgba(0, 0, 0, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0; /* ‚úÖ N√ÉO ENCOLHER */
    align-items: center;
    gap: 6px;
    min-height: 60px;
    box-sizing: border-box;
}

#emoji-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px; /* Reduzi de 20px */
    cursor: pointer;
    padding: 6px; /* Reduzi de 8px */
    border-radius: 50%;
    transition: background 0.2s;
    flex-shrink: 0; /* Impede que os bot√µes encolham */
    width: 36px; /* Largura fixa */
    height: 36px; /* Altura fixa */
    display: flex;
    align-items: center;
    justify-content: center;
}

#emoji-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

#emoji-picker {
    position: absolute;
    bottom: 100%;  /* Acima do input */
    left: 0;
    z-index: 100;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* Campo de input de texto */
#msg-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 15px; /* Reduzi levemente */
    padding: 10px 14px; /* Ajustei o padding */
    border-radius: 20px; /* Reduzi de 24px */
    outline: none;
    min-height: 20px;
    max-height: 60px; /* Limite reduzido */
    overflow-y: auto;
    box-sizing: border-box;
}

#msg-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

/* Bot√£o enviar */
#send-btn {
    background: linear-gradient(120deg, #248A52, #257287);
    color: white;
    border: none;
    padding: 10px 16px; /* Ajustei o padding */
    border-radius: 20px; /* Reduzi de 24px */
    cursor: pointer;
    font-size: 14px; /* Reduzi levemente */
    transition: transform 0.2s, box-shadow 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    min-width: 60px; /* Largura m√≠nima */
}

#send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(36, 138, 82, 0.3);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Modal de Emojis */
.emoji-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.emoji-modal-content {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    max-height: 70vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

.emoji-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    color: white;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.emoji-header h3 {
    margin: 0;
    font-size: 18px;
}

#close-emoji-modal {
    font-size: 24px;
    cursor: pointer;
    color: white;
    padding: 5px 10px;
    border-radius: 50%;
    transition: background 0.2s;
}

#close-emoji-modal:hover {
    background: rgba(255, 255, 255, 0.1);
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 8px;
    padding: 20px;
    max-height: 50vh;
    overflow-y: auto;
    scrollbar-width: thin;
}

.emoji-grid::-webkit-scrollbar {
    width: 6px;
}

.emoji-grid::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
}

.emoji-grid::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
}

.emoji-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 10px;
    border-radius: 12px;
    transition: all 0.2s;
    width: 100%;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Barra de pesquisa de emojis */
.emoji-search {
    padding: 15px 20px;
    background: rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#emoji-search {
    width: 100%;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 16px;
    outline: none;
}

#emoji-search::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

#emoji-search:focus {
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
}

/* Footer do modal de emojis */
.emoji-footer {
    padding: 10px 20px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
    text-align: center;
    font-size: 12px;
}

/* Mensagem quando n√£o h√° resultados */
.no-results {
    grid-column: 1 / -1;
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    padding: 20px;
    font-style: italic;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Responsivo */
@media (max-width: 480px) {
    body {
        padding: 5px;
    }
    
    .chat-container {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
    }
    
    .name-setup {
        padding: 30px 20px;
    }
    
    .name-setup h2 {
        font-size: 24px;
        margin-bottom: 25px;
    }
    
    .name-setup input {
        max-width: 100%;
        padding: 14px 18px;
    }
    
    .name-setup button {
        padding: 14px 25px;
        min-width: 160px;
    }
    
    .messages {
        padding: 10px;
    }
    
    .emoji-modal-content {
        width: 95%;
        max-height: 80vh;
    }
}

/* Bot√£o de anexar imagem */
#attach-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px; /* Reduzi de 20px */
    cursor: pointer;
    padding: 6px; /* Reduzi de 8px */
    border-radius: 50%;
    transition: background 0.2s;
    flex-shrink: 0; /* Impede que os bot√µes encolham */
    width: 36px; /* Largura fixa */
    height: 36px; /* Altura fixa */
    display: flex;
    align-items: center;
    justify-content: center;
}

#attach-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Modal de preview de imagem */
.image-preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    backdrop-filter: blur(5px);
}

.image-preview-content {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

.image-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    color: white;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.image-preview-header h3 {
    margin: 0;
    font-size: 18px;
}

#close-preview-modal {
    font-size: 24px;
    cursor: pointer;
    color: white;
    padding: 5px 10px;
    border-radius: 50%;
    transition: background 0.2s;
}

#close-preview-modal:hover {
    background: rgba(255, 255, 255, 0.1);
}

.image-preview-body {
    padding: 20px;
    text-align: center;
    max-height: 400px;
    overflow: hidden;
}

#preview-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.image-preview-footer {
    padding: 15px 20px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.image-preview-footer button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    flex: 1;
}

#cancel-preview {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

#cancel-preview:hover {
    background: rgba(255, 255, 255, 0.2);
}

#send-image {
    background: linear-gradient(120deg, #248A52, #257287);
    color: white;
}

#send-image:hover {
    background: linear-gradient(120deg, #2a9c5f, #2d87a1);
    transform: translateY(-2px);
}

/* Mensagens com imagem */
.message-image {
    max-width: 100%; /* Garante que a imagem n√£o ultrapasse o container */
    height: auto;
    margin-top: 5px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: transform 0.2s;
}

.message-image:hover {
    transform: scale(1.02);
}

.message-image-container {
    position: relative;
    display: inline-block;
    max-width: 100%;
    margin-bottom: 2px;
}

.message-image-caption {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 5px;
    font-style: italic;
}

/* Modal de imagem ampliada */
.image-fullscreen-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1002;
    cursor: pointer;
}

.image-fullscreen-content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
}

.image-fullscreen-content img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

/* Loading para upload de imagem */
.image-loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsivo para imagens */
@media (max-width: 480px) {
    .message-image {
        max-width: 250px;
    }
    
    .image-preview-content {
        width: 95%;
        margin: 10px;
    }
    
    .image-preview-body {
        padding: 15px;
    }
    
    #preview-image {
        max-height: 250px;
    }
}

/* Modal de grava√ß√£o de √°udio */
.audio-record-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    backdrop-filter: blur(5px);
}

.audio-record-content {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

.audio-record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    color: white;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.audio-record-header h3 {
    margin: 0;
    font-size: 18px;
}

#close-audio-modal {
    font-size: 24px;
    cursor: pointer;
    color: white;
    padding: 5px 10px;
    border-radius: 50%;
    transition: background 0.2s;
}

#close-audio-modal:hover {
    background: rgba(255, 255, 255, 0.1);
}

.audio-record-body {
    padding: 20px;
    text-align: center;
}

#audio-record-visualizer {
    width: 100%;
    height: 100px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 14px;
}

#audio-record-timer {
    font-size: 24px;
    color: white;
    margin-bottom: 15px;
    font-weight: bold;
}

.audio-record-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
}

.audio-record-controls button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
}

#start-record-btn {
    background: linear-gradient(120deg, #248A52, #257287);
    color: white;
}

#start-record-btn:hover:not(:disabled) {
    background: linear-gradient(120deg, #2a9c5f, #2d87a1);
}

#stop-record-btn {
    background: linear-gradient(120deg, #c9302c, #d9534f);
    color: white;
}

#stop-record-btn:hover:not(:disabled) {
    background: linear-gradient(120deg, #d9534f, #c9302c);
}

.audio-record-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#audio-preview {
    margin-top: 15px;
}

#audio-preview audio {
    width: 100%;
    border-radius: 10px;
}

.audio-record-footer {
    padding: 15px 20px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.audio-record-footer button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    flex: 1;
}

#cancel-audio {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

#cancel-audio:hover {
    background: rgba(255, 255, 255, 0.2);
}

#send-audio {
    background: linear-gradient(120deg, #248A52, #257287);
    color: white;
}

#send-audio:hover:not(:disabled) {
    background: linear-gradient(120deg, #2a9c5f, #2d87a1);
}

#send-audio:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Bot√£o de gravar √°udio na √°rea de input */
#record-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px; /* Reduzi de 20px */
    cursor: pointer;
    padding: 6px; /* Reduzi de 8px */
    border-radius: 50%;
    transition: background 0.2s;
    flex-shrink: 0; /* Impede que os bot√µes encolham */
    width: 36px; /* Largura fixa */
    height: 36px; /* Altura fixa */
    display: flex;
    align-items: center;
    justify-content: center;
}
#record-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Mensagens de √°udio */
.message-audio {
    margin-top: 5px;
}

.message-audio audio {
    max-width: 100%;
    border-radius: 20px;
    outline: none;
}

.message-audio-caption {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 5px;
    font-style: italic;
}

/* Anima√ß√£o para grava√ß√£o */
.recording-animation {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

home.css:

/* app/static/css/home.css */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden; /* ‚úÖ IMPEDIR SCROLL GLOBAL */
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #111b21;
    color: #e9edef;
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}

.home-container {
    display: flex;
    width: 100vw;
    height: 100vh;
    background: #111b21;
    position: fixed;
    top: 0;
    left: 0;
    margin: 0;
    padding: 0;
    overflow: hidden;
}

/* Sidebar de conversas */
.conversations-sidebar {
    width: 30%;
    min-width: 300px;
    max-width: 400px;
    height: 100vh;
    background: #202c33;
    border-right: 1px solid #2a3942;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ‚úÖ √ÅREA DO CHAT - 70% DA TELA */
.chat-integrated-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #222e35;
    position: relative;
    height: 100vh;
    overflow: hidden;
}

.welcome-chat-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: #8696a0;
    padding: 40px;
}

.welcome-chat-state .welcome-icon {
    font-size: 80px;
    margin-bottom: 24px;
    opacity: 0.7;
}

/* ‚úÖ ESTADO DE BOAS-VINDAS - TELA CHEIA */
.welcome-chat-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: #8696a0;
    padding: 40px;
    width: 100%;
}

.welcome-chat-state p {
    font-size: 16px;
    color: #8696a0;
}

/* ‚úÖ CHAT ATIVO - TELA CHEIA */
.active-chat {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
}

/* Header do chat integrado */
/* ‚úÖ REMOVER BORDAS ARREDONDADAS E MARGENS */
.chat-integrated-area .chat-header {
    background: #202c33;
    padding: 12px 16px;
    border-bottom: 1px solid #2a3942;
    flex-shrink: 0;
    margin: 0;
    border-radius: 0;
}

.chat-integrated-area .chat-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.chat-integrated-area .back-btn {
    background: none;
    border: none;
    color: #aebac1;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background 0.2s;
}

.chat-integrated-area .back-btn:hover {
    background: #2a3942;
}

.chat-integrated-area .chat-title-container {
    flex: 1;
}

.chat-integrated-area #chat-title {
    margin: 0;
    font-size: 16px;
    color: #e9edef;
}

.chat-integrated-area .chat-info {
    font-size: 13px;
    color: #8696a0;
    margin: 0;
}

/* √Årea de mensagens integrada */
/* ‚úÖ √ÅREA DE MENSAGENS - TELA CHEIA */
.chat-integrated-area .messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #0b141a;
    min-height: 0;
    margin: 0;
    border-radius: 0;
}

/* ‚úÖ √ÅREA DE INPUT - SEM BORDAS */
.chat-integrated-area .input-area {
    background: #202c33;
    padding: 12px 16px;
    border-top: 1px solid #2a3942;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    margin: 0;
    border-radius: 0;
}

.chat-integrated-area #msg-input {
    flex: 1;
    background: #2a3942;
    border: none;
    border-radius: 8px;
    padding: 9px 12px;
    color: #e9edef;
    font-size: 15px;
    outline: none;
}

.chat-integrated-area #msg-input::placeholder {
    color: #8696a0;
}

.chat-integrated-area #send-btn {
    background: #00a884;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 9px 16px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
}

/* Responsivo */
@media (max-width: 768px) {
    .conversations-sidebar {
        width: 100%;
        max-width: none;
    }
    
    .home-container.sidebar-hidden .conversations-sidebar {
        display: none;
    }
    
    .home-container.sidebar-hidden .chat-integrated-area {
        width: 100%;
    }
}

/* ‚úÖ HEADER DA SIDEBAR */
.sidebar-header {
    padding: 16px;
    background: #202c33;
    border-bottom: 1px solid #2a3942;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #248A52, #257287);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

.user-name {
    font-weight: 600;
    font-size: 16px;
}

.header-actions {
    display: flex;
    gap: 8px;
}

.header-actions button {
    background: none;
    border: none;
    color: #aebac1;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background 0.2s;
}

.header-actions button:hover {
    background: #2a3942;
}

/* Bot√£o de Logout */
#logout-btn {
    background: none;
    border: none;
    color: #aebac1;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background 0.2s;
    /* For√ßar que seja clic√°vel */
    pointer-events: auto !important;
    position: relative !important;
    z-index: 1000 !important;
}

#logout-btn:hover {
    background: #2a3942;
    color: #fff;
}

/* Barra de pesquisa */
.search-bar {
    padding: 12px 16px;
    background: #202c33;
}

.search-container {
    position: relative;
    background: #2a3942;
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
}

.search-icon {
    color: #aebac1;
    margin-right: 8px;
}

#search-input {
    background: none;
    border: none;
    color: #e9edef;
    font-size: 14px;
    width: 100%;
    outline: none;
}

#search-input::placeholder {
    color: #aebac1;
}

/* Lista de conversas */
.conversations-list {
    flex: 1;
    overflow-y: auto;
    background: #111b21;
    height: 100%;
}

.conversation-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid #222d34;
}

.conversation-item:hover {
    background: #2a3942;
}

.conversation-item.active {
    background: #2a3942;
}

.conversation-avatar {
    width: 49px;
    height: 49px;
    border-radius: 50%;
    background: #248A52;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-right: 15px;
}

.group-avatar {
    background: #7856e0;
}

.conversation-info {
    flex: 1;
    min-width: 0;
}

.conversation-name {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
    color: #e9edef;
}

.conversation-preview {
    font-size: 14px;
    color: #8696a0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
}

.conversation-time {
    font-size: 12px;
    color: #8696a0;
}

.unread-count {
    background: #00a884;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 12px;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}

/* Bot√£o flutuante para novo grupo */
.floating-new-group {
    position: absolute;
    bottom: 24px;
    right: 24px;
    background: #00a884;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 168, 132, 0.3);
    transition: transform 0.2s, box-shadow 0.2s;
    z-index: 100;
}

.floating-new-group:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 168, 132, 0.4);
}

/* √Årea de conte√∫do */
.content-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #222e35;
    position: relative;
}

.welcome-message {
    text-align: center;
    max-width: 500px;
    padding: 40px;
}

.welcome-icon {
    font-size: 80px;
    margin-bottom: 24px;
}

.welcome-message h1 {
    font-size: 32px;
    margin-bottom: 16px;
    color: #e9edef;
}

.welcome-message p {
    font-size: 16px;
    color: #8696a0;
    margin-bottom: 8px;
    line-height: 1.5;
}

.welcome-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-top: 32px;
}

.welcome-btn {
    background: #00a884;
    color: white;
    border: none;
    border-radius: 24px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}

.welcome-btn:hover {
    background: #008f70;
}

/* Modais */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(11, 20, 26, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: #2a3942;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.modal-header {
    padding: 20px 24px;
    background: #202c33;
    border-bottom: 1px solid #2a3942;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    color: #e9edef;
    font-size: 18px;
}

.close-modal {
    font-size: 24px;
    cursor: pointer;
    color: #8696a0;
    padding: 4px;
    border-radius: 50%;
    transition: background 0.2s;
}

.close-modal:hover {
    background: #2a3942;
}

.modal-body {
    padding: 20px 24px;
    max-height: 400px;
    overflow-y: auto;
}

.modal-footer {
    padding: 16px 24px;
    background: #202c33;
    border-top: 1px solid #2a3942;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.modal-footer button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}

#cancel-group, #cancel-private {
    background: #2a3942;
    color: #e9edef;
}

#cancel-group:hover, #cancel-private:hover {
    background: #3a4952;
}

#create-group {
    background: #00a884;
    color: white;
}

#create-group:hover {
    background: #008f70;
}

/* Formul√°rios nos modais */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #e9edef;
    font-weight: 600;
}

.form-group input {
    width: 100%;
    padding: 12px;
    background: #2a3942;
    border: 1px solid #3a4952;
    border-radius: 4px;
    color: #e9edef;
    font-size: 14px;
    outline: none;
}

.form-group input:focus {
    border-color: #00a884;
}

/* Listas de usu√°rios/membros */
.members-list, .users-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #3a4952;
    border-radius: 4px;
    background: #2a3942;
}

.member-item, .user-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #3a4952;
    cursor: pointer;
    transition: background 0.2s;
}

.member-item:hover, .user-item:hover {
    background: #3a4952;
}

.member-item:last-child, .user-item:last-child {
    border-bottom: none;
}

.member-avatar, .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #248A52;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
}

.member-name, .user-name {
    flex: 1;
    color: #e9edef;
    font-weight: 600;
}

.member-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #8696a0;
    border-radius: 4px;
    cursor: pointer;
}

.member-checkbox.selected {
    background: #00a884;
    border-color: #00a884;
}

/* Responsivo */
@media (max-width: 768px) {
    .conversations-sidebar {
        width: 100%;
    }
    
    .content-area {
        display: none;
    }
    
    .home-container.sidebar-hidden .conversations-sidebar {
        display: none;
    }
    
    .home-container.sidebar-hidden .content-area {
        display: flex;
        width: 100%;
    }
}

/* Scrollbar personalizada */
.conversations-list::-webkit-scrollbar,
.friends-list::-webkit-scrollbar,
.chat-integrated-area .messages::-webkit-scrollbar {
    width: 6px;
}

.conversations-list::-webkit-scrollbar-track,
.friends-list::-webkit-scrollbar-track,
.chat-integrated-area .messages::-webkit-scrollbar-track {
    background: #2a3942;
}

.conversations-list::-webkit-scrollbar-thumb,
.friends-list::-webkit-scrollbar-thumb,
.chat-integrated-area .messages::-webkit-scrollbar-thumb {
    background: #8696a0;
    border-radius: 3px;
}

/* Guias de Navega√ß√£o */
.navigation-tabs {
    display: flex;
    background: #202c33;
    border-bottom: 1px solid #2a3942;
}

.tab-button {
    flex: 1;
    padding: 15px;
    background: none;
    border: none;
    color: #aebac1;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-button:hover {
    background: #2a3942;
    color: #e9edef;
}

.tab-button.active {
    color: #00a884;
    border-bottom: 2px solid #00a884;
    background: #2a3942;
}

/* Conte√∫do das Guias */
.tab-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}


.tab-pane {
    flex: 1;
    display: none;
    flex-direction: column;
}

.tab-pane.active {
    display: flex;
}

/* Lista de Amigos */
.friends-list {
    flex: 1;
    overflow-y: auto;
    background: #111b21;
    height: 100%;
}

.friend-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid #222d34;
}

.friend-item:hover {
    background: #2a3942;
}

.friend-avatar {
    width: 49px;
    height: 49px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7856e0, #248A52);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    color: white;
    margin-right: 15px;
}

.friend-info {
    flex: 1;
    min-width: 0;
}

.friend-name {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
    color: #e9edef;
}

.friend-status {
    font-size: 13px;
    color: #8696a0;
    display: flex;
    align-items: center;
    gap: 5px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #8696a0;
}

.status-dot.online {
    background: #00a884;
}

.friend-actions {
    display: flex;
    gap: 8px;
}

.friend-action-btn {
    background: none;
    border: none;
    color: #aebac1;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background 0.2s;
    font-size: 16px;
}

.friend-action-btn:hover {
    background: #2a3942;
    color: #e9edef;
}

/* Estado Vazio - MELHORADO */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 60px 30px;
    color: #8696a0;
    height: 100%;
    min-height: 300px;
}

.empty-icon {
    font-size: 80px;
    margin-bottom: 20px;
    opacity: 0.7;
}

.empty-state h3 {
    color: #e9edef;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 10px;
}

.empty-state p {
    font-size: 14px;
    margin-bottom: 25px;
    line-height: 1.5;
    max-width: 300px;
}

.empty-state .welcome-btn {
    background: #00a884;
    color: white;
    border: none;
    border-radius: 24px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    font-size: 14px;
}

.empty-state .welcome-btn:hover {
    background: #008f70;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 168, 132, 0.3);
}

/* Bot√£o de A√ß√£o Flutuante Universal */
.floating-action-button {
    position: absolute;
    bottom: 24px;
    right: 24px;
    background: #00a884;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 168, 132, 0.3);
    z-index: 100;
}

.floating-action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 168, 132, 0.4);
}

/* Modal de Adicionar Amigo */
.form-hint {
    font-size: 12px;
    color: #8696a0;
    margin-top: 5px;
}

.search-results {
    margin-top: 15px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #3a4952;
    border-radius: 4px;
    background: #2a3942;
}

.search-result-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #3a4952;
    cursor: pointer;
    transition: background 0.2s;
}

.search-result-item:hover {
    background: #3a4952;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #248A52;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
}

.search-result-info {
    flex: 1;
}

.search-result-name {
    color: #e9edef;
    font-weight: 600;
}

.search-result-status {
    font-size: 12px;
    color: #8696a0;
}

/* ========== SISTEMA DE AMIGOS - ESTILOS COMPLETOS ========== */

/* Lista de Pedidos de Amizade */
.requests-list {
    max-height: 300px;
    overflow-y: auto;
}

.friend-request-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #3a4952;
    background: #2a3942;
    border-radius: 8px;
    margin-bottom: 10px;
}

.friend-request-info {
    flex: 1;
}

.friend-request-name {
    color: #e9edef;
    font-weight: 600;
    margin-bottom: 5px;
}

.friend-request-time {
    font-size: 12px;
    color: #8696a0;
}

.friend-request-actions {
    display: flex;
    gap: 8px;
}

.request-action-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}

.request-action-btn.accept {
    background: #00a884;
    color: white;
}

.request-action-btn.accept:hover {
    background: #008f70;
}

.request-action-btn.reject {
    background: #2a3942;
    color: #e9edef;
    border: 1px solid #3a4952;
}

.request-action-btn.reject:hover {
    background: #3a4952;
}

/* Indicador de Pedidos Pendentes */
.tab-button.has-requests::after {
    content: '';
    width: 6px;
    height: 6px;
    background: #ff4444;
    border-radius: 50%;
    margin-left: 5px;
}

/* ========== ESTILOS ADICIONAIS (complementares) ========== */

/* Avatar para pedidos de amizade */
.friend-request-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7856e0, #248A52);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
}

/* Estado vazio para pedidos */
.empty-requests {
    text-align: center;
    padding: 40px 20px;
    color: #8696a0;
}

.empty-requests .empty-icon {
    font-size: 50px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Cabe√ßalho da guia de amigos */
.friends-header {
    padding: 15px;
    border-bottom: 1px solid #2a3942;
    background: #202c33;
}

.view-requests-btn {
    background: #00a884;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.view-requests-btn:hover {
    background: #008f70;
}

/* Modal de pedidos de amizade */
#friend-requests-modal .modal-content {
    max-width: 500px;
}

/* Estilos para o modal de exclus√£o de conta */
#delete-account-btn {
    color: #dc3545 !important;
    transition: all 0.3s ease;
}

#delete-account-btn:hover {
    background: #dc3545 !important;
    color: white !important;
    transform: scale(1.1);
}

#confirm-delete-account:disabled {
    background: #6c757d !important;
    cursor: not-allowed;
    opacity: 0.6;
}

#confirm-delete-account:not(:disabled):hover {
    background: #c82333 !important;
    transform: translateY(-2px);
}

/* Menu de Contexto para Conversas */
.context-menu {
    animation: fadeIn 0.2s ease-in;
}

.context-menu-item:hover {
    background: #3a4952 !important;
}

.context-menu-item[data-action="delete"]:hover {
    background: #dc3545 !important;
    color: white !important;
}

/* Indicador visual para grupos que podem ser exclu√≠dos */
.conversation-item[data-conversa-type="group"]:not([data-chat-id="general"]):hover {
    background: #2a3942;
    cursor: context-menu;
}

/* Feedback visual durante a exclus√£o */
.conversation-item.deleting {
    opacity: 0.5;
    background: rgba(220, 53, 69, 0.1) !important;
    transition: all 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

portal.css:

/* app/static/css/portal.css (CORRIGIDO) */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #044f48, #2a7561);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.portal-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 400px;
    backdrop-filter: blur(10px);
}

.portal-header {
    text-align: center;
    margin-bottom: 30px;
}

.portal-header h1 {
    color: #044f48;
    margin-bottom: 10px;
    font-size: 2.5em;
}

.portal-header p {
    color: #666;
    font-size: 1.1em;
}

.auth-forms {
    margin-bottom: 20px;
}

.form-container h2 {
    color: #044f48;
    margin-bottom: 20px;
    text-align: center;
}

.form-group {
    margin-bottom: 20px;
    position: relative;
}

.form-group input {
    width: 100%;
    padding: 15px;
    border: 2px solid #e1e1e1;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.3s;
    background: #fff;
}

.form-group input:focus {
    outline: none;
    border-color: #044f48;
}

/* Estilos espec√≠ficos para grupos de senha - CORRIGIDO */
.password-group {
    position: relative;
    display: flex;
    align-items: center;
}

.password-group input {
    flex: 1;
    padding-right: 50px; /* Espa√ßo para o bot√£o do olho */
    width: 100%;
}

.toggle-password {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.2s ease;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
}

.toggle-password:hover {
    background-color: rgba(4, 79, 72, 0.1);
}

.toggle-password:active {
    background-color: rgba(4, 79, 72, 0.2);
    transform: translateY(-50%) scale(0.95);
}

.eye-icon {
    font-size: 16px;
    transition: all 0.2s ease;
    display: inline-block;
}

.toggle-password.active .eye-icon {
    color: #044f48;
    transform: scale(1.1);
}

/* Estado quando a senha est√° vis√≠vel */
.password-visible .eye-icon {
    color: #044f48;
}

.btn-primary {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #044f48, #2a7561);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(4, 79, 72, 0.3);
}

.btn-primary:active {
    transform: translateY(0);
}

.switch-form {
    text-align: center;
    margin-top: 20px;
    color: #666;
}

.switch-form a {
    color: #044f48;
    text-decoration: none;
    font-weight: 600;
}

.switch-form a:hover {
    text-decoration: underline;
}

.message-container {
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    font-weight: 500;
    display: none; /* Inicialmente escondido */
}

.message-container.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block; /* Mostrar quando tiver esta classe */
}

.message-container.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.message-container.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
    display: block;
}

/* Anima√ß√µes */
.form-container {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsividade */
@media (max-width: 480px) {
    .portal-container {
        padding: 30px 20px;
        margin: 20px;
    }
    
    .portal-header h1 {
        font-size: 2em;
    }
    
    .form-group input {
        padding: 12px;
        padding-right: 45px;
    }
    
    .toggle-password {
        width: 32px;
        height: 32px;
        right: 10px;
        padding: 6px;
    }
    
    .eye-icon {
        font-size: 14px;
    }
}

/* Requisitos de senha */
.password-requirements {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e1e1e1;
    border-radius: 8px;
    padding: 12px;
    margin-top: 5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
    display: none;
    font-size: 12px;
}

.requirement {
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.requirement.valid {
    color: #155724;
}

.requirement.invalid {
    color: #721c24;
}

/* Indicador de for√ßa da senha */
.password-strength {
    margin-top: 8px;
    height: 4px;
    border-radius: 2px;
    background: #e1e1e1;
    overflow: hidden;
}

.strength-bar {
    height: 100%;
    width: 0%;
    transition: all 0.3s ease;
}

.strength-weak { background: #dc3545; width: 25%; }
.strength-medium { background: #ffc107; width: 50%; }
.strength-good { background: #28a745; width: 75%; }
.strength-strong { background: #20c997; width: 100%; }

Chat_Online/app/static/js/:

chat-integrated.js:

// static/js/chat-integrated.js
class IntegratedChat {
    constructor() {
        this.lastSince = '';
        this.username = '';
        this.pendingMessageId = null;
        this.seenMessageIds = new Set();
        this.currentChat = null;
        this.chatHistory = {};
        this.pollInterval = null;
        
        // Vari√°veis para controle de m√≠dia
        this.selectedImageFile = null;
        this.imageFullscreenModal = null;
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.audioBlob = null;
        this.recordingInterval = null;
        this.recordingTime = 0;
        
        this.initialize();
    }

    async initialize() {
        console.log('üöÄ Inicializando Chat Integrado...');
        await this.loadUserInfo();
        this.initializeElements();
        this.initializeEventListeners();
        this.enableMessageEditing();
        console.log('‚úÖ Chat integrado inicializado para:', this.username);
    }

    async loadUserInfo() {
        try {
            console.log('üîê Buscando informa√ß√µes do usu√°rio...');
            const response = await fetch('/user-info');
            const data = await response.json();
            
            if (data.error) {
                console.error('‚ùå Usu√°rio n√£o autenticado:', data.error);
                window.location.href = '/portal';
                return;
            }
            
            this.username = data.username;
            console.log('‚úÖ Usu√°rio da sess√£o:', this.username);
        } catch (error) {
            console.error('üí• Erro ao carregar user-info:', error);
            window.location.href = '/portal';
        }
    }

    initializeElements() {
        console.log('üîß Inicializando elementos do chat integrado...');
        
        // Elementos principais
        this.messagesDiv = document.getElementById('messages');
        this.onlineUl = document.getElementById('online-list');
        this.input = document.getElementById('msg-input');
        this.sendBtn = document.getElementById('send-btn');
        this.chatTitle = document.getElementById('chat-title');
        this.chatInfo = document.getElementById('chat-info');
        this.backToListBtn = document.getElementById('back-to-list');
        this.activeChat = document.getElementById('active-chat');
        this.welcomeState = document.getElementById('welcome-chat-state');
        
        // Elementos de m√≠dia
        this.attachBtn = document.getElementById('attach-btn');
        this.recordBtn = document.getElementById('record-btn');
        this.emojiBtn = document.getElementById('emoji-btn');
        this.fileInput = document.getElementById('file-input');
        
        // Modais
        this.emojiModal = document.getElementById('emoji-modal');
        this.emojiSearch = document.getElementById('emoji-search');
        this.emojiGrid = document.getElementById('emoji-grid');
        this.emojiCount = document.getElementById('emoji-count');
        this.closeEmojiModal = document.getElementById('close-emoji-modal');
        
        this.imagePreviewModal = document.getElementById('image-preview-modal');
        this.previewImage = document.getElementById('preview-image');
        this.closePreviewModal = document.getElementById('close-preview-modal');
        this.cancelPreview = document.getElementById('cancel-preview');
        this.sendImageBtn = document.getElementById('send-image');
        
        this.audioRecordModal = document.getElementById('audio-record-modal');
        this.closeAudioModal = document.getElementById('close-audio-modal');
        this.cancelAudio = document.getElementById('cancel-audio');
        this.startRecordBtn = document.getElementById('start-record-btn');
        this.stopRecordBtn = document.getElementById('stop-record-btn');
        this.sendAudioBtn = document.getElementById('send-audio');
        this.audioPreview = document.getElementById('audio-preview');
        this.audioRecordTimer = document.getElementById('audio-record-timer');
        this.audioRecordVisualizer = document.getElementById('audio-record-visualizer');

        console.log('‚úÖ Elementos inicializados:', {
            messagesDiv: !!this.messagesDiv,
            input: !!this.input,
            sendBtn: !!this.sendBtn,
            activeChat: !!this.activeChat,
            welcomeState: !!this.welcomeState
        });
    }

    initializeEventListeners() {
        console.log('üéØ Configurando event listeners...');
        
        // Event listeners b√°sicos
        if (this.sendBtn) {
            this.sendBtn.addEventListener('click', () => this.send());
        }
        
        if (this.input) {
            this.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.send();
            });
        }

        if (this.backToListBtn) {
            this.backToListBtn.addEventListener('click', () => this.showConversationList());
        }

        // Event listeners de m√≠dia
        if (this.attachBtn) {
            this.attachBtn.addEventListener('click', () => this.fileInput?.click());
        }
        
        if (this.fileInput) {
            this.fileInput.addEventListener('change', (e) => this.handleImageSelect(e));
        }

        if (this.recordBtn) {
            this.recordBtn.addEventListener('click', () => this.showAudioModal());
        }

        // Inicializar modais
        this.initializeModals();
        
        console.log('‚úÖ Event listeners configurados');
    }

    initializeModals() {
        console.log('üé™ Inicializando modais...');
        
        // Emoji modal
        if (this.emojiBtn && this.emojiModal) {
            this.emojiBtn.addEventListener('click', () => this.showEmojiModal());
        }
        
        if (this.closeEmojiModal) {
            this.closeEmojiModal.addEventListener('click', () => this.closeEmojiModalFunc());
        }
        
        if (this.emojiModal) {
            this.emojiModal.addEventListener('click', (e) => {
                if (e.target === this.emojiModal) this.closeEmojiModalFunc();
            });
        }
        
        if (this.emojiSearch) {
            this.emojiSearch.addEventListener('input', (e) => this.injectEmojis(e.target.value));
        }

        // Image preview modal
        if (this.closePreviewModal) {
            this.closePreviewModal.addEventListener('click', () => this.closeImagePreview());
        }
        
        if (this.cancelPreview) {
            this.cancelPreview.addEventListener('click', () => this.closeImagePreview());
        }
        
        if (this.sendImageBtn) {
            this.sendImageBtn.addEventListener('click', () => this.sendImage());
        }
        
        if (this.imagePreviewModal) {
            this.imagePreviewModal.addEventListener('click', (e) => {
                if (e.target === this.imagePreviewModal) this.closeImagePreview();
            });
        }

        // Audio record modal
        if (this.closeAudioModal) {
            this.closeAudioModal.addEventListener('click', () => this.closeAudioModalFunc());
        }
        
        if (this.cancelAudio) {
            this.cancelAudio.addEventListener('click', () => this.closeAudioModalFunc());
        }
        
        if (this.startRecordBtn) {
            this.startRecordBtn.addEventListener('click', () => this.startRecording());
        }
        
        if (this.stopRecordBtn) {
            this.stopRecordBtn.addEventListener('click', () => this.stopRecording());
        }
        
        if (this.sendAudioBtn) {
            this.sendAudioBtn.addEventListener('click', () => this.sendAudio());
        }
        
        if (this.audioRecordModal) {
            this.audioRecordModal.addEventListener('click', (e) => {
                if (e.target === this.audioRecordModal) this.closeAudioModalFunc();
            });
        }

        // Fechar modais com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (this.emojiModal?.style.display === 'flex') this.closeEmojiModalFunc();
                if (this.imagePreviewModal?.style.display === 'flex') this.closeImagePreview();
                if (this.audioRecordModal?.style.display === 'flex') this.closeAudioModalFunc();
                if (this.imageFullscreenModal?.style.display === 'flex') this.closeImageFullscreen();
            }
        });

        console.log('‚úÖ Modais inicializados');
    }

    openChat(chatId, chatType, chatName, participants = []) {
        console.log(`üí¨ [OPEN_CHAT] Abrindo chat: ${chatName} (${chatType}) ID: ${chatId}`);
        
        this.currentChat = {
            id: chatId,
            type: chatType,
            name: chatName,
            participants: participants
        };

        // ‚úÖ INICIALIZAR HIST√ìRICO CORRETAMENTE
        if (!this.chatHistory[chatId]) {
            this.chatHistory[chatId] = { messages: [], lastSince: '' };
        }

        // Mostrar chat ativo
        if (this.activeChat) this.activeChat.style.display = 'flex';
        if (this.welcomeState) this.welcomeState.style.display = 'none';

        // Atualizar interface
        this.updateChatHeader();
        
        // Carregar mensagens
        this.loadChatMessages();
        
        // Iniciar polling
        this.startPolling();

        console.log('‚úÖ [OPEN_CHAT] Chat aberto:', this.currentChat);
        
        // ‚úÖ LOG ESPECIAL PARA GRUPOS
        if (chatType === 'group' && chatId !== 'general') {
            console.log(`üéØ [OPEN_CHAT] GRUPO IDENTIFICADO - conversa_id: ${chatId}`);
            console.log(`üìù [OPEN_CHAT] As mensagens enviadas aqui devem usar conversa_id: ${chatId}`);
        }
    }

    showConversationList() {
        console.log('üìã Voltando para lista de conversas');
        
        if (this.activeChat) this.activeChat.style.display = 'none';
        if (this.welcomeState) this.welcomeState.style.display = 'flex';
        this.currentChat = null;
        this.stopPolling();
        
        // Limpar √°rea de mensagens
        if (this.messagesDiv) this.messagesDiv.innerHTML = '';
        
        // Limpar input
        if (this.input) this.input.value = '';
    }

    updateChatHeader() {
        if (!this.currentChat) return;
        
        console.log('üè∑Ô∏è Atualizando header do chat:', this.currentChat);
        
        if (this.chatTitle) {
            this.chatTitle.textContent = this.currentChat.name;
        }
        
        if (this.chatInfo) {
            if (this.currentChat.type === 'group') {
                this.chatInfo.textContent = `Grupo ‚Ä¢ ${this.currentChat.participants.length} participantes`;
            } else if (this.currentChat.type === 'private') {
                this.chatInfo.textContent = 'Chat privado';
            } else {
                this.chatInfo.textContent = 'Chat p√∫blico';
            }
        }
    }

    loadChatMessages() {
        if (!this.messagesDiv || !this.currentChat) return;
        
        console.log('üì® Carregando mensagens do chat:', this.currentChat.id);
        
        // Limpar mensagens atuais
        this.messagesDiv.innerHTML = '';
        
        // Carregar mensagens do hist√≥rico local
        const chatData = this.chatHistory[this.currentChat.id];
        if (chatData && chatData.messages.length > 0) {
            chatData.messages.forEach(msg => {
                this.appendMessage(msg);
            });
            this.scrollToBottom();
        }
        
        // Iniciar polling para este chat espec√≠fico
        this.lastSince = chatData?.lastSince || '';
    }

    startPolling() {
        this.stopPolling();
        this.pollInterval = setInterval(() => this.poll(), 1000);
        console.log('üîÑ Polling iniciado para chat:', this.currentChat?.id);
    }

    stopPolling() {
        if (this.pollInterval) {
            clearInterval(this.pollInterval);
            this.pollInterval = null;
            console.log('üõë Polling parado');
        }
    }

    async poll() {
        if (!this.username || !this.currentChat) return;
        
        let url = `/messages?chat=${encodeURIComponent(this.currentChat.id)}&type=${encodeURIComponent(this.currentChat.type)}`;
        if (this.lastSince) url += `&since=${encodeURIComponent(this.lastSince)}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            let newMsgs = 0;
            data.messages.forEach(msg => {
                if (msg.chat_id !== this.currentChat.id) return;
                
                if (this.seenMessageIds.has(msg.id) || (this.pendingMessageId && msg.id === this.pendingMessageId)) {
                    return;
                }
                
                this.appendMessage(msg);
                this.seenMessageIds.add(msg.id);
                newMsgs++;
                
                // Salvar no hist√≥rico local
                if (!this.chatHistory[this.currentChat.id].messages.some(m => m.id === msg.id)) {
                    this.chatHistory[this.currentChat.id].messages.push(msg);
                }
            });
            
            this.updateOnline(data.online);
            
            if (newMsgs > 0) {
                this.lastSince = data.messages[data.messages.length - 1].timestamp;
                this.chatHistory[this.currentChat.id].lastSince = this.lastSince;
                
                if (newMsgs === 1) {
                    console.log(`üì© Nova mensagem recebida no chat ${this.currentChat.id}`);
                } else {
                    console.log(`üì© ${newMsgs} novas mensagens recebidas no chat ${this.currentChat.id}`);
                }
            }
        } catch (err) {
            console.error('‚ùå Erro no poll:', err);
        }
    }

    async send() {
        let content = this.input?.value.trim();
        if (!content || !this.username || !this.currentChat) {
            console.log('‚ö†Ô∏è N√£o √© poss√≠vel enviar mensagem: conte√∫do vazio ou chat n√£o selecionado');
            return;
        }
        
        this.input.value = '';

        // ‚úÖ DETERMINAR CONVERSA_ID - VERS√ÉO CORRIGIDA
        let conversaId = null;
        
        console.log('üîç [SEND] Analisando currentChat:', {
            id: this.currentChat.id,
            type: this.currentChat.type, 
            name: this.currentChat.name
        });

        // ‚úÖ REGRA CLARA: Grupos (exceto Chat Geral) usam conversa_id
        if (this.currentChat.type === 'group' && this.currentChat.id !== 'general') {
            // ‚úÖ CONVERTER PARA N√öMERO (IMPORTANTE!)
            conversaId = parseInt(this.currentChat.id);
            console.log(`üéØ [SEND] GRUPO IDENTIFICADO - conversa_id: ${conversaId} (tipo: ${typeof conversaId})`);
        } else {
            console.log(`üéØ [SEND] ${this.currentChat.id === 'general' ? 'Chat Geral' : 'Chat Privado'} - SEM conversa_id`);
        }

        const approxIso = new Date().toISOString();
        const tempMsgId = 'txt-' + Date.now();
        const tempMsg = {
            id: tempMsgId, 
            nome: this.username, 
            conteudo: content, 
            timestamp: approxIso,
            isTemp: true,
            chat_id: this.currentChat.id,
            chat_type: this.currentChat.type
        };
        
        this.seenMessageIds.add(tempMsgId);
        this.appendMessage(tempMsg, true);

        // Mostrar loading no bot√£o
        if (this.sendBtn) {
            this.sendBtn.classList.add('sending');
            this.sendBtn.disabled = true;
        }

        try {
            // ‚úÖ MONTAR DADOS - VERS√ÉO CORRIGIDA
            const requestData = {
                content: content,
                type: 'texto', // ‚úÖ ADICIONAR TYPE EXPL√çCITO
                chat_id: this.currentChat.id,
                chat_type: this.currentChat.type,
                participants: this.currentChat.participants || []
            };

            // ‚úÖ ADICIONAR CONVERSA_ID APENAS PARA GRUPOS
            if (conversaId) {
                requestData.conversa_id = conversaId;
                console.log(`üì§ [SEND] ENVIANDO COM conversa_id: ${conversaId} (tipo: ${typeof conversaId})`);
            } else {
                console.log(`üì§ [SEND] ENVIANDO SEM conversa_id`);
            }

            console.log('üöÄ [SEND] Dados completos enviados:', requestData);

            const response = await fetch('/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            // Remover loading do bot√£o
            if (this.sendBtn) {
                this.sendBtn.classList.remove('sending');
                this.sendBtn.disabled = false;
            }

            if (data.id && data.timestamp) {
                console.log('‚úÖ [SEND] Mensagem confirmada:', data.id);
                
                this.lastSince = data.timestamp;
                this.pendingMessageId = data.id;
                this.seenMessageIds.add(data.id);
                
                this.updateTempMessage(tempMsgId, data);
                
                if (!this.chatHistory[this.currentChat.id].messages.some(m => m.id === data.id)) {
                    this.chatHistory[this.currentChat.id].messages.push(data);
                }
                
                // ‚úÖ FOR√áAR ATUALIZA√á√ÉO DA LISTA DE CONVERSAS AP√ìS ENVIAR MENSAGEM
                setTimeout(() => {
                    if (window.loadConversations) {
                        console.log('üîÑ [SEND] Atualizando lista de conversas...');
                        window.loadConversations();
                    }
                }, 1000);
                
            } else if (data.error) {
                console.error('‚ùå [SEND] Erro:', data.error);
                this.markMessageAsFailed(tempMsgId);
                this.pendingMessageId = null;
                this.seenMessageIds.delete(tempMsgId);
            }
        } catch (err) {
            console.error('‚ùå [SEND] Erro na requisi√ß√£o:', err);
            if (this.sendBtn) {
                this.sendBtn.classList.remove('sending');
                this.sendBtn.disabled = false;
            }
            this.markMessageAsFailed(tempMsgId);
            this.pendingMessageId = null;
            this.seenMessageIds.delete(tempMsgId);
        }
    }

    appendMessage(msg, isSelf = false) {
        if (!this.messagesDiv) return;
        
        // Verifica√ß√£o extra: N√ÉO ADICIONAR SE J√Å EXISTIR
        const existingMessage = this.messagesDiv.querySelector(`[data-message-id="${msg.id}"]`) || 
                               this.messagesDiv.querySelector(`[data-temp-id="${msg.id}"]`);
        if (existingMessage) {
            return;
        }
        
        const isSelfMsg = isSelf || msg.nome === this.username;
        const div = document.createElement('div');
        div.classList.add('message');
        if (isSelfMsg) {
            div.classList.add('self');
        } else {
            div.classList.add('other');
        }
        
        // Adicionar ID tempor√°rio se for uma mensagem tempor√°ria
        if (msg.isTemp && msg.id) {
            div.dataset.tempId = msg.id;
            div.classList.add('temp');
        } else if (msg.id) {
            div.dataset.messageId = msg.id;
        }

        let contentHTML = '';

        // Verificar pelo campo 'type'
        if (msg.type === 'imagem' && msg.image_filename) {
            const imageUrl = `/uploads/images/${msg.image_filename}`;
            contentHTML = `
                <div class="message-image-container">
                    <img src="${imageUrl}" alt="Imagem enviada" class="message-image" onclick="window.integratedChat.openImageFullscreen('${imageUrl}')">
                    <div class="message-image-caption">Imagem enviada</div>
                </div>
            `;
        } else if (msg.type === 'audio' && msg.audio_filename) {
            const audioUrl = `/uploads/audios/${msg.audio_filename}`;
            contentHTML = `
                <div class="message-audio">
                    <audio controls src="${audioUrl}"></audio>
                    <div class="message-audio-caption">√Åudio ${msg.audio_duration ? `- ${msg.audio_duration}s` : ''}</div>
                </div>
            `;
        } else if (msg.isTemp) {
            contentHTML = `
                <div class="message-content">
                    <span class="image-loading"></span>${msg.conteudo}
                </div>
            `;
        } else {
            contentHTML = `<div class="message-content">${msg.conteudo}</div>`;
        }

        // Para mensagens pr√≥prias: nome ‚Üí conte√∫do ‚Üí timestamp (√† direita)
        // Para mensagens de outros: timestamp ‚Üí nome ‚Üí conte√∫do (timestamp √† esquerda)
        if (isSelfMsg) {
            div.innerHTML = `
                <div class="message-header">
                    <strong>${msg.nome}</strong>
                    <span class="timestamp">${this.formatTime(msg.timestamp)}</span>
                </div>
                ${contentHTML}
            `;
        } else {
            div.innerHTML = `
                <div class="message-header">
                    <span class="timestamp">${this.formatTime(msg.timestamp)}</span>
                    <strong>${msg.nome}</strong>
                </div>
                ${contentHTML}
            `;
        }
        
        this.messagesDiv.appendChild(div);
        this.scrollToBottom();
    }

    enableMessageEditing() {
        console.log('üîß Habilitando edi√ß√£o de mensagens...');
        
        // Event listener para clicar em mensagens pr√≥prias
        if (this.messagesDiv) {
            this.messagesDiv.addEventListener('click', (e) => {
                const messageElement = e.target.closest('.message.self');
                if (messageElement && !messageElement.classList.contains('has-actions')) {
                    this.showMessageActions(messageElement);
                }
            });
        }
    }

    showMessageActions(messageElement) {
        const messageId = messageElement.dataset.messageId || messageElement.dataset.tempId;
        const currentContent = messageElement.querySelector('.message-content')?.textContent || '';
        
        if (!messageId) return;
        
        // Criar menu de a√ß√µes
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        actionsDiv.innerHTML = `
            <button class="edit-btn" onclick="window.integratedChat.startEditMessage('${messageId}', '${this.escapeHtml(currentContent)}')">
                ‚úèÔ∏è Editar
            </button>
            <button class="delete-btn" onclick="window.integratedChat.deleteMessage('${messageId}')">
                üóëÔ∏è Excluir
            </button>
        `;
        
        messageElement.appendChild(actionsDiv);
        messageElement.classList.add('has-actions');
        
        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
            if (actionsDiv.parentNode === messageElement) {
                actionsDiv.remove();
                messageElement.classList.remove('has-actions');
            }
        }, 5000);
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async startEditMessage(messageId, currentContent) {
        console.log('‚úèÔ∏è Iniciando edi√ß√£o da mensagem:', messageId);
        
        const newContent = prompt('Editar mensagem:', currentContent);
        if (newContent && newContent !== currentContent) {
            await this.editMessage(messageId, newContent);
        }
        
        // Remover menu de a√ß√µes
        this.removeMessageActions();
    }

    async editMessage(messageId, newContent) {
        try {
            console.log('üì§ Enviando edi√ß√£o para servidor...');
            
            const response = await fetch('/edit-message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message_id: parseInt(messageId),
                    content: newContent
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('‚úÖ Mensagem editada com sucesso');
                this.updateMessageInUI(messageId, newContent, true);
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (error) {
            console.error('‚ùå Erro ao editar mensagem:', error);
            alert('Erro de conex√£o ao editar mensagem.');
        }
    }

    async deleteMessage(messageId) {
        console.log('üóëÔ∏è Solicitando exclus√£o da mensagem:', messageId);
        
        if (confirm('Tem certeza que deseja excluir esta mensagem?')) {
            try {
                const response = await fetch('/delete-message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message_id: parseInt(messageId) 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Mensagem exclu√≠da com sucesso');
                    this.removeMessageFromUI(messageId);
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                console.error('‚ùå Erro ao excluir mensagem:', error);
                alert('Erro de conex√£o ao excluir mensagem.');
            }
        }
    }

    updateMessageInUI(messageId, newContent, isEdited = false) {
        const messageElement = this.messagesDiv.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            const contentElement = messageElement.querySelector('.message-content');
            if (contentElement) {
                contentElement.textContent = newContent;
                
                // Adicionar indicador de edi√ß√£o
                if (isEdited) {
                    let editIndicator = messageElement.querySelector('.edit-indicator');
                    if (!editIndicator) {
                        editIndicator = document.createElement('span');
                        editIndicator.className = 'edit-indicator';
                        editIndicator.textContent = ' (editado)';
                        editIndicator.style.fontSize = '0.8em';
                        editIndicator.style.color = 'rgba(255, 255, 255, 0.6)';
                        editIndicator.style.marginLeft = '5px';
                        contentElement.appendChild(editIndicator);
                    }
                }
            }
        }
    }

    removeMessageFromUI(messageId) {
        const messageElement = this.messagesDiv.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.style.opacity = '0';
            messageElement.style.maxHeight = '0';
            messageElement.style.marginBottom = '0';
            messageElement.style.overflow = 'hidden';
            messageElement.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                messageElement.remove();
            }, 300);
        }
    }

    removeMessageActions() {
        document.querySelectorAll('.message-actions').forEach(actions => {
            actions.remove();
        });
        document.querySelectorAll('.message').forEach(msg => {
            msg.classList.remove('has-actions');
        });
    }

    updateOnline(list) {
        if (!this.onlineUl) return;
        this.onlineUl.innerHTML = '';
        list.forEach(nome => {
            const li = document.createElement('li');
            li.textContent = nome + (nome === this.username ? ' (voc√™)' : '');
            this.onlineUl.appendChild(li);
        });
    }

    scrollToBottom() {
        if (!this.messagesDiv) return;
        this.messagesDiv.scrollTo({
            top: this.messagesDiv.scrollHeight,
            behavior: 'smooth'
        });
    }

    formatTime(iso) {
        const date = new Date(iso);
        return date.toTimeString().substring(0, 5);
    }

    // ========== EMOJIS ==========
    showEmojiModal() {
        if (!this.emojiModal) return;
        
        this.emojiModal.style.display = 'flex';
        if (this.emojiSearch) {
            this.emojiSearch.value = '';
        }
        this.injectEmojis('');
        setTimeout(() => {
            if (this.emojiSearch) {
                this.emojiSearch.focus();
            }
        }, 100);
    }

    closeEmojiModalFunc() {
        if (this.emojiModal) {
            this.emojiModal.style.display = 'none';
        }
        if (this.emojiSearch) {
            this.emojiSearch.value = '';
        }
    }

    injectEmojis(searchTerm = '') {
        if (!this.emojiGrid) return;
        
        this.emojiGrid.innerHTML = '';
        
        const term = searchTerm.toLowerCase().trim();
        const filteredEmojis = this.getEmojisWithNames().filter(item => 
            item.name.toLowerCase().includes(term) || 
            item.emoji.includes(term)
        );
        
        if (filteredEmojis.length === 0) {
            const noResults = document.createElement('div');
            noResults.classList.add('no-results');
            noResults.textContent = 'Nenhum emoji encontrado';
            this.emojiGrid.appendChild(noResults);
        } else {
            filteredEmojis.forEach(item => {
                const btn = document.createElement('button');
                btn.classList.add('emoji-btn');
                btn.textContent = item.emoji;
                btn.type = 'button';
                btn.title = item.name;
                btn.addEventListener('click', () => {
                    if (this.input) {
                        this.input.value += item.emoji;
                        this.input.focus();
                    }
                    this.closeEmojiModalFunc();
                });
                this.emojiGrid.appendChild(btn);
            });
        }
        
        if (this.emojiCount) {
            this.emojiCount.textContent = `${filteredEmojis.length} emojis${term ? ' encontrados' : ' no total'}`;
        }
    }

    getEmojisWithNames() {
        return [
            // Smileys & Emotion
            { emoji: 'üòÄ', name: 'sorriso' }, { emoji: 'üòÉ', name: 'sorriso grande' }, { emoji: 'üòÑ', name: 'sorriso olhos felizes' },
            { emoji: 'üòÅ', name: 'sorriso com olhos brilhantes' }, { emoji: 'üòÜ', name: 'sorriso fechado olhos' }, { emoji: 'üòÖ', name: 'suando sorriso' },
            { emoji: 'üòÇ', name: 'chorando de rir' }, { emoji: 'ü§£', name: 'rolando de rir' }, { emoji: 'üòä', name: 'sorriso t√≠mido' },
            { emoji: 'üòá', name: 'sorriso angelical' }, { emoji: 'üôÇ', name: 'sorriso suave' }, { emoji: 'üôÉ', name: 'cabe√ßa para baixo' },
            { emoji: 'üòâ', name: 'piscar' }, { emoji: 'üòå', name: 'aliviado' }, { emoji: 'üòç', name: 'apaixonado' },
            { emoji: 'ü•∞', name: 'sorriso com cora√ß√µes' }, { emoji: 'üòò', name: 'beijo' }, { emoji: 'üòó', name: 'beijando' },
            { emoji: 'üòô', name: 'beijo com olhos felizes' }, { emoji: 'üòö', name: 'beijo com olhos fechados' }, { emoji: 'üòã', name: 'saboroso' },
            { emoji: 'üòõ', name: 'l√≠ngua para fora' }, { emoji: 'üòù', name: 'l√≠ngua olhos fechados' }, { emoji: 'üòú', name: 'piscar com l√≠ngua' },
            { emoji: 'ü§™', name: 'maluco' }, { emoji: 'ü§®', name: 'sobrancelha levantada' }, { emoji: 'üßê', name: 'mon√≥culo' },
            { emoji: 'ü§ì', name: 'nerd' }, { emoji: 'üòé', name: 'descolado' }, { emoji: 'ü§©', name: 'estrelas nos olhos' },
            { emoji: 'ü•≥', name: 'festa' }, { emoji: 'üòè', name: 'smirk' }, { emoji: 'üòí', name: 'entediado' },
            { emoji: 'üòû', name: 'decepcionado' }, { emoji: 'üòî', name: 'abatido' }, { emoji: 'üòü', name: 'preocupado' },
            { emoji: 'üòï', name: 'confuso' }, { emoji: 'üôÅ', name: 'levemente triste' }, { emoji: '‚òπÔ∏è', name: 'triste' },
            { emoji: 'üò£', name: 'sofrendo' }, { emoji: 'üòñ', name: 'confuso' }, { emoji: 'üò´', name: 'cansado' },
            { emoji: 'üò©', name: 'exausto' }, { emoji: 'ü•∫', name: 'suplicante' }, { emoji: 'üò¢', name: 'chorando' },
            { emoji: 'üò≠', name: 'chorando muito' }, { emoji: 'üò§', name: 'triumfante' }, { emoji: 'üò†', name: 'zangado' },
            { emoji: 'üò°', name: 'furioso' }, { emoji: 'ü§¨', name: 'xingando' }, { emoji: 'üò≥', name: 'corado' },
            { emoji: 'ü•µ', name: 'calor' }, { emoji: 'ü•∂', name: 'frio' }, { emoji: 'üò±', name: 'gritando' },
            { emoji: 'üò®', name: 'amedrontado' }, { emoji: 'üò∞', name: 'ansioso' }, { emoji: 'üò•', name: 'decepcionado mas aliviado' },
            { emoji: 'üòì', name: 'suando frio' }, { emoji: 'ü§•', name: 'mentiroso' }, { emoji: 'ü§§', name: 'babando' },
            { emoji: 'üò∂', name: 'sem boca' }, { emoji: 'üòê', name: 'neutro' }, { emoji: 'üòë', name: 'sem express√£o' },
            { emoji: 'üò¨', name: 'envergonhado' }, { emoji: 'üôÑ', name: 'revirando olhos' }, { emoji: 'üòØ', name: 'sil√™ncio' },
            { emoji: 'üò¶', name: 'carrancudo' }, { emoji: 'üòß', name: 'angustiado' }, { emoji: 'üòÆ', name: 'boca aberta' },
            { emoji: 'üò≤', name: 'espantado' }, { emoji: 'ü•±', name: 'bocejando' }, { emoji: 'üò¥', name: 'dormindo' },
            { emoji: 'üò™', name: 'sonolento' }, { emoji: 'üòµ', name: 'tonto' }, { emoji: 'ü§Ø', name: 'explodindo' },
            { emoji: 'üò∑', name: 'm√°scara' }, { emoji: 'ü§í', name: 'term√¥metro' }, { emoji: 'ü§ï', name: 'cabe√ßa enfaixada' },
            { emoji: 'ü§¢', name: 'enjoado' },
            // Pessoas
            { emoji: 'üëã', name: 'acenando' }, { emoji: 'ü§ö', name: 'levantando m√£o' }, { emoji: 'üñêÔ∏è', name: 'm√£o aberta' },
            { emoji: '‚úã', name: 'm√£o levantada' }, { emoji: 'üññ', name: 'sauda√ß√µes vulcanas' }, { emoji: 'üëå', name: 'ok' },
            { emoji: 'ü§è', name: 'pin√ßa' }, { emoji: '‚úåÔ∏è', name: 'paz' }, { emoji: 'ü§û', name: 'dedos cruzados' },
            { emoji: 'ü§ü', name: 'eu te amo' }, { emoji: 'ü§ò', name: 'chifres' }, { emoji: 'ü§ô', name: 'me liga' },
            { emoji: 'üëà', name: 'apontar esquerda' }, { emoji: 'üëâ', name: 'apontar direita' }, { emoji: 'üëÜ', name: 'apontar cima' },
            { emoji: 'üñï', name: 'dedo m√©dio' }, { emoji: 'üëá', name: 'apontar baixo' }, { emoji: '‚òùÔ∏è', name: 'apontar para cima' },
            { emoji: 'üëç', name: 'joinha' }, { emoji: 'üëé', name: 'polegar baixo' }, { emoji: '‚úä', name: 'punho' },
            { emoji: 'üëä', name: 'soco' }, { emoji: 'ü§õ', name: 'punho esquerda' }, { emoji: 'ü§ú', name: 'punho direita' },
            { emoji: 'üëè', name: 'palmas' }, { emoji: 'üôå', name: 'm√£os para cima' }, { emoji: 'üëê', name: 'm√£os abertas' },
            { emoji: 'ü§≤', name: 'palmas juntas' }, { emoji: 'ü§ù', name: 'aperto de m√£os' }, { emoji: 'üôè', name: 'orar' },
            // Cora√ß√µes
            { emoji: '‚ù§Ô∏è', name: 'cora√ß√£o vermelho' }, { emoji: 'üß°', name: 'cora√ß√£o laranja' }, { emoji: 'üíõ', name: 'cora√ß√£o amarelo' },
            { emoji: 'üíö', name: 'cora√ß√£o verde' }, { emoji: 'üíô', name: 'cora√ß√£o azul' }, { emoji: 'üíú', name: 'cora√ß√£o roxo' },
            { emoji: 'üñ§', name: 'cora√ß√£o preto' }, { emoji: 'ü§ç', name: 'cora√ß√£o branco' }, { emoji: 'ü§é', name: 'cora√ß√£o marrom' },
            { emoji: 'üíî', name: 'cora√ß√£o partido' },
            // Animais
            { emoji: 'üêµ', name: 'macaco' }, { emoji: 'üê∂', name: 'cachorro' }, { emoji: 'üê±', name: 'gato' },
            { emoji: 'üê≠', name: 'rato' }, { emoji: 'üêπ', name: 'hamster' }, { emoji: 'üê∞', name: 'coelho' },
            { emoji: 'ü¶ä', name: 'raposa' }, { emoji: 'üêª', name: 'urso' }, { emoji: 'üêº', name: 'panda' },
            { emoji: 'üê®', name: 'coala' }, { emoji: 'üêØ', name: 'tigre' }, { emoji: 'ü¶Å', name: 'le√£o' },
            { emoji: 'üêÆ', name: 'vaca' }, { emoji: 'üê∑', name: 'porco' }, { emoji: 'üê∏', name: 'sapo' },
            { emoji: 'üêô', name: 'polvo' },
            // Comidas
            { emoji: 'üçé', name: 'ma√ß√£' }, { emoji: 'üçê', name: 'pera' }, { emoji: 'üçä', name: 'laranja' },
            { emoji: 'üçã', name: 'lim√£o' }, { emoji: 'üçå', name: 'banana' }, { emoji: 'üçâ', name: 'melancia' },
            { emoji: 'üçá', name: 'uva' }, { emoji: 'üçì', name: 'morango' }, { emoji: 'ü´ê', name: 'mirtilo' },
            { emoji: 'üçà', name: 'mel√£o' }, { emoji: 'üçí', name: 'cereja' }, { emoji: 'üçë', name: 'p√™ssego' },
            { emoji: 'ü•≠', name: 'manga' }, { emoji: 'üçç', name: 'abacaxi' }, { emoji: 'ü••', name: 'coco' },
            { emoji: 'ü•ë', name: 'abacate' }, { emoji: 'üçÜ', name: 'berinjela' }, { emoji: 'ü•î', name: 'batata' },
            { emoji: 'ü•ï', name: 'cenoura' }, { emoji: 'üåΩ', name: 'milho' }, { emoji: 'üå∂Ô∏è', name: 'pimenta' },
            { emoji: 'ü´ë', name: 'piment√£o' },
            // Objetos
            { emoji: '‚åö', name: 'rel√≥gio' }, { emoji: 'üì±', name: 'celular' }, { emoji: 'üíª', name: 'notebook' },
            { emoji: 'üñ•Ô∏è', name: 'computador' }, { emoji: 'üñ®Ô∏è', name: 'impressora' }, { emoji: 'üéÆ', name: 'videogame' },
            { emoji: 'üëæ', name: 'alien' },
            // S√≠mbolos
            { emoji: 'üíØ', name: 'cem pontos' }, { emoji: '‚ú®', name: 'brilho' }, { emoji: 'üéâ', name: 'festa' },
            { emoji: 'üéä', name: 'confete' }, { emoji: 'üî•', name: 'fogo' }, { emoji: 'üí•', name: 'explos√£o' },
            { emoji: '‚≠ê', name: 'estrela' }, { emoji: 'üåü', name: 'estrela brilhante' }, { emoji: 'üôà', name: 'n√£o vejo mal' },
            { emoji: 'üôâ', name: 'n√£o ou√ßo mal' }, { emoji: 'üôä', name: 'n√£o falo mal' }
        ];
    }

    // ========== IMAGENS ==========
    handleImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.match('image.*')) {
            alert('Por favor, selecione apenas arquivos de imagem.');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            alert('A imagem √© muito grande. Por favor, selecione uma imagem menor que 5MB.');
            return;
        }

        this.selectedImageFile = file;

        const reader = new FileReader();
        reader.onload = (e) => {
            if (this.previewImage) {
                this.previewImage.src = e.target.result;
            }
            if (this.imagePreviewModal) {
                this.imagePreviewModal.style.display = 'flex';
            }
        };
        reader.readAsDataURL(file);
    }

    closeImagePreview() {
        if (this.imagePreviewModal) {
            this.imagePreviewModal.style.display = 'none';
        }
        if (this.fileInput) {
            this.fileInput.value = '';
        }
        this.selectedImageFile = null;
    }

    sendImage() {
        if (!this.selectedImageFile || !this.username || !this.currentChat) {
            this.closeImagePreview();
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const imageData = e.target.result;
            
            const approxIso = new Date().toISOString();
            const tempMsgId = 'img-' + Date.now();
            const tempMsg = {
                id: tempMsgId, 
                nome: this.username, 
                conteudo: 'üì∑ Enviando imagem...', 
                timestamp: approxIso,
                type: 'imagem',
                isTemp: true
            };
            
            this.seenMessageIds.add(tempMsgId);
            this.appendMessage(tempMsg, true);
            
            fetch('/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content: 'Imagem',
                    type: 'imagem',
                    image_data: imageData,
                    chat_id: this.currentChat.id,
                    chat_type: this.currentChat.type
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                this.seenMessageIds.add(data.id);
                this.pendingMessageId = data.id;
                this.updateTempMessage(tempMsgId, data);
            })
            .catch(err => {
                console.error('‚ùå Erro ao enviar imagem:', err);
                this.updateTempMessageWithError(tempMsgId, err.message);
                this.seenMessageIds.delete(tempMsgId);
            });
            
            this.closeImagePreview();
        };
        reader.readAsDataURL(this.selectedImageFile);
    }

    openImageFullscreen(imageSrc) {
        if (!this.imageFullscreenModal) {
            this.imageFullscreenModal = document.getElementById('image-fullscreen-modal');
            if (!this.imageFullscreenModal) {
                this.imageFullscreenModal = document.createElement('div');
                this.imageFullscreenModal.id = 'image-fullscreen-modal';
                this.imageFullscreenModal.className = 'image-fullscreen-modal';
                this.imageFullscreenModal.innerHTML = `
                    <div class="image-fullscreen-content">
                        <img src="" alt="Imagem em tela cheia">
                    </div>
                `;
                document.body.appendChild(this.imageFullscreenModal);
                
                this.imageFullscreenModal.addEventListener('click', () => {
                    this.closeImageFullscreen();
                });
            }
        }
        
        const img = this.imageFullscreenModal.querySelector('img');
        img.src = imageSrc;
        this.imageFullscreenModal.style.display = 'flex';
    }

    closeImageFullscreen() {
        if (this.imageFullscreenModal) {
            this.imageFullscreenModal.style.display = 'none';
        }
    }

    // ========== √ÅUDIO ==========
    showAudioModal() {
        if (this.audioRecordModal) {
            this.audioRecordModal.style.display = 'flex';
            this.resetAudioRecording();
        }
    }

    closeAudioModalFunc() {
        if (this.audioRecordModal) {
            this.audioRecordModal.style.display = 'none';
        }
        this.resetAudioRecording();
    }

    resetAudioRecording() {
        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
            this.mediaRecorder.stop();
        }
        
        this.audioChunks = [];
        this.audioBlob = null;
        this.recordingTime = 0;
        
        if (this.audioRecordTimer) {
            this.audioRecordTimer.textContent = '00:00';
        }
        
        if (this.audioRecordVisualizer) {
            this.audioRecordVisualizer.innerHTML = 'Clique em "Iniciar Grava√ß√£o"';
            this.audioRecordVisualizer.style.background = 'rgba(0, 0, 0, 0.2)';
        }
        
        if (this.startRecordBtn) this.startRecordBtn.disabled = false;
        if (this.stopRecordBtn) this.stopRecordBtn.disabled = true;
        if (this.sendAudioBtn) this.sendAudioBtn.disabled = true;
        if (this.audioPreview) this.audioPreview.style.display = 'none';
        
        if (this.recordingInterval) {
            clearInterval(this.recordingInterval);
        }
    }

    startRecording() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Seu navegador n√£o suporta grava√ß√£o de √°udio.');
            return;
        }

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                this.mediaRecorder = new MediaRecorder(stream);
                this.audioChunks = [];

                this.mediaRecorder.ondataavailable = event => {
                    this.audioChunks.push(event.data);
                };

                this.mediaRecorder.onstop = () => {
                    this.audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(this.audioBlob);
                    const audioElement = this.audioPreview?.querySelector('audio');
                    if (audioElement) {
                        audioElement.src = audioUrl;
                    }
                    if (this.audioPreview) {
                        this.audioPreview.style.display = 'block';
                    }
                    if (this.sendAudioBtn) {
                        this.sendAudioBtn.disabled = false;
                    }
                };

                this.mediaRecorder.start();
                if (this.startRecordBtn) this.startRecordBtn.disabled = true;
                if (this.stopRecordBtn) this.stopRecordBtn.disabled = false;
                
                if (this.audioRecordVisualizer) {
                    this.audioRecordVisualizer.innerHTML = 'üé§ Gravando...';
                    this.audioRecordVisualizer.style.background = 'linear-gradient(120deg, #c9302c, #d9534f)';
                    this.audioRecordVisualizer.classList.add('recording-animation');
                }

                this.recordingTime = 0;
                this.recordingInterval = setInterval(() => {
                    this.recordingTime++;
                    const minutes = Math.floor(this.recordingTime / 60).toString().padStart(2, '0');
                    const seconds = (this.recordingTime % 60).toString().padStart(2, '0');
                    if (this.audioRecordTimer) {
                        this.audioRecordTimer.textContent = `${minutes}:${seconds}`;
                    }
                }, 1000);
            })
            .catch(err => {
                console.error('‚ùå Erro ao acessar microfone:', err);
                alert('Erro ao acessar o microfone. Verifique as permiss√µes.');
            });
    }

    stopRecording() {
        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
            this.mediaRecorder.stop();
            this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            if (this.startRecordBtn) this.startRecordBtn.disabled = false;
            if (this.stopRecordBtn) this.stopRecordBtn.disabled = true;
            
            if (this.audioRecordVisualizer) {
                this.audioRecordVisualizer.innerHTML = '‚úÖ Grava√ß√£o conclu√≠da';
                this.audioRecordVisualizer.style.background = 'linear-gradient(120deg, #248A52, #257287)';
                this.audioRecordVisualizer.classList.remove('recording-animation');
            }
            
            if (this.recordingInterval) {
                clearInterval(this.recordingInterval);
            }
        }
    }

    sendAudio() {
        if (!this.audioBlob || !this.username || !this.currentChat) {
            this.closeAudioModalFunc();
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const audioData = e.target.result;
            
            const approxIso = new Date().toISOString();
            const tempMsgId = 'audio-' + Date.now();
            const tempMsg = {
                id: tempMsgId, 
                nome: this.username, 
                conteudo: 'üé§ √Åudio...', 
                timestamp: approxIso,
                type: 'audio',
                isTemp: true
            };
            
            this.seenMessageIds.add(tempMsgId);
            this.appendMessage(tempMsg, true);
            
            fetch('/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content: '√Åudio',
                    type: 'audio',
                    audio_data: audioData,
                    audio_duration: this.recordingTime,
                    chat_id: this.currentChat.id,
                    chat_type: this.currentChat.type
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                this.seenMessageIds.add(data.id);
                this.pendingMessageId = data.id;
                this.updateTempMessage(tempMsgId, data);
            })
            .catch(err => {
                console.error('‚ùå Erro ao enviar √°udio:', err);
                this.updateTempMessageWithError(tempMsgId, err.message);
                this.seenMessageIds.delete(tempMsgId);
            });
            
            this.closeAudioModalFunc();
        };
        reader.readAsDataURL(this.audioBlob);
    }

    // ========== FUN√á√ïES AUXILIARES ==========
    updateTempMessage(tempId, serverMsg) {
        const messageDiv = this.messagesDiv?.querySelector(`[data-temp-id="${tempId}"]`);
        if (messageDiv) {
            const contentDiv = messageDiv.querySelector('.message-content');
            
            if (serverMsg.type === 'imagem' && serverMsg.image_filename) {
                const imageUrl = `/uploads/images/${serverMsg.image_filename}`;
                contentDiv.innerHTML = `
                    <div class="message-image-container">
                        <img src="${imageUrl}" alt="Imagem enviada" class="message-image" onclick="window.integratedChat.openImageFullscreen('${imageUrl}')">
                        <div class="message-image-caption">Imagem enviada</div>
                    </div>
                `;
            } else if (serverMsg.type === 'audio' && serverMsg.audio_filename) {
                const audioUrl = `/uploads/audios/${serverMsg.audio_filename}`;
                contentDiv.innerHTML = `
                    <div class="message-audio">
                        <audio controls src="${audioUrl}"></audio>
                        <div class="message-audio-caption">√Åudio ${serverMsg.audio_duration ? `- ${serverMsg.audio_duration}s` : ''}</div>
                    </div>
                `;
            } else {
                contentDiv.textContent = serverMsg.conteudo;
            }
            
            messageDiv.removeAttribute('data-temp-id');
            messageDiv.classList.remove('temp');
            messageDiv.dataset.messageId = serverMsg.id;
        }
    }

    updateTempMessageWithError(tempId, error) {
        const messageDiv = this.messagesDiv?.querySelector(`[data-temp-id="${tempId}"]`);
        if (messageDiv) {
            const contentDiv = messageDiv.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = `<span style="color: #ff6b6b;">‚ùå Erro: ${error}</span>`;
            }
            messageDiv.removeAttribute('data-temp-id');
            messageDiv.classList.remove('temp');
        }
    }

    markMessageAsFailed(tempId) {
        const messageDiv = this.messagesDiv?.querySelector(`[data-temp-id="${tempId}"]`);
        if (messageDiv) {
            const contentDiv = messageDiv.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = '<span style="color: #ff6b6b;">‚ùå Falha ao enviar mensagem</span>';
            }
            messageDiv.removeAttribute('data-temp-id');
            messageDiv.classList.remove('temp');
        }
    }

    // M√©todo para integra√ß√£o com home.js
    openChatFromHome(chatId, chatType, chatName, participants = []) {
        this.openChat(chatId, chatType, chatName, participants);
    }
}

// Inicializar quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
    window.integratedChat = new IntegratedChat();
    console.log('üéâ IntegratedChat inicializado e dispon√≠vel como window.integratedChat');
});

// Exportar para uso global
if (typeof module !== 'undefined' && module.exports) {
    module.exports = IntegratedChat;
}

chat.js:

// static/js/chat.js (MODIFICADO - SEM LOGIN)
let lastSince = '';
let username = '';
let pendingMessageId = null;
let seenMessageIds = new Set();

// VARI√ÅVEIS PARA MULTIPLOS CHATS
let currentChat = {
    id: 'general',
    type: 'group',
    name: 'Chat Geral',
    participants: []
};

let chatHistory = {
    'general': { messages: [], lastSince: '' }
};

// Elementos DOM - SEM nameSetup
const chatArea = document.getElementById('chat-area');
const messagesDiv = document.getElementById('messages');
const onlineUl = document.getElementById('online-list');
const input = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');
const emojiBtn = document.getElementById('emoji-btn');
const emojiModal = document.getElementById('emoji-modal');
const closeEmojiModal = document.getElementById('close-emoji-modal');
const emojiGrid = document.getElementById('emoji-grid');
const emojiSearch = document.getElementById('emoji-search');
const emojiCount = document.getElementById('emoji-count');
// Elementos DOM para imagens
const attachBtn = document.getElementById('attach-btn');
const fileInput = document.getElementById('file-input');
const imagePreviewModal = document.getElementById('image-preview-modal');
const closePreviewModal = document.getElementById('close-preview-modal');
const cancelPreview = document.getElementById('cancel-preview');
const sendImageBtn = document.getElementById('send-image');
const previewImage = document.getElementById('preview-image');
// Elementos DOM para √°udio
const recordBtn = document.getElementById('record-btn');
const audioRecordModal = document.getElementById('audio-record-modal');
const closeAudioModal = document.getElementById('close-audio-modal');
const cancelAudio = document.getElementById('cancel-audio');
const startRecordBtn = document.getElementById('start-record-btn');
const stopRecordBtn = document.getElementById('stop-record-btn');
const sendAudioBtn = document.getElementById('send-audio');
const audioPreview = document.getElementById('audio-preview');
const audioRecordTimer = document.getElementById('audio-record-timer');
const audioRecordVisualizer = document.getElementById('audio-record-visualizer');
// ELEMENTOS DOM PARA INFO DO CHAT
const chatTitle = document.getElementById('chat-title');
const chatInfo = document.getElementById('chat-info');
const backToHomeBtn = document.getElementById('back-to-home');

// Vari√°veis para controle de imagem
let selectedImageFile = null;
let imageFullscreenModal = null;

// Vari√°veis para controle de √°udio
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let recordingInterval;
let recordingTime = 0;

let pollInterval = null;

console.log('JS carregado! Elementos encontrados:', {
    chatArea: !!chatArea,
    messagesDiv: !!messagesDiv,
    input: !!input,
    sendBtn: !!sendBtn
});

// FUN√á√ÉO PARA INICIALIZAR O CHAT COM SESS√ÉO
async function initializeChat() {
    try {
        console.log('üîê Buscando informa√ß√µes do usu√°rio...');
        
        const response = await fetch('/user-info');
        const data = await response.json();
        
        if (data.error) {
            console.error('‚ùå Usu√°rio n√£o autenticado:', data.error);
            window.location.href = '/portal';
            return;
        }
        
        username = data.username;
        console.log('‚úÖ Usu√°rio da sess√£o:', username);
        
        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chat') || 'general';
        const chatType = urlParams.get('type') || 'group';
        const chatName = urlParams.get('name') || 'Chat Geral';
        
        currentChat = {
            id: chatId,
            type: chatType,
            name: chatName,
            participants: []
        };
        
        // Inicializar hist√≥rico se n√£o existir
        if (!chatHistory[chatId]) {
            chatHistory[chatId] = { messages: [], lastSince: '' };
        }
        
        // Mostrar chat area
        if (chatArea) {
            chatArea.style.display = 'flex';
        }
        
        // Atualizar interface
        updateChatHeader();
        
        // Carregar mensagens do chat atual
        loadChatMessages();
        
        // Iniciar polling
        startPolling();
        
        console.log('üéâ Chat inicializado:', currentChat);
        
    } catch (error) {
        console.error('üí• Erro ao inicializar chat:', error);
        window.location.href = '/portal';
    }
}

function startPolling() {
    stopPolling();
    pollInterval = setInterval(poll, 1000);
    console.log('üîÑ Polling iniciado');
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
        console.log('üõë Polling parado');
    }
}

function updateChatHeader() {
    console.log('Atualizando header do chat:', currentChat);
    
    // ‚úÖ ATUALIZAR T√çTULO
    if (chatTitle) {
        chatTitle.textContent = currentChat.name;
    }
    
    // ‚úÖ ATUALIZAR INFORMA√á√ïES
    if (chatInfo) {
        if (currentChat.type === 'group') {
            chatInfo.textContent = `Grupo ‚Ä¢ ${currentChat.participants.length} participantes`;
        } else if (currentChat.type === 'private') {
            chatInfo.textContent = 'Chat privado';
        } else {
            chatInfo.textContent = 'Chat p√∫blico';
        }
    }
    
    console.log('Header atualizado:', {
        title: chatTitle?.textContent,
        info: chatInfo?.textContent
    });
}

function loadChatMessages() {
    if (!messagesDiv) return;
    
    // Limpar mensagens atuais
    messagesDiv.innerHTML = '';
    
    // Carregar mensagens do hist√≥rico local
    const chatData = chatHistory[currentChat.id];
    if (chatData && chatData.messages.length > 0) {
        chatData.messages.forEach(msg => {
            appendMessage(msg);
        });
        scrollToBottom();
    }
    
    // Iniciar polling para este chat espec√≠fico
    lastSince = chatData?.lastSince || '';
}

// Lista de emojis com nomes para busca (mantida igual)
const emojisWithNames = [
    // Smileys & Emotion
    { emoji: 'üòÄ', name: 'sorriso' },
    { emoji: 'üòÉ', name: 'sorriso grande' },
    { emoji: 'üòÑ', name: 'sorriso olhos felizes' },
    { emoji: 'üòÅ', name: 'sorriso com olhos brilhantes' },
    { emoji: 'üòÜ', name: 'sorriso fechado olhos' },
    { emoji: 'üòÖ', name: 'suando sorriso' },
    { emoji: 'üòÇ', name: 'chorando de rir' },
    { emoji: 'ü§£', name: 'rolando de rir' },
    { emoji: 'üòä', name: 'sorriso t√≠mido' },
    { emoji: 'üòá', name: 'sorriso angelical' },
    { emoji: 'üôÇ', name: 'sorriso suave' },
    { emoji: 'üôÉ', name: 'cabe√ßa para baixo' },
    { emoji: 'üòâ', name: 'piscar' },
    { emoji: 'üòå', name: 'aliviado' },
    { emoji: 'üòç', name: 'apaixonado' },
    { emoji: 'ü•∞', name: 'sorriso com cora√ß√µes' },
    { emoji: 'üòò', name: 'beijo' },
    { emoji: 'üòó', name: 'beijando' },
    { emoji: 'üòô', name: 'beijo com olhos felizes' },
    { emoji: 'üòö', name: 'beijo com olhos fechados' },
    { emoji: 'üòã', name: 'saboroso' },
    { emoji: 'üòõ', name: 'l√≠ngua para fora' },
    { emoji: 'üòù', name: 'l√≠ngua olhos fechados' },
    { emoji: 'üòú', name: 'piscar com l√≠ngua' },
    { emoji: 'ü§™', name: 'maluco' },
    { emoji: 'ü§®', name: 'sobrancelha levantada' },
    { emoji: 'üßê', name: 'mon√≥culo' },
    { emoji: 'ü§ì', name: 'nerd' },
    { emoji: 'üòé', name: 'descolado' },
    { emoji: 'ü§©', name: 'estrelas nos olhos' },
    { emoji: 'ü•≥', name: 'festa' },
    { emoji: 'üòè', name: 'smirk' },
    { emoji: 'üòí', name: 'entediado' },
    { emoji: 'üòû', name: 'decepcionado' },
    { emoji: 'üòî', name: 'abatido' },
    { emoji: 'üòü', name: 'preocupado' },
    { emoji: 'üòï', name: 'confuso' },
    { emoji: 'üôÅ', name: 'levemente triste' },
    { emoji: '‚òπÔ∏è', name: 'triste' },
    { emoji: 'üò£', name: 'sofrendo' },
    { emoji: 'üòñ', name: 'confuso' },
    { emoji: 'üò´', name: 'cansado' },
    { emoji: 'üò©', name: 'exausto' },
    { emoji: 'ü•∫', name: 'suplicante' },
    { emoji: 'üò¢', name: 'chorando' },
    { emoji: 'üò≠', name: 'chorando muito' },
    { emoji: 'üò§', name: 'triumfante' },
    { emoji: 'üò†', name: 'zangado' },
    { emoji: 'üò°', name: 'furioso' },
    { emoji: 'ü§¨', name: 'xingando' },
    { emoji: 'üò≥', name: 'corado' },
    { emoji: 'ü•µ', name: 'calor' },
    { emoji: 'ü•∂', name: 'frio' },
    { emoji: 'üò±', name: 'gritando' },
    { emoji: 'üò®', name: 'amedrontado' },
    { emoji: 'üò∞', name: 'ansioso' },
    { emoji: 'üò•', name: 'decepcionado mas aliviado' },
    { emoji: 'üòì', name: 'suando frio' },
    { emoji: 'ü§•', name: 'mentiroso' },
    { emoji: 'ü§§', name: 'babando' },
    { emoji: 'üò∂', name: 'sem boca' },
    { emoji: 'üòê', name: 'neutro' },
    { emoji: 'üòë', name: 'sem express√£o' },
    { emoji: 'üò¨', name: 'envergonhado' },
    { emoji: 'üôÑ', name: 'revirando olhos' },
    { emoji: 'üòØ', name: 'sil√™ncio' },
    { emoji: 'üò¶', name: 'carrancudo' },
    { emoji: 'üòß', name: 'angustiado' },
    { emoji: 'üòÆ', name: 'boca aberta' },
    { emoji: 'üò≤', name: 'espantado' },
    { emoji: 'ü•±', name: 'bocejando' },
    { emoji: 'üò¥', name: 'dormindo' },
    { emoji: 'üò™', name: 'sonolento' },
    { emoji: 'üòµ', name: 'tonto' },
    { emoji: 'ü§Ø', name: 'explodindo' },
    { emoji: 'üò∑', name: 'm√°scara' },
    { emoji: 'ü§í', name: 'term√¥metro' },
    { emoji: 'ü§ï', name: 'cabe√ßa enfaixada' },
    { emoji: 'ü§¢', name: 'enjoado' },
    // Pessoas
    { emoji: 'üëã', name: 'acenando' },
    { emoji: 'ü§ö', name: 'levantando m√£o' },
    { emoji: 'üñêÔ∏è', name: 'm√£o aberta' },
    { emoji: '‚úã', name: 'm√£o levantada' },
    { emoji: 'üññ', name: 'sauda√ß√µes vulcanas' },
    { emoji: 'üëå', name: 'ok' },
    { emoji: 'ü§è', name: 'pin√ßa' },
    { emoji: '‚úåÔ∏è', name: 'paz' },
    { emoji: 'ü§û', name: 'dedos cruzados' },
    { emoji: 'ü§ü', name: 'eu te amo' },
    { emoji: 'ü§ò', name: 'chifres' },
    { emoji: 'ü§ô', name: 'me liga' },
    { emoji: 'üëà', name: 'apontar esquerda' },
    { emoji: 'üëâ', name: 'apontar direita' },
    { emoji: 'üëÜ', name: 'apontar cima' },
    { emoji: 'üñï', name: 'dedo m√©dio' },
    { emoji: 'üëá', name: 'apontar baixo' },
    { emoji: '‚òùÔ∏è', name: 'apontar para cima' },
    { emoji: 'üëç', name: 'joinha' },
    { emoji: 'üëé', name: 'polegar baixo' },
    { emoji: '‚úä', name: 'punho' },
    { emoji: 'üëä', name: 'soco' },
    { emoji: 'ü§õ', name: 'punho esquerda' },
    { emoji: 'ü§ú', name: 'punho direita' },
    { emoji: 'üëè', name: 'palmas' },
    { emoji: 'üôå', name: 'm√£os para cima' },
    { emoji: 'üëê', name: 'm√£os abertas' },
    { emoji: 'ü§≤', name: 'palmas juntas' },
    { emoji: 'ü§ù', name: 'aperto de m√£os' },
    { emoji: 'üôè', name: 'orar' },
    // Cora√ß√µes
    { emoji: '‚ù§Ô∏è', name: 'cora√ß√£o vermelho' },
    { emoji: 'üß°', name: 'cora√ß√£o laranja' },
    { emoji: 'üíõ', name: 'cora√ß√£o amarelo' },
    { emoji: 'üíö', name: 'cora√ß√£o verde' },
    { emoji: 'üíô', name: 'cora√ß√£o azul' },
    { emoji: 'üíú', name: 'cora√ß√£o roxo' },
    { emoji: 'üñ§', name: 'cora√ß√£o preto' },
    { emoji: 'ü§ç', name: 'cora√ß√£o branco' },
    { emoji: 'ü§é', name: 'cora√ß√£o marrom' },
    { emoji: 'üíî', name: 'cora√ß√£o partido' },
    // Animais
    { emoji: 'üêµ', name: 'macaco' },
    { emoji: 'üê∂', name: 'cachorro' },
    { emoji: 'üê±', name: 'gato' },
    { emoji: 'üê≠', name: 'rato' },
    { emoji: 'üêπ', name: 'hamster' },
    { emoji: 'üê∞', name: 'coelho' },
    { emoji: 'ü¶ä', name: 'raposa' },
    { emoji: 'üêª', name: 'urso' },
    { emoji: 'üêº', name: 'panda' },
    { emoji: 'üê®', name: 'coala' },
    { emoji: 'üêØ', name: 'tigre' },
    { emoji: 'ü¶Å', name: 'le√£o' },
    { emoji: 'üêÆ', name: 'vaca' },
    { emoji: 'üê∑', name: 'porco' },
    { emoji: 'üê∏', name: 'sapo' },
    { emoji: 'üêô', name: 'polvo' },
    // Comidas
    { emoji: 'üçé', name: 'ma√ß√£' },
    { emoji: 'üçê', name: 'pera' },
    { emoji: 'üçä', name: 'laranja' },
    { emoji: 'üçã', name: 'lim√£o' },
    { emoji: 'üçå', name: 'banana' },
    { emoji: 'üçâ', name: 'melancia' },
    { emoji: 'üçá', name: 'uva' },
    { emoji: 'üçì', name: 'morango' },
    { emoji: 'ü´ê', name: 'mirtilo' },
    { emoji: 'üçà', name: 'mel√£o' },
    { emoji: 'üçí', name: 'cereja' },
    { emoji: 'üçë', name: 'p√™ssego' },
    { emoji: 'ü•≠', name: 'manga' },
    { emoji: 'üçç', name: 'abacaxi' },
    { emoji: 'ü••', name: 'coco' },
    { emoji: 'ü•ë', name: 'abacate' },
    { emoji: 'üçÜ', name: 'berinjela' },
    { emoji: 'ü•î', name: 'batata' },
    { emoji: 'ü•ï', name: 'cenoura' },
    { emoji: 'üåΩ', name: 'milho' },
    { emoji: 'üå∂Ô∏è', name: 'pimenta' },
    { emoji: 'ü´ë', name: 'piment√£o' },
    // Objetos
    { emoji: '‚åö', name: 'rel√≥gio' },
    { emoji: 'üì±', name: 'celular' },
    { emoji: 'üíª', name: 'notebook' },
    { emoji: 'üñ•Ô∏è', name: 'computador' },
    { emoji: 'üñ®Ô∏è', name: 'impressora' },
    { emoji: 'üéÆ', name: 'videogame' },
    { emoji: 'üëæ', name: 'alien' },
    // S√≠mbolos
    { emoji: 'üíØ', name: 'cem pontos' },
    { emoji: '‚ú®', name: 'brilho' },
    { emoji: 'üéâ', name: 'festa' },
    { emoji: 'üéä', name: 'confete' },
    { emoji: 'üî•', name: 'fogo' },
    { emoji: 'üí•', name: 'explos√£o' },
    { emoji: '‚≠ê', name: 'estrela' },
    { emoji: 'üåü', name: 'estrela brilhante' },
    { emoji: 'üôà', name: 'n√£o vejo mal' },
    { emoji: 'üôâ', name: 'n√£o ou√ßo mal' },
    { emoji: 'üôä', name: 'n√£o falo mal' }
];

// Fun√ß√£o para injetar emojis no grid com busca
function injectEmojis(searchTerm = '') {
    console.log('Injetando emojis...');
    
    if (!emojiGrid) {
        console.error('Elemento emoji-grid n√£o encontrado!');
        return;
    }
    
    emojiGrid.innerHTML = '';
    
    const term = searchTerm.toLowerCase().trim();
    const filteredEmojis = emojisWithNames.filter(item => 
        item.name.toLowerCase().includes(term) || 
        item.emoji.includes(term)
    );
    
    if (filteredEmojis.length === 0) {
        const noResults = document.createElement('div');
        noResults.classList.add('no-results');
        noResults.textContent = 'Nenhum emoji encontrado';
        emojiGrid.appendChild(noResults);
    } else {
        filteredEmojis.forEach(item => {
            const btn = document.createElement('button');
            btn.classList.add('emoji-btn');
            btn.textContent = item.emoji;
            btn.type = 'button';
            btn.title = item.name; // Tooltip com o nome
            btn.addEventListener('click', () => {
                input.value += item.emoji;
                input.focus();
                closeEmojiModalFunc();
            });
            emojiGrid.appendChild(btn);
        });
    }
    
    // Atualiza contador
    if (emojiCount) {
        emojiCount.textContent = `${filteredEmojis.length} emojis${term ? ' encontrados' : ' no total'}`;
    }
    console.log('Emojis injetados:', filteredEmojis.length);
}

// Fun√ß√£o para lidar com a sele√ß√£o de imagem
function handleImageSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Verificar se √© uma imagem
    if (!file.type.match('image.*')) {
        alert('Por favor, selecione apenas arquivos de imagem.');
        return;
    }

    // Verificar tamanho do arquivo (limite de 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('A imagem √© muito grande. Por favor, selecione uma imagem menor que 5MB.');
        return;
    }

    selectedImageFile = file;

    // Criar preview
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImage.src = e.target.result;
        imagePreviewModal.style.display = 'flex';
    };
    reader.readAsDataURL(file);
}

function closeImagePreview() {
    if (imagePreviewModal) {
        imagePreviewModal.style.display = 'none';
    }
    if (fileInput) {
        fileInput.value = '';
    }
    selectedImageFile = null;
}

// Fun√ß√£o para enviar imagem
function sendImage() {
    if (!selectedImageFile || !username) {
        closeImagePreview();
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        
        // Criar mensagem tempor√°ria
        const approxIso = new Date().toISOString();
        const tempMsgId = 'img-' + Date.now();
        const tempMsg = {
            id: tempMsgId, 
            nome: username, 
            conteudo: 'üì∑ Enviando imagem...', 
            timestamp: approxIso,
            type: 'imagem',
            isTemp: true
        };
        
        // ‚Üì‚Üì‚Üì ADICIONE O ID TEMPOR√ÅRIO AO seenMessageIds PARA EVITAR DUPLICA√á√ÉO ‚Üì‚Üì‚Üì
        seenMessageIds.add(tempMsgId);
        appendMessage(tempMsg, true);
        
        // Enviar para o servidor
        fetch('/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                content: 'Imagem',
                type: 'imagem',
                image_data: imageData,
                chat_id: currentChat.id,
                chat_type: currentChat.type
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            // ‚Üì‚Üì‚Üì ADICIONE O ID REAL AO seenMessageIds E ATUALIZE O pendingMessageId ‚Üì‚Üì‚Üì
            seenMessageIds.add(data.id);
            pendingMessageId = data.id;
            
            // Atualizar a mensagem tempor√°ria com a resposta do servidor
            updateTempMessage(tempMsgId, data);
        })
        .catch(err => {
            console.error('Erro ao enviar imagem:', err);
            // Mostrar erro na mensagem tempor√°ria
            updateTempMessageWithError(tempMsgId, err.message);
            // ‚Üì‚Üì‚Üì REMOVA O ID TEMPOR√ÅRIO EM CASO DE ERRO ‚Üì‚Üì‚Üì
            seenMessageIds.delete(tempMsgId);
        });
        
        closeImagePreview();
    };
    reader.readAsDataURL(selectedImageFile);
}

// Fun√ß√£o para atualizar mensagem tempor√°ria com sucesso
function updateTempMessage(tempId, serverMsg) {
    const messageDiv = messagesDiv.querySelector(`[data-temp-id="${tempId}"]`);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.message-content');
        
        if (serverMsg.type === 'imagem' && serverMsg.image_filename) {
            // Mensagem de imagem
            const imageUrl = `/uploads/images/${serverMsg.image_filename}`;
            contentDiv.innerHTML = `
                <div class="message-image-container">
                    <img src="${imageUrl}" alt="Imagem enviada" class="message-image" onclick="openImageFullscreen('${imageUrl}')">
                    <div class="message-image-caption">Imagem enviada</div>
                </div>
            `;
        } else if (serverMsg.type === 'audio' && serverMsg.audio_filename) {
            // Mensagem de √°udio
            const audioUrl = `/uploads/audios/${serverMsg.audio_filename}`;
            contentDiv.innerHTML = `
                <div class="message-audio">
                    <audio controls src="${audioUrl}"></audio>
                    <div class="message-audio-caption">√Åudio ${serverMsg.audio_duration ? `- ${serverMsg.audio_duration}s` : ''}</div>
                </div>
            `;
        } else {
            // Mensagem de texto normal - apenas atualizar o conte√∫do se necess√°rio
            contentDiv.textContent = serverMsg.conteudo;
        }
        
        messageDiv.removeAttribute('data-temp-id');
        messageDiv.classList.remove('temp');
        
        // Atualizar o ID real da mensagem
        messageDiv.dataset.messageId = serverMsg.id;
    }
}

// Fun√ß√£o para mostrar erro no upload
function updateTempMessageWithError(tempId, error) {
    const messageDiv = messagesDiv.querySelector(`[data-temp-id="${tempId}"]`);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.message-content');
        if (contentDiv) {
            contentDiv.innerHTML = `<span style="color: #ff6b6b;">‚ùå Erro: ${error}</span>`;
        }
        messageDiv.removeAttribute('data-temp-id');
        messageDiv.classList.remove('temp');
    }
}

// Fun√ß√£o para abrir imagem em tela cheia
function openImageFullscreen(imageSrc) {
    // Criar modal de tela cheia se n√£o existir
    if (!imageFullscreenModal) {
        imageFullscreenModal = document.createElement('div');
        imageFullscreenModal.className = 'image-fullscreen-modal';
        imageFullscreenModal.innerHTML = `
            <div class="image-fullscreen-content">
                <img src="" alt="Imagem em tela cheia">
            </div>
        `;
        document.body.appendChild(imageFullscreenModal);
        
        // Fechar ao clicar
        imageFullscreenModal.addEventListener('click', () => {
            imageFullscreenModal.style.display = 'none';
        });
    }
    
    // Mostrar imagem
    const img = imageFullscreenModal.querySelector('img');
    img.src = imageSrc;
    imageFullscreenModal.style.display = 'flex';
}

// Adicionar fun√ß√£o openImageFullscreen ao escopo global
window.openImageFullscreen = openImageFullscreen;

// Fun√ß√µes para √°udio
function closeAudioModalFunc() {
    if (audioRecordModal) {
        audioRecordModal.style.display = 'none';
    }
    resetAudioRecording();
}

function resetAudioRecording() {
    // Parar grava√ß√£o se estiver ativa
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    
    // Limpar vari√°veis
    audioChunks = [];
    audioBlob = null;
    recordingTime = 0;
    audioRecordTimer.textContent = '00:00';
    audioRecordVisualizer.innerHTML = 'Clique em "Iniciar Grava√ß√£o"';
    audioRecordVisualizer.style.background = 'rgba(0, 0, 0, 0.2)';
    
    // Resetar controles
    startRecordBtn.disabled = false;
    stopRecordBtn.disabled = true;
    sendAudioBtn.disabled = true;
    audioPreview.style.display = 'none';
    
    // Limpar intervalos
    if (recordingInterval) {
        clearInterval(recordingInterval);
    }
}

function startRecording() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Seu navegador n√£o suporta grava√ß√£o de √°udio.');
        return;
    }

    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioElement = audioPreview.querySelector('audio');
                audioElement.src = audioUrl;
                audioPreview.style.display = 'block';
                sendAudioBtn.disabled = false;
            };

            mediaRecorder.start();
            startRecordBtn.disabled = true;
            stopRecordBtn.disabled = false;
            audioRecordVisualizer.innerHTML = 'üé§ Gravando...';
            audioRecordVisualizer.style.background = 'linear-gradient(120deg, #c9302c, #d9534f)';
            audioRecordVisualizer.classList.add('recording-animation');

            // Iniciar timer
            recordingTime = 0;
            recordingInterval = setInterval(() => {
                recordingTime++;
                const minutes = Math.floor(recordingTime / 60).toString().padStart(2, '0');
                const seconds = (recordingTime % 60).toString().padStart(2, '0');
                audioRecordTimer.textContent = `${minutes}:${seconds}`;
            }, 1000);
        })
        .catch(err => {
            console.error('Erro ao acessar microfone:', err);
            alert('Erro ao acessar o microfone. Verifique as permiss√µes.');
        });
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        startRecordBtn.disabled = false;
        stopRecordBtn.disabled = true;
        audioRecordVisualizer.innerHTML = '‚úÖ Grava√ß√£o conclu√≠da';
        audioRecordVisualizer.style.background = 'linear-gradient(120deg, #248A52, #257287)';
        audioRecordVisualizer.classList.remove('recording-animation');
        
        if (recordingInterval) {
            clearInterval(recordingInterval);
        }
    }
}

function sendAudio() {
    if (!audioBlob || !username) {
        closeAudioModalFunc();
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const audioData = e.target.result;
        
        // Criar mensagem tempor√°ria
        const approxIso = new Date().toISOString();
        const tempMsgId = 'audio-' + Date.now();
        const tempMsg = {
            id: tempMsgId, 
            nome: username, 
            conteudo: 'üé§ √Åudio...', 
            timestamp: approxIso,
            type: 'audio',
            isTemp: true
        };
        
        seenMessageIds.add(tempMsgId);
        appendMessage(tempMsg, true);
        
        // Enviar para o servidor
        fetch('/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                content: '√Åudio',
                type: 'audio',
                audio_data: audioData,
                audio_duration: recordingTime,
                chat_id: currentChat.id,
                chat_type: currentChat.type
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            seenMessageIds.add(data.id);
            pendingMessageId = data.id;
            
            // Atualizar a mensagem tempor√°ria com a resposta do servidor
            updateTempMessage(tempMsgId, data);
        })
        .catch(err => {
            console.error('Erro ao enviar √°udio:', err);
            updateTempMessageWithError(tempMsgId, err.message);
            seenMessageIds.delete(tempMsgId);
        });
        
        closeAudioModalFunc();
    };
    reader.readAsDataURL(audioBlob);
}

// Fun√ß√£o para marcar mensagem como falha
function markMessageAsFailed(tempId) {
    const messageDiv = messagesDiv.querySelector(`[data-temp-id="${tempId}"]`);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.message-content');
        if (contentDiv) {
            contentDiv.innerHTML = '<span style="color: #ff6b6b;">‚ùå Falha ao enviar mensagem</span>';
        }
        messageDiv.removeAttribute('data-temp-id');
        messageDiv.classList.remove('temp');
    }
}

//EVENT LISTENER PARA VOLTAR √Ä HOME
if (backToHomeBtn) {
    backToHomeBtn.addEventListener('click', () => {
        window.location.href = '/home';
    });
}

// Fun√ß√µes auxiliares
function formatTime(iso) {
    const date = new Date(iso);
    // Formata para HH:MM (apenas horas e minutos)
    return date.toTimeString().substring(0, 5);
}

function appendMessage(msg, isSelf = false) {
    if (!messagesDiv) return;
    
    // Verifica√ß√£o extra: N√ÉO ADICIONAR SE J√Å EXISTIR
    const existingMessage = messagesDiv.querySelector(`[data-message-id="${msg.id}"]`) || 
                           messagesDiv.querySelector(`[data-temp-id="${msg.id}"]`);
    if (existingMessage) {
        return;
    }
    
    const isSelfMsg = isSelf || msg.nome === username;
    const div = document.createElement('div');
    div.classList.add('message');
    if (isSelfMsg) {
        div.classList.add('self');
    } else {
        div.classList.add('other');
    }
    
    // Adicionar ID tempor√°rio se for uma mensagem tempor√°ria
    if (msg.isTemp && msg.id) {
        div.dataset.tempId = msg.id;
        div.classList.add('temp');
    } else if (msg.id) {
        div.dataset.messageId = msg.id;
    }

    let contentHTML = '';

    // Verificar pelo campo 'type'
    if (msg.type === 'imagem' && msg.image_filename) {
        const imageUrl = `/uploads/images/${msg.image_filename}`;
        contentHTML = `
            <div class="message-image-container">
                <img src="${imageUrl}" alt="Imagem enviada" class="message-image" onclick="openImageFullscreen('${imageUrl}')">
                <div class="message-image-caption">Imagem enviada</div>
            </div>
        `;
    } else if (msg.type === 'audio' && msg.audio_filename) {
        const audioUrl = `/uploads/audios/${msg.audio_filename}`;
        contentHTML = `
            <div class="message-audio">
                <audio controls src="${audioUrl}"></audio>
                <div class="message-audio-caption">√Åudio ${msg.audio_duration ? `- ${msg.audio_duration}s` : ''}</div>
            </div>
        `;
    } else if (msg.isTemp) {
        contentHTML = `
            <div class="message-content">
                <span class="image-loading"></span>${msg.conteudo}
            </div>
        `;
    } else {
        contentHTML = `<div class="message-content">${msg.conteudo}</div>`;
    }

    // Para mensagens pr√≥prias: nome ‚Üí conte√∫do ‚Üí timestamp (√† direita)
    // Para mensagens de outros: timestamp ‚Üí nome ‚Üí conte√∫do (timestamp √† esquerda)
    if (isSelfMsg) {
        div.innerHTML = `
            <div class="message-header">
                <strong>${msg.nome}</strong>
                <span class="timestamp">${formatTime(msg.timestamp)}</span>
            </div>
            ${contentHTML}
        `;
    } else {
        div.innerHTML = `
            <div class="message-header">
                <span class="timestamp">${formatTime(msg.timestamp)}</span>
                <strong>${msg.nome}</strong>
            </div>
            ${contentHTML}
        `;
    }
    
    messagesDiv.appendChild(div);
    scrollToBottom();
}

function updateOnline(list) {
    if (!onlineUl) return;
    onlineUl.innerHTML = '';
    list.forEach(nome => {
        const li = document.createElement('li');
        li.textContent = nome + (nome === username ? ' (voc√™)' : '');
        onlineUl.appendChild(li);
    });
}

function scrollToBottom() {
    if (!messagesDiv) return;
    messagesDiv.scrollTo({
        top: messagesDiv.scrollHeight,
        behavior: 'smooth'
    });
}

// Poll
function poll() {
    if (!username || !currentChat) return;
    
    let url = `/messages?chat=${encodeURIComponent(currentChat.id)}&type=${encodeURIComponent(currentChat.type)}`;
    if (lastSince) url += `&since=${encodeURIComponent(lastSince)}`;
    
    fetch(url)
        .then(res => res.json())
        .then(data => {
            let newMsgs = 0;
            data.messages.forEach(msg => {
                // ‚Üì‚Üì‚Üì VERIFICAR SE A MENSAGEM √â DO CHAT ATUAL ‚Üì‚Üì‚Üì
                if (msg.chat_id !== currentChat.id) return;
                
                if (seenMessageIds.has(msg.id) || (pendingMessageId && msg.id === pendingMessageId)) {
                    return;
                }
                appendMessage(msg);
                seenMessageIds.add(msg.id);
                newMsgs++;
                
                // ‚Üì‚Üì‚Üì SALVAR NO HIST√ìRICO LOCAL ‚Üì‚Üì‚Üì
                if (!chatHistory[currentChat.id].messages.some(m => m.id === msg.id)) {
                    chatHistory[currentChat.id].messages.push(msg);
                }
            });
            
            updateOnline(data.online);
            if (newMsgs > 0) {
                lastSince = data.messages[data.messages.length - 1].timestamp;
                chatHistory[currentChat.id].lastSince = lastSince;
            }
        })
        .catch(err => console.error('Erro no poll:', err));
}

// Send
function send() {
    let content = input.value.trim();
    if (!content || !username || !currentChat) return;
    input.value = '';

    const approxIso = new Date().toISOString();
    const tempMsgId = 'txt-' + Date.now();
    const tempMsg = {
        id: tempMsgId, 
        nome: username, 
        conteudo: content, 
        timestamp: approxIso,
        isTemp: true,
        chat_id: currentChat.id,
        chat_type: currentChat.type
    };
    
    seenMessageIds.add(tempMsgId);
    appendMessage(tempMsg, true);

    // ‚úÖ ADICIONAR: Mostrar loading no bot√£o
    if (sendBtn) {
        sendBtn.classList.add('sending');
        sendBtn.disabled = true;
    }

    fetch('/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            content: content,
            chat_id: currentChat.id,
            chat_type: currentChat.type
        })
    })
    .then(res => res.json())
    .then(data => {
        // ‚úÖ ADICIONAR: Remover loading do bot√£o
        if (sendBtn) {
            sendBtn.classList.remove('sending');
            sendBtn.disabled = false;
        }

        if (data.id && data.timestamp) {
            lastSince = data.timestamp;
            pendingMessageId = data.id;
            seenMessageIds.add(data.id);
            console.log('Mensagem confirmada por ID:', data.id);
            
            // ‚úÖ ADICIONAR: Atualizar mensagem tempor√°ria com dados reais
            updateTempMessage(tempMsgId, data);
            
            if (!chatHistory[currentChat.id].messages.some(m => m.id === data.id)) {
                chatHistory[currentChat.id].messages.push(data);
            }
        } else if (data.error) {
            console.error('Erro ao enviar:', data.error);
            // ‚úÖ ADICIONAR: Marcar mensagem como falha
            markMessageAsFailed(tempMsgId);
            pendingMessageId = null;
            seenMessageIds.delete(tempMsgId);
        }
    })
    .catch(err => {
        console.error('Erro ao enviar:', err);
        // ‚úÖ ADICIONAR: Remover loading do bot√£o mesmo em erro
        if (sendBtn) {
            sendBtn.classList.remove('sending');
            sendBtn.disabled = false;
        }
        
        // ‚úÖ ADICIONAR: Marcar mensagem como falha
        markMessageAsFailed(tempMsgId);
        pendingMessageId = null;
        seenMessageIds.delete(tempMsgId);
    });
}

// Fun√ß√£o para fechar modal de emojis
function closeEmojiModalFunc() {
    if (emojiModal) {
        emojiModal.style.display = 'none';
    }
    if (emojiSearch) {
        emojiSearch.value = ''; // Limpa a busca ao fechar
    }
}

// Eventos b√°sicos
if (sendBtn) {
    sendBtn.addEventListener('click', send);
}

if (input) {
    input.addEventListener('keypress', e => { 
        if (e.key === 'Enter') { 
            send(); 
            closeEmojiModalFunc(); 
        } 
    });
}

// Eventos para emoji modal
if (emojiBtn) {
    emojiBtn.addEventListener('click', () => {
        if (emojiModal) {
            emojiModal.style.display = 'flex';
            if (emojiSearch) {
                emojiSearch.value = ''; // Limpa a busca
            }
            injectEmojis(''); // Mostra todos os emojis
            setTimeout(() => {
                if (emojiSearch) {
                    emojiSearch.focus(); // Foca na barra de busca
                }
            }, 100);
        }
    });
}

if (closeEmojiModal) {
    closeEmojiModal.addEventListener('click', closeEmojiModalFunc);
}

if (emojiModal) {
    emojiModal.addEventListener('click', (e) => {
        if (e.target === emojiModal) {
            closeEmojiModalFunc();
        }
    });
}

// Evento de busca em tempo real
if (emojiSearch) {
    emojiSearch.addEventListener('input', (e) => {
        injectEmojis(e.target.value);
    });
}

// Evento para o bot√£o de anexar imagem
if (attachBtn) {
    attachBtn.addEventListener('click', () => {
        fileInput.click();
    });
}

// Evento para sele√ß√£o de arquivo
if (fileInput) {
    fileInput.addEventListener('change', handleImageSelect);
}

// Eventos para o modal de preview
if (closePreviewModal) {
    closePreviewModal.addEventListener('click', closeImagePreview);
}

if (cancelPreview) {
    cancelPreview.addEventListener('click', closeImagePreview);
}

if (sendImageBtn) {
    sendImageBtn.addEventListener('click', sendImage);
}

// Evento para o bot√£o de gravar √°udio
if (recordBtn) {
    recordBtn.addEventListener('click', () => {
        if (audioRecordModal) {
            audioRecordModal.style.display = 'flex';
            resetAudioRecording();
        }
    });
}

// Eventos para o modal de √°udio
if (closeAudioModal) {
    closeAudioModal.addEventListener('click', closeAudioModalFunc);
}

if (cancelAudio) {
    cancelAudio.addEventListener('click', closeAudioModalFunc);
}

if (startRecordBtn) {
    startRecordBtn.addEventListener('click', startRecording);
}

if (stopRecordBtn) {
    stopRecordBtn.addEventListener('click', stopRecording);
}

if (sendAudioBtn) {
    sendAudioBtn.addEventListener('click', sendAudio);
}

// Fechar modal de √°udio ao clicar fora
if (audioRecordModal) {
    audioRecordModal.addEventListener('click', (e) => {
        if (e.target === audioRecordModal) {
            closeAudioModalFunc();
        }
    });
}

// Fechar preview ao clicar fora
if (imagePreviewModal) {
    imagePreviewModal.addEventListener('click', (e) => {
        if (e.target === imagePreviewModal) {
            closeImagePreview();
        }
    });
}

// Fechar modais com ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (emojiModal && emojiModal.style.display === 'flex') {
            closeEmojiModalFunc();
        }
        if (imagePreviewModal && imagePreviewModal.style.display === 'flex') {
            closeImagePreview();
        }
        if (audioRecordModal && audioRecordModal.style.display === 'flex') {
            closeAudioModalFunc();
        }
        if (imageFullscreenModal && imageFullscreenModal.style.display === 'flex') {
            imageFullscreenModal.style.display = 'none';
        }
    }
});

// In√≠cio - INICIALIZAR CHAT COM SESS√ÉO
console.log('üöÄ Inicializando chat com sess√£o...');
if (chatArea) {
    chatArea.style.display = 'none'; // Esconder at√© carregar usu√°rio
}

// Inicializar quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', initializeChat);

// Debug
console.log('=== DEBUG CHAT SEM LOGIN ===');
console.log('chat-area:', document.getElementById('chat-area'));
console.log('messages:', document.getElementById('messages'));

home.js:

// home.js
let currentUser = '';
let onlineUsers = [];
let friendsList = [];
let friendRequests = [];
let currentTab = 'chats';
let logoutHandler = null;
let conversations = [];

// ========== INICIALIZA√á√ÉO ==========

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Home inicializada - Sistema de Conversas WhatsApp-like');
    fetchUserInfo();
});

function fetchUserInfo() {
    fetch('/user-info', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            window.location.href = '/portal';
            throw new Error('N√£o autenticado');
        }
        return response.json();
    })
    .then(data => {
        currentUser = data.username;
        initializeHome();
    })
    .catch(error => {
        console.error('Erro:', error);
        window.location.href = '/portal';
    });
}

function initializeHome() {
    // Atualizar interface
    document.getElementById('user-name').textContent = currentUser;
    document.getElementById('user-avatar').textContent = currentUser.charAt(0).toUpperCase();
    
    setupEventListeners();
    setupDeleteConfirmation();
    setupConversationContextMenu();
    loadConversations();
    loadOnlineUsers();
    loadFriends();
    loadFriendRequests();
    
    // Iniciar polling para atualiza√ß√µes
    setInterval(loadConversations, 5000);
    setInterval(loadFriendRequests, 10000);
    setInterval(loadFriends, 15000);
    setInterval(loadOnlineUsers, 10000);
    
    console.log('‚úÖ Home inicializada com sistema de conversas');
}

// ========== CONFIGURA√á√ÉO DE EVENT LISTENERS ==========

function setupEventListeners() {
    console.log('üîß Configurando event listeners...');
    
    setupLogoutListener();
    setupTabListeners();
    setupActionButtons();
    setupModalListeners();
    setupSearchListeners();
    
    console.log('‚úÖ Event listeners configurados');
}

function setupLogoutListener() {
    const logoutBtn = document.getElementById('logout-btn');
    
    if (logoutHandler) {
        logoutBtn.removeEventListener('click', logoutHandler);
    }
    
    logoutHandler = function(event) {
        console.log('üéØ Logout clicado');
        event.stopPropagation();
        event.preventDefault();
        
        if (confirm('Tem certeza que deseja sair?')) {
            logoutUser();
        }
    };
    
    logoutBtn.addEventListener('click', logoutHandler);
}

function setupTabListeners() {
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            switchTab(tab);
        });
    });
}

function setupActionButtons() {
    // Bot√µes principais
    document.getElementById('new-chat-btn').addEventListener('click', showPrivateChatModal);
    document.getElementById('new-group-btn').addEventListener('click', showCreateGroupModal);
    document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountModal);
    
    // Bot√µes de boas-vindas
    document.getElementById('create-group-welcome').addEventListener('click', showCreateGroupModal);
    document.getElementById('start-private-chat-welcome').addEventListener('click', showPrivateChatModal);
    
    // Bot√µes de amigos
    document.getElementById('add-friend-btn').addEventListener('click', showAddFriendModal);
    document.getElementById('add-first-friend').addEventListener('click', showAddFriendModal);
    document.getElementById('view-requests-btn').addEventListener('click', showFriendRequestsModal);
    
    // A√ß√µes de formul√°rio
    document.getElementById('create-group').addEventListener('click', createNewGroup);
    document.getElementById('send-friend-request').addEventListener('click', sendFriendRequest);
}

function setupModalListeners() {
    // Fechar modais
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', closeAllModals);
    });
    
    // Cancelar modais
    document.getElementById('cancel-group').addEventListener('click', closeAllModals);
    document.getElementById('cancel-private').addEventListener('click', closeAllModals);
    document.getElementById('cancel-add-friend').addEventListener('click', closeAllModals);
    document.getElementById('close-requests').addEventListener('click', closeAllModals);
    
    // Modal de exclus√£o de conta
    document.getElementById('confirm-delete-account').addEventListener('click', deleteUserAccount);
    document.getElementById('cancel-delete-account').addEventListener('click', closeDeleteAccountModal);
    document.getElementById('close-delete-modal').addEventListener('click', closeDeleteAccountModal);

    // Fechar modais ao clicar fora
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAllModals();
            }
        });
    });
}

function setupSearchListeners() {
    document.getElementById('search-input').addEventListener('input', filterContent);
    document.getElementById('friend-username').addEventListener('input', searchUsers);
}

// ========== SISTEMA DE EXCLUS√ÉO DE CONTA ==========

function setupDeleteConfirmation() {
    const confirmationInput = document.getElementById('delete-confirmation-input');
    const confirmButton = document.getElementById('confirm-delete-account');
    
    if (confirmationInput && confirmButton) {
        confirmationInput.addEventListener('input', function() {
            confirmButton.disabled = this.value !== 'CONFIRMAR EXCLUS√ÉO';
        });
    }
}

function showDeleteAccountModal() {
    console.log('üóëÔ∏è Abrindo modal de exclus√£o de conta...');
    document.getElementById('delete-account-modal').style.display = 'flex';
    document.getElementById('delete-confirmation-input').value = '';
    document.getElementById('confirm-delete-account').disabled = true;
}

function closeDeleteAccountModal() {
    document.getElementById('delete-account-modal').style.display = 'none';
}

async function deleteUserAccount() {
    console.log('üóëÔ∏è Solicitando exclus√£o da conta...');
    
    const confirmation = document.getElementById('delete-confirmation-input').value;
    
    if (confirmation !== 'CONFIRMAR EXCLUS√ÉO') {
        alert('Por favor, digite exatamente: CONFIRMAR EXCLUS√ÉO');
        return;
    }
    
    if (!confirm('üö® ATEN√á√ÉO FINAL!\n\nEsta a√ß√£o √© PERMANENTE e IRREVERS√çVEL!\n\n‚úÖ Todos suas mensagens ser√£o exclu√≠das\n‚úÖ Seus grupos ser√£o removidos\n‚úÖ Suas amizades ser√£o perdidas\n\nTem certeza ABSOLUTA?')) {
        return;
    }
    
    try {
        const response = await fetch('/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confirmation: confirmation
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + data.message + '\n\nRedirecionando para a p√°gina inicial...');
            
            // Redirecionar para o portal ap√≥s 2 segundos
            setTimeout(() => {
                window.location.href = '/portal';
            }, 2000);
            
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (error) {
        console.error('‚ùå Erro ao excluir conta:', error);
        alert('‚ùå Erro de conex√£o ao excluir conta. Tente novamente.');
    }
}

// ========== SISTEMA DE EXCLUS√ÉO DE GRUPOS ==========

function setupConversationContextMenu() {
    const conversationsList = document.getElementById('conversations-list');
    
    conversationsList.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        
        const conversationItem = e.target.closest('.conversation-item');
        if (!conversationItem) return;
        
        const conversaId = conversationItem.getAttribute('data-conversa-id');
        const conversaType = conversationItem.getAttribute('data-conversa-type');
        const conversaName = conversationItem.getAttribute('data-conversa-name');
        
        // S√≥ mostrar menu de exclus√£o para grupos (n√£o para Chat Geral ou conversas privadas)
        if (conversaType === 'group' && conversaId !== 'general') {
            showConversationContextMenu(e, conversaId, conversaName);
        }
    });
}

function showConversationContextMenu(event, conversaId, conversaName) {
    // Remover menu anterior se existir
    const existingMenu = document.getElementById('conversation-context-menu');
    if (existingMenu) {
        existingMenu.remove();
    }
    
    // Criar menu de contexto
    const contextMenu = document.createElement('div');
    contextMenu.id = 'conversation-context-menu';
    contextMenu.className = 'context-menu';
    contextMenu.style.position = 'fixed';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    contextMenu.style.background = '#2a3942';
    contextMenu.style.border = '1px solid #3a4952';
    contextMenu.style.borderRadius = '8px';
    contextMenu.style.padding = '8px 0';
    contextMenu.style.zIndex = '1000';
    contextMenu.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
    contextMenu.style.minWidth = '150px';
    
    contextMenu.innerHTML = `
        <div class="context-menu-item" data-action="delete" style="padding: 8px 16px; cursor: pointer; color: #e9edef; display: flex; align-items: center; gap: 8px; transition: background 0.2s;">
            <span>üóëÔ∏è</span>
            Excluir Grupo
        </div>
    `;
    
    document.body.appendChild(contextMenu);
    
    // Adicionar evento de clique no item de exclus√£o
    contextMenu.querySelector('.context-menu-item[data-action="delete"]').addEventListener('click', function() {
        excluirGrupo(conversaId, conversaName);
        contextMenu.remove();
    });
    
    // Fechar menu ao clicar fora
    setTimeout(() => {
        const closeMenu = function(e) {
            if (!contextMenu.contains(e.target)) {
                contextMenu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };
        document.addEventListener('click', closeMenu);
    }, 100);
}

async function excluirGrupo(grupoId, grupoNome) {
    console.log(`üóëÔ∏è Solicitando exclus√£o do grupo: ${grupoNome} (ID: ${grupoId})`);
    
    if (!confirm(`üö® ATEN√á√ÉO!\n\nTem certeza que deseja excluir o grupo "${grupoNome}"?\n\n‚úÖ Todas as mensagens ser√£o perdidas\n‚úÖ Todos os participantes ser√£o removidos\n‚úÖ Esta a√ß√£o √© PERMANENTE e IRREVERS√çVEL!`)) {
        return;
    }
    
    try {
        const response = await fetch('/excluir-grupo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                grupo_id: parseInt(grupoId)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            
            // Recarregar a lista de conversas
            loadConversations();
            
            // Se o grupo exclu√≠do era o chat ativo, voltar para a tela inicial
            if (window.integratedChat && window.integratedChat.currentChat && 
                window.integratedChat.currentChat.id === grupoId) {
                window.integratedChat.showConversationList();
            }
            
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (error) {
        console.error('‚ùå Erro ao excluir grupo:', error);
        alert('‚ùå Erro de conex√£o ao excluir grupo. Tente novamente.');
    }
}

// ========== SISTEMA DE CONVERSAS ==========

function loadConversations() {
    console.log('üí¨ [FRONTEND] Carregando conversas...');
    
    fetch('/conversas')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì® [FRONTEND] Resposta da API /conversas:', data);
            
            if (data.conversas && Array.isArray(data.conversas)) {
                conversations = data.conversas;
                console.log(`‚úÖ [FRONTEND] ${conversations.length} conversas recebidas da API`);
                renderConversations(conversations);
            } else {
                console.warn('‚ö†Ô∏è [FRONTEND] Nenhuma conversa encontrada ou formato inv√°lido');
                conversations = [];
                renderConversations([]);
            }
        })
        .catch(error => {
            console.error('‚ùå [FRONTEND] Erro ao carregar conversas:', error);
            conversations = [];
            renderConversations([]);
        });
}

function renderConversations(conversas) {
    const conversationsList = document.getElementById('conversations-list');
    if (!conversationsList) {
        console.error('‚ùå [FRONTEND] Elemento conversations-list n√£o encontrado');
        return;
    }

    // Limpar lista (mantendo apenas o Chat Geral)
    conversationsList.innerHTML = '';
    
    // ‚úÖ SEMPRE CRIAR O CHAT GERAL
    const generalChatItem = document.createElement('div');
    generalChatItem.className = 'conversation-item';
    generalChatItem.setAttribute('data-chat-id', 'general');
    generalChatItem.setAttribute('data-chat-type', 'group');
    generalChatItem.setAttribute('data-chat-name', 'Chat Geral');
    generalChatItem.innerHTML = `
        <div class="conversation-avatar group-avatar">üë•</div>
        <div class="conversation-info">
            <div class="conversation-name">Chat Geral</div>
        </div>
        <div class="conversation-meta">
            <div class="conversation-time">Agora</div>
        </div>
    `;
    generalChatItem.addEventListener('click', function() {
        openConversa('general', 'group', 'Chat Geral');
    });
    conversationsList.appendChild(generalChatItem);

    // Adicionar conversas do banco de dados
    if (conversas && conversas.length > 0) {
        console.log(`üé® [FRONTEND] Renderizando ${conversas.length} conversas`);
        
        conversas.forEach((conversa, index) => {
            if (conversa.nome === 'Chat Geral') {
                console.log(`‚è≠Ô∏è [FRONTEND] Pulando conversa duplicada do Chat Geral`);
                return;
            }
            
            const conversationItem = createConversationItem(conversa);
            conversationsList.appendChild(conversationItem);
        });
    }
}

function createConversationItem(conversa) {
    const item = document.createElement('div');
    item.className = 'conversation-item';
    item.setAttribute('data-conversa-id', conversa.id);
    item.setAttribute('data-conversa-type', conversa.tipo);
    item.setAttribute('data-conversa-name', conversa.nome);

    const avatar = conversa.tipo === 'private' ? 'üë§' : 'üë•';
    const time = formatTime(conversa.ultima_mensagem_em);
    const preview = conversa.ultima_mensagem || 'Nenhuma mensagem ainda';
    const unread = conversa.mensagens_nao_lidas > 0 ? 
        `<div class="unread-count">${conversa.mensagens_nao_lidas}</div>` : '';

    // ‚úÖ ADICIONAR TITLE PARA GRUPOS (indica que pode clicar com bot√£o direito)
    const titleAttr = conversa.tipo === 'group' && conversa.id !== 'general' ? 
        'title="Clique com o bot√£o direito para op√ß√µes do grupo"' : '';

    item.innerHTML = `
        <div class="conversation-avatar ${conversa.tipo === 'group' ? 'group-avatar' : ''}">
            ${avatar}
        </div>
        <div class="conversation-info">
            <div class="conversation-name">${conversa.nome}</div>
            <div class="conversation-preview">${preview}</div>
        </div>
        <div class="conversation-meta">
            <div class="conversation-time">${time}</div>
            ${unread}
        </div>
    `;

    item.addEventListener('click', function() {
        const conversaId = this.getAttribute('data-conversa-id');
        const conversaType = this.getAttribute('data-conversa-type');
        const conversaName = this.getAttribute('data-conversa-name');
        openConversa(conversaId, conversaType, conversaName);
    });

    return item;
}

function formatTime(isoString) {
    if (!isoString) return '';
    
    try {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'Agora';
        if (diffMins < 60) return `${diffMins} min`;
        if (diffHours < 24) return `${diffHours} h`;
        if (diffDays < 7) return `${diffDays} d`;
        
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    } catch (e) {
        return '';
    }
}

function openConversa(conversaId, conversaType, conversaName) {
    console.log(`üí¨ [OPEN_CONVERSA] Abrindo: ${conversaName} (${conversaType}) ID: ${conversaId}`);
    
    if (window.integratedChat && typeof window.integratedChat.openChat === 'function') {
        window.integratedChat.openChat(conversaId, conversaType, conversaName, []);
    } else {
        console.error('‚ùå [OPEN_CONVERSA] Chat integrado n√£o dispon√≠vel');
        const params = new URLSearchParams({
            chat: conversaId,
            type: conversaType,
            name: conversaName
        });
        window.open('/chat?' + params.toString(), '_blank');
    }
}

// ========== SISTEMA DE AMIZADES ==========

function loadFriends() {
    console.log('üë• Carregando amigos...');
    
    fetch('/friends')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && Array.isArray(data.friends)) {
                friendsList = data.friends;
            } else {
                friendsList = [];
                console.warn('Formato inesperado da resposta:', data);
            }
            updateFriendsList();
        })
        .catch(error => {
            console.error('Erro ao carregar amigos:', error);
            friendsList = [];
            updateFriendsList();
        });
}

function updateFriendsList() {
    const friendsListContainer = document.getElementById('friends-list');
    
    if (!friendsListContainer) {
        console.error('‚ùå ERRO: Elemento #friends-list n√£o encontrado no DOM!');
        return;
    }
    
    friendsListContainer.innerHTML = '';
    
    if (!friendsList || friendsList.length === 0) {
        friendsListContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üë•</div>
                <h3>Nenhum amigo adicionado</h3>
                <p>Comece adicionando amigos para conversar</p>
                <button id="add-first-friend" class="welcome-btn">
                    <span>‚ûï</span>
                    Adicionar Primeiro Amigo
                </button>
            </div>
        `;
        
        document.getElementById('add-first-friend').addEventListener('click', showAddFriendModal);
        return;
    }
    
    friendsList.forEach((friend, index) => {
        if (!friend || !friend.username) {
            console.error(`‚ùå Amigo na posi√ß√£o ${index} √© inv√°lido:`, friend);
            return;
        }
        
        const friendItem = document.createElement('div');
        friendItem.className = 'friend-item';
        friendItem.setAttribute('data-friend-id', friend.id || 'unknown');
        friendItem.setAttribute('data-friend-username', friend.username);
        
        const avatarLetter = friend.username.charAt(0).toUpperCase();
        
        friendItem.innerHTML = `
            <div class="friend-avatar">${avatarLetter}</div>
            <div class="friend-info">
                <div class="friend-name">${friend.username}</div>
                <div class="friend-status">
                    <span class="status-dot ${friend.online ? 'online' : ''}"></span>
                    ${friend.online ? 'Online' : 'Offline'}
                </div>
            </div>
            <div class="friend-actions">
                <button class="friend-action-btn chat-with-friend" title="Conversar" data-username="${friend.username}">üí¨</button>
                <button class="friend-action-btn remove-friend" title="Remover amigo" data-friend-id="${friend.id || 'unknown'}" data-username="${friend.username}">‚ùå</button>
            </div>
        `;
        
        friendItem.querySelector('.chat-with-friend').addEventListener('click', function() {
            const username = this.getAttribute('data-username');
            startPrivateChat(username);
        });
        
        friendItem.querySelector('.remove-friend').addEventListener('click', function(e) {
            e.stopPropagation();
            const friendId = this.getAttribute('data-friend-id');
            const friendUsername = this.getAttribute('data-username');
            removeFriend(friendId, friendUsername);
        });
        
        friendsListContainer.appendChild(friendItem);
    });
}

function removeFriend(friendId, friendUsername) {
    console.log(`üóëÔ∏è INICIANDO remo√ß√£o: ID ${friendId}, Username ${friendUsername}`);
    
    if (!friendId || friendId === 'unknown') {
        alert('Erro: ID do amigo inv√°lido');
        return;
    }
    
    if (!confirm(`Tem certeza que deseja remover ${friendUsername} da sua lista de amigos?`)) {
        return;
    }
    
    fetch('/remove-friend', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            friend_id: parseInt(friendId),
            friend_username: friendUsername
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadFriends();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao remover amigo:', error);
        alert('Erro de conex√£o ao remover amigo. Tente novamente.');
    });
}

// ========== SISTEMA DE PEDIDOS DE AMIZADE ==========

function loadFriendRequests() {
    console.log('üì® Carregando pedidos de amizade...');
    
    fetch('/friend-requests')
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na rede');
            }
            return response.json();
        })
        .then(data => {
            if (data.requests) {
                friendRequests = data.requests;
            } else {
                friendRequests = [];
            }
            
            updateFriendRequestsIndicator();
            updateFriendRequestsModal();
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar pedidos:', error);
            friendRequests = [];
            updateFriendRequestsIndicator();
        });
}

function updateFriendRequestsIndicator() {
    const friendsTab = document.querySelector('[data-tab="friends"]');
    
    if (friendRequests.length > 0) {
        friendsTab.classList.add('has-requests');
    } else {
        friendsTab.classList.remove('has-requests');
    }
}

function showFriendRequestsModal() {
    const modal = document.getElementById('friend-requests-modal');
    if (!modal) {
        console.error('‚ùå Modal de pedidos n√£o encontrado');
        return;
    }
    
    modal.style.display = 'flex';
    updateFriendRequestsModal();
}

function updateFriendRequestsModal() {
    const requestsList = document.getElementById('friend-requests-list');
    if (!requestsList) {
        console.error('‚ùå Lista de pedidos n√£o encontrada');
        return;
    }
    
    if (friendRequests.length === 0) {
        requestsList.innerHTML = `
            <div class="empty-requests">
                <div class="empty-icon">üì≠</div>
                <p>Nenhum pedido de amizade pendente</p>
            </div>
        `;
        return;
    }
    
    requestsList.innerHTML = '';
    
    friendRequests.forEach(request => {
        const requestItem = document.createElement('div');
        requestItem.className = 'friend-request-item';
        requestItem.innerHTML = `
            <div class="friend-request-avatar">
                ${request.from_username.charAt(0).toUpperCase()}
            </div>
            <div class="friend-request-info">
                <div class="friend-request-name">${request.from_username}</div>
                <div class="friend-request-time">${request.time}</div>
            </div>
            <div class="friend-request-actions">
                <button class="request-action-btn accept" data-request-id="${request.id}" data-username="${request.from_username}">
                    ‚úì Aceitar
                </button>
                <button class="request-action-btn reject" data-request-id="${request.id}" data-username="${request.from_username}">
                    ‚úó Recusar
                </button>
            </div>
        `;
        
        requestsList.appendChild(requestItem);
    });
    
    document.querySelectorAll('.request-action-btn.accept').forEach(btn => {
        btn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-request-id');
            const username = this.getAttribute('data-username');
            acceptFriendRequest(requestId, username);
        });
    });
    
    document.querySelectorAll('.request-action-btn.reject').forEach(btn => {
        btn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-request-id');
            const username = this.getAttribute('data-username');
            rejectFriendRequest(requestId, username);
        });
    });
}

function acceptFriendRequest(requestId, username) {
    console.log(`‚úÖ Aceitando pedido ${requestId} de ${username}`);
    
    fetch('/accept-friend-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadFriendRequests();
            loadFriends();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao aceitar pedido de amizade.');
    });
}

function rejectFriendRequest(requestId, username) {
    console.log(`‚ùå Rejeitando pedido ${requestId} de ${username}`);
    
    fetch('/reject-friend-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadFriendRequests();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao rejeitar pedido de amizade.');
    });
}

// ========== SISTEMA DE GRUPOS E CHATS PRIVADOS ==========

function startPrivateChat(username) {
    console.log(`üîí Iniciando chat privado com ${username}`);
    
    const sortedUsers = [currentUser, username].sort();
    const chatId = 'private-' + sortedUsers.join('-');
    
    closeAllModals();
    openChat(chatId, 'private', username, [currentUser, username]);
}

function showCreateGroupModal() {
    document.getElementById('create-group-modal').style.display = 'flex';
    document.getElementById('group-name').focus();
    loadOnlineUsers();
}

function showPrivateChatModal() {
    document.getElementById('private-chat-modal').style.display = 'flex';
    loadOnlineUsers();
}

function createNewGroup() {
    const groupName = document.getElementById('group-name').value.trim();
    
    const selectedMembers = Array.from(document.querySelectorAll('.member-checkbox.selected'))
        .map(checkbox => {
            const memberItem = checkbox.closest('.member-item');
            return parseInt(memberItem.getAttribute('data-user-id'));
        })
        .filter(userId => !isNaN(userId));

    console.log('üë• [CRIA√á√ÉO] Membros selecionados (IDs):', selectedMembers);

    if (!groupName) {
        alert('Por favor, digite um nome para o grupo');
        return;
    }

    if (selectedMembers.length === 0) {
        alert('Selecione pelo menos um membro para o grupo');
        return;
    }

    const requestData = {
        nome: groupName,
        participantes: selectedMembers
    };

    console.log('üöÄ [CRIA√á√ÉO] Enviando requisi√ß√£o para criar grupo:', requestData);

    fetch('/criar-grupo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('üì® [CRIA√á√ÉO] Resposta do servidor - Status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üì¶ [CRIA√á√ÉO] Dados da resposta:', data);
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            closeAllModals();
            document.getElementById('group-name').value = '';
            document.querySelectorAll('.member-checkbox').forEach(cb => cb.classList.remove('selected'));
            
            console.log('üîÑ [CRIA√á√ÉO] Recarregando conversas...');
            setTimeout(() => {
                loadConversations();
                
                if (data.conversa && data.conversa.id) {
                    console.log('üéØ [CRIA√á√ÉO] Abrindo grupo criado:', data.conversa);
                    setTimeout(() => {
                        openConversa(data.conversa.id, 'group', data.conversa.nome);
                    }, 500);
                }
            }, 1000);
            
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('üí• [CRIA√á√ÉO] Erro na requisi√ß√£o:', error);
        alert('‚ùå Erro de conex√£o ao criar grupo: ' + error.message);
    });
}

// ========== SISTEMA DE BUSCA E ADI√á√ÉO DE AMIGOS ==========

function showAddFriendModal() {
    document.getElementById('add-friend-modal').style.display = 'flex';
    document.getElementById('friend-username').focus();
    document.getElementById('friend-search-results').innerHTML = '';
}

function searchUsers() {
    const username = document.getElementById('friend-username').value.trim();
    const resultsContainer = document.getElementById('friend-search-results');
    
    if (username.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }
    
    fetch(`/search-users?q=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            
            if (data.users && data.users.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">Nenhum usu√°rio encontrado</div>';
                return;
            }
            
            if (data.users) {
                data.users.forEach(user => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="search-result-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${user.username}</div>
                            <div class="search-result-status">${user.online ? 'Online' : 'Offline'}</div>
                        </div>
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        document.getElementById('friend-username').value = user.username;
                        resultsContainer.innerHTML = '';
                    });
                    
                    resultsContainer.appendChild(resultItem);
                });
            }
        })
        .catch(error => {
            console.error('Erro na busca:', error);
            resultsContainer.innerHTML = '<div class="search-result-item">Erro na busca</div>';
        });
}

function sendFriendRequest() {
    const username = document.getElementById('friend-username').value.trim();
    
    if (!username) {
        alert('Por favor, digite um nome de usu√°rio.');
        return;
    }
    
    if (username === currentUser) {
        alert('Voc√™ n√£o pode adicionar a si mesmo como amigo.');
        return;
    }
    
    fetch('/send-friend-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            username: username
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeAllModals();
            document.getElementById('friend-username').value = '';
            loadFriendRequests();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conex√£o ao enviar pedido de amizade.');
    });
}

// ========== SISTEMA DE USU√ÅRIOS ONLINE ==========

function loadOnlineUsers() {
    if (!currentUser) return;
    
    fetch('/messages?name=' + encodeURIComponent(currentUser))
        .then(response => response.json())
        .then(data => {
            if (data.online) {
                onlineUsers = Array.isArray(data.online) 
                    ? data.online.filter(user => user !== currentUser && user !== null && user !== undefined)
                    : [];
                updateUsersList();
            } else {
                onlineUsers = [];
                updateUsersList();
            }
        })
        .catch(error => {
            console.error('Erro ao carregar usu√°rios online:', error);
            onlineUsers = [];
            updateUsersList();
        });
}

function updateUsersList() {
    const usersList = document.getElementById('users-list');
    const membersList = document.getElementById('members-list');
    
    fetch('/user-list')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.users && Array.isArray(data.users)) {
                updateUsersListUI(usersList, data.users, 'user');
                updateUsersListUI(membersList, data.users, 'member');
            } else {
                updateUsersListFallback(usersList, membersList);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao buscar lista de usu√°rios:', error);
            updateUsersListFallback(usersList, membersList);
        });
}

function updateUsersListUI(container, users, type) {
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!users || users.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üë§</div>
                <p>Nenhum usu√°rio dispon√≠vel</p>
            </div>
        `;
        return;
    }
    
    const filteredUsers = users.filter(user => 
        user && user.username && user.username !== currentUser
    );
    
    if (filteredUsers.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üë§</div>
                <p>Nenhum outro usu√°rio dispon√≠vel</p>
            </div>
        `;
        return;
    }
    
    filteredUsers.forEach(user => {
        const item = document.createElement('div');
        item.className = type === 'member' ? 'member-item' : 'user-item';
        
        const userId = user.id;
        const username = user.username;
        const avatar = username.charAt(0).toUpperCase();
        const onlineStatus = user.online ? 'online' : 'offline';
        
        if (type === 'member') {
            item.setAttribute('data-user-id', userId);
            item.setAttribute('data-username', username);
            item.innerHTML = `
                <div class="user-avatar ${onlineStatus}">${avatar}</div>
                <div class="member-info">
                    <div class="member-name">${username}</div>
                    <div class="member-status">${user.online ? 'Online' : 'Offline'}</div>
                </div>
                <div class="member-checkbox"></div>
            `;
            item.addEventListener('click', function() {
                this.querySelector('.member-checkbox').classList.toggle('selected');
            });
        } else {
            item.setAttribute('data-user-id', userId);
            item.innerHTML = `
                <div class="user-avatar ${onlineStatus}">${avatar}</div>
                <div class="user-info">
                    <div class="user-name">${username}</div>
                    <div class="user-status">${user.online ? 'Online' : 'Offline'}</div>
                </div>
            `;
            item.addEventListener('click', function() {
                startPrivateChat(username);
            });
        }
        
        container.appendChild(item);
    });
}

function updateUsersListFallback(usersList, membersList) {
    if (usersList) {
        usersList.innerHTML = '';
        if (onlineUsers.length === 0) {
            usersList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üë§</div>
                    <p>Nenhum usu√°rio online no momento</p>
                </div>
            `;
        } else {
            onlineUsers.forEach(username => {
                if (!username) return;
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.setAttribute('data-username', username);
                userItem.innerHTML = `
                    <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
                    <div class="user-name">${username}</div>
                `;
                userItem.addEventListener('click', function() {
                    startPrivateChat(username);
                });
                usersList.appendChild(userItem);
            });
        }
    }
    
    if (membersList) {
        membersList.innerHTML = '';
        if (onlineUsers.length === 0) {
            membersList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üë§</div>
                    <p>Nenhum usu√°rio online no momento</p>
                </div>
            `;
        } else {
            onlineUsers.forEach(username => {
                if (!username) return;
                
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.setAttribute('data-username', username);
                memberItem.innerHTML = `
                    <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
                    <div class="member-name">${username}</div>
                    <div class="member-checkbox"></div>
                `;
                memberItem.addEventListener('click', function() {
                    this.querySelector('.member-checkbox').classList.toggle('selected');
                });
                membersList.appendChild(memberItem);
            });
        }
    }
}

// ========== FUN√á√ïES UTILIT√ÅRIAS ==========

function switchTab(tab) {
    currentTab = tab;
    
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(`${tab}-tab`).classList.add('active');
    
    const searchInput = document.getElementById('search-input');
    if (tab === 'chats') {
        searchInput.placeholder = 'Pesquisar conversas...';
    } else {
        searchInput.placeholder = 'Pesquisar amigos...';
    }
    
    console.log(`üìÅ Guia alterada para: ${tab}`);
}

function filterContent() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    
    if (currentTab === 'chats') {
        const conversationItems = document.querySelectorAll('.conversation-item');
        conversationItems.forEach(item => {
            const conversationName = item.querySelector('.conversation-name').textContent.toLowerCase();
            item.style.display = conversationName.includes(searchTerm) ? 'flex' : 'none';
        });
    } else {
        const friendItems = document.querySelectorAll('.friend-item');
        friendItems.forEach(item => {
            const friendName = item.querySelector('.friend-name').textContent.toLowerCase();
            item.style.display = friendName.includes(searchTerm) ? 'flex' : 'none';
        });
    }
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

function logoutUser() {
    console.log('üö™ Iniciando logout...');
    
    fetch('/logout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Logout realizado, redirecionando...');
            window.location.href = '/portal';
        } else {
            alert('Erro ao fazer logout: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conex√£o ao tentar fazer logout.');
    });
}

function openChat(chatId, chatType, chatName, participants = []) {
    console.log(`üí¨ Abrindo chat: ${chatName} (${chatType})`);
    
    if (window.integratedChat && typeof window.integratedChat.openChat === 'function') {
        window.integratedChat.openChat(chatId, chatType, chatName, participants);
    } else {
        console.error('‚ùå Chat integrado n√£o dispon√≠vel. Redirecionando para p√°gina separada...');
        const params = new URLSearchParams({
            chat: chatId,
            type: chatType,
            name: chatName
        });
        window.open('/chat?' + params.toString(), '_blank');
    }
}

// ========== INTEGRA√á√ÉO COM CHAT INTEGRADO ==========

window.getCurrentUser = function() {
    return currentUser;
};

function checkIntegratedChat() {
    if (window.integratedChat && typeof window.integratedChat.openChat === 'function') {
        console.log('‚úÖ Chat integrado dispon√≠vel');
        return true;
    } else {
        console.log('‚ö†Ô∏è Chat integrado n√£o dispon√≠vel');
        return false;
    }
}

setTimeout(checkIntegratedChat, 2000);

portal.js:

// app/static/js/portal.js (COM CORRE√á√ÉO DE MENSAGENS)
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Portal carregado - Inicializando...');
    
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const messageContainer = document.getElementById('message-container');

    // Inicializar toggle de senha
    initPasswordToggle();
    console.log('‚úÖ Toggle de senha inicializado');

    // Alternar entre login e cadastro
    showRegisterLink.addEventListener('click', function(e) {
        e.preventDefault();
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'block';
        clearMessages();
        console.log('üîÑ Mudou para cadastro');
    });

    showLoginLink.addEventListener('click', function(e) {
        e.preventDefault();
        registerContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        clearMessages();
        console.log('üîÑ Mudou para login');
    });

    // Login
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();

        if (!username || !password) {
            showMessage('Preencha todos os campos', 'error');
            return;
        }

        loginUser(username, password);
    });

    // Cadastro
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value.trim();

        if (!username || !password) {
            showMessage('Preencha todos os campos', 'error');
            return;
        }

        if (username.length < 3) {
            showMessage('Nome de usu√°rio deve ter pelo menos 3 caracteres', 'error');
            return;
        }

        // ‚úÖ VALIDA√á√ÉO DE SENHA FORTE
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.isValid) {
            showMessage(passwordValidation.message, 'error');
            return;
        }

        registerUser(username, password);
    });

    // ‚úÖ FUN√á√ÉO DE VALIDA√á√ÉO DE SENHA FORTE
    function validatePassword(password) {
        const requirements = {
            length: password.length >= 8,
            hasUpper: /[A-Z]/.test(password),
            hasLower: /[a-z]/.test(password),
            hasNumber: /[0-9]/.test(password),
            hasSpecial: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
        };

        // Verificar quais requisitos falharam
        const failedRequirements = [];
        
        if (!requirements.length) failedRequirements.push('pelo menos 8 caracteres');
        if (!requirements.hasUpper) failedRequirements.push('uma letra mai√∫scula');
        if (!requirements.hasLower) failedRequirements.push('uma letra min√∫scula');
        if (!requirements.hasNumber) failedRequirements.push('um n√∫mero');
        // Opcional: remover special se n√£o quiser caracteres especiais
        // if (!requirements.hasSpecial) failedRequirements.push('um caractere especial');

        if (failedRequirements.length > 0) {
            return {
                isValid: false,
                message: `Senha deve conter: ${failedRequirements.join(', ')}`
            };
        }

        return { isValid: true, message: 'Senha v√°lida' };
    }
    
    // Fun√ß√£o para inicializar os toggles de senha
    function initPasswordToggle() {
        console.log('üîß Inicializando toggles de senha...');
        
        // Toggle para senha do login
        const toggleLoginPassword = document.getElementById('toggle-login-password');
        const loginPasswordInput = document.getElementById('login-password');
        const loginPasswordGroup = loginPasswordInput.parentElement;
        
        if (toggleLoginPassword && loginPasswordInput) {
            toggleLoginPassword.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('üéØ Clicou no toggle do login');
                togglePasswordVisibility(loginPasswordInput, toggleLoginPassword, loginPasswordGroup);
            });
        }

        // Toggle para senha do cadastro
        const toggleRegisterPassword = document.getElementById('toggle-register-password');
        const registerPasswordInput = document.getElementById('register-password');
        const registerPasswordGroup = registerPasswordInput.parentElement;
        
        if (toggleRegisterPassword && registerPasswordInput) {
            toggleRegisterPassword.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('üéØ Clicou no toggle do cadastro');
                togglePasswordVisibility(registerPasswordInput, toggleRegisterPassword, registerPasswordGroup);
            });
        }

        console.log('‚úÖ Toggles configurados');
    }

    function setupPasswordValidation() {
        const passwordInput = document.getElementById('register-password');
        const passwordGroup = passwordInput.parentElement;
        
        // Criar elemento para mostrar requisitos
        let requirementsElement = document.getElementById('password-requirements');
        if (!requirementsElement) {
            requirementsElement = document.createElement('div');
            requirementsElement.id = 'password-requirements';
            requirementsElement.className = 'password-requirements';
            passwordGroup.appendChild(requirementsElement);
        }

        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const validation = validatePassword(password);
            
            updatePasswordRequirements(requirementsElement, password);
        });

        // Esconder requisitos quando n√£o estiver focado
        passwordInput.addEventListener('blur', function() {
            setTimeout(() => {
                requirementsElement.style.display = 'none';
            }, 200);
        });

        passwordInput.addEventListener('focus', function() {
            requirementsElement.style.display = 'block';
        });
    }

    function updatePasswordRequirements(element, password) {
        const requirements = {
            length: password.length >= 8,
            hasUpper: /[A-Z]/.test(password),
            hasLower: /[a-z]/.test(password),
            hasNumber: /[0-9]/.test(password)
        };

        element.innerHTML = `
            <div class="requirement ${requirements.length ? 'valid' : 'invalid'}">
                ${requirements.length ? '‚úÖ' : '‚ùå'} Pelo menos 8 caracteres
            </div>
            <div class="requirement ${requirements.hasUpper ? 'valid' : 'invalid'}">
                ${requirements.hasUpper ? '‚úÖ' : '‚ùå'} Uma letra mai√∫scula
            </div>
            <div class="requirement ${requirements.hasLower ? 'valid' : 'invalid'}">
                ${requirements.hasLower ? '‚úÖ' : '‚ùå'} Uma letra min√∫scula
            </div>
            <div class="requirement ${requirements.hasNumber ? 'valid' : 'invalid'}">
                ${requirements.hasNumber ? '‚úÖ' : '‚ùå'} Um n√∫mero
            </div>
        `;
    }

    // Chamar a fun√ß√£o no DOMContentLoaded, depois de initPasswordToggle()
    setTimeout(setupPasswordValidation, 1000);

    // Fun√ß√£o para alternar a visibilidade da senha
    function togglePasswordVisibility(passwordInput, toggleButton, passwordGroup) {
        console.log('üîÑ Alternando visibilidade da senha...');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.querySelector('.eye-icon').textContent = 'üôà';
            toggleButton.classList.add('active');
            passwordGroup.classList.add('password-visible');
            console.log('üëÄ Senha agora est√° VIS√çVEL');
        } else {
            passwordInput.type = 'password';
            toggleButton.querySelector('.eye-icon').textContent = 'üëÅÔ∏è';
            toggleButton.classList.remove('active');
            passwordGroup.classList.remove('password-visible');
            console.log('üîí Senha agora est√° OCULTA');
        }
        
        // Manter o foco no campo de senha
        setTimeout(() => {
            passwordInput.focus();
        }, 10);
    }

    function loginUser(username, password) {
        console.log('üîê Tentando login para:', username);
        showMessage('Entrando...', 'info');

        fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        })
        .then(response => {
            console.log('üì® Resposta do login - Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Dados da resposta do login:', data);
            
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/home';
                }, 1000);
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('üí• Erro no login:', error);
            showMessage('Erro de conex√£o', 'error');
        });
    }

    function registerUser(username, password) {
        console.log('üìù Tentando cadastrar usu√°rio:', username);
        showMessage('Criando conta...', 'info');

        fetch('/cadastrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        })
        .then(response => {
            console.log('üì® Resposta do cadastro - Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Dados da resposta do cadastro:', data);
            
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/home';
                }, 1000);
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('üí• Erro no cadastro:', error);
            showMessage('Erro de conex√£o', 'error');
        });
    }

    function showMessage(message, type) {
        console.log(`üí¨ Exibindo mensagem: ${message} (${type})`);
        
        // Garantir que o container est√° vis√≠vel
        messageContainer.style.display = 'block';
        messageContainer.textContent = message;
        messageContainer.className = `message-container ${type}`;
        
        // Scroll para a mensagem
        messageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Auto-esconder mensagens de sucesso/erro ap√≥s 5 segundos
        if (type !== 'info') {
            setTimeout(() => {
                if (messageContainer.textContent === message) {
                    clearMessages();
                }
            }, 5000);
        }
    }

    function clearMessages() {
        messageContainer.style.display = 'none';
        messageContainer.textContent = '';
        messageContainer.className = 'message-container';
    }
    
    // Debug: Verificar se tudo carregou corretamente
    console.log('‚úÖ Portal totalmente inicializado');
    console.log('üîç Elementos encontrados:', {
        loginContainer: !!loginContainer,
        registerContainer: !!registerContainer,
        loginForm: !!loginForm,
        registerForm: !!registerForm,
        messageContainer: !!messageContainer,
        toggleLogin: !!document.getElementById('toggle-login-password'),
        toggleRegister: !!document.getElementById('toggle-register-password')
    });
    
    // Teste da fun√ß√£o showMessage
    console.log('üß™ Testando fun√ß√£o showMessage...');
    setTimeout(() => {
        showMessage('Teste de mensagem - Portal carregado!', 'info');
        setTimeout(() => clearMessages(), 2000);
    }, 1000);
});

Chat_Online/app/views/html/:

chat.tpl:

<!-- app/views/html/chat.tpl (MODIFICADO - SEM LOGIN) -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online</title>
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <div class="chat-container">
        <!-- ‚úÖ REMOVIDA A TELA DE LOGIN -->
        <div id="chat-area" class="chat-area" style="display: none;">
            <!-- Header do chat -->
            <div class="chat-header">
                <div class="chat-header-info">
                    <button id="back-to-home" class="back-btn">‚Üê</button>
                    <div class="chat-title-container">
                        <h1 id="chat-title">Chat Online</h1>
                        <div id="chat-info" class="chat-info"></div>
                    </div>
                </div>
                <div class="online-users">
                    <h3>Usu√°rios online:</h3>
                    <ul id="online-list"></ul>
                </div>
            </div>
            
            <div id="messages" class="messages"></div>
            
            <div class="input-area">
                <button id="attach-btn" title="Anexar imagem">üìé</button>
                <button id="record-btn" title="Gravar √°udio">üé§</button>
                <button id="emoji-btn" title="Emojis">üòÄ</button>
                <input type="text" id="msg-input" placeholder="Digite sua mensagem..." autocomplete="off">
                <button id="send-btn">Enviar</button>
                
                <input type="file" id="file-input" accept="image/*" style="display: none">
            </div>
        </div>
    </div>

    <!-- Modal Popup de Emojis -->
    <div id="emoji-modal" class="emoji-modal" style="display: none;">
        <div class="emoji-modal-content">
            <div class="emoji-header">
                <h3>Escolha um Emoji</h3>
                <span id="close-emoji-modal">&times;</span>
            </div>
            <div class="emoji-search">
                <input type="text" id="emoji-search" placeholder="Pesquisar emojis..." autocomplete="off">
            </div>
            <div id="emoji-grid" class="emoji-grid">
                <!-- Emojis ser√£o injetados via JS -->
            </div>
            <div class="emoji-footer">
                <small id="emoji-count">Total: 0 emojis</small>
            </div>
        </div>
    </div>

    <!-- Preview de imagem -->
    <div id="image-preview-modal" class="image-preview-modal" style="display: none;">
        <div class="image-preview-content">
            <div class="image-preview-header">
                <h3>Pr√©-visualiza√ß√£o da Imagem</h3>
                <span id="close-preview-modal">&times;</span>
            </div>
            <div class="image-preview-body">
                <img id="preview-image" src="" alt="Pr√©-visualiza√ß√£o">
            </div>
            <div class="image-preview-footer">
                <button id="cancel-preview">Cancelar</button>
                <button id="send-image">Enviar Imagem</button>
            </div>
        </div>
    </div>

    <!-- Modal de grava√ß√£o de √°udio -->
    <div id="audio-record-modal" class="audio-record-modal" style="display: none;">
        <div class="audio-record-content">
            <div class="audio-record-header">
                <h3>Gravar √Åudio</h3>
                <span id="close-audio-modal">&times;</span>
            </div>
            <div class="audio-record-body">
                <div id="audio-record-visualizer"></div>
                <div id="audio-record-timer">00:00</div>
                <div class="audio-record-controls">
                    <button id="start-record-btn">üé§ Iniciar Grava√ß√£o</button>
                    <button id="stop-record-btn" disabled>‚èπÔ∏è Parar Grava√ß√£o</button>
                </div>
                <div id="audio-preview" style="display: none;">
                    <audio controls></audio>
                </div>
            </div>
            <div class="audio-record-footer">
                <button id="cancel-audio">Cancelar</button>
                <button id="send-audio" disabled>Enviar √Åudio</button>
            </div>
        </div>
    </div>

    <script src="/static/js/chat.js"></script>
</body>
</html>

home.tpl:

<!-- app/views/html/home.tpl (MODIFICADO - COM CHAT INTEGRADO) -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online - Conversas</title>
    <link rel="stylesheet" href="/static/css/home.css">
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <!-- Conte√∫do Principal COM CHAT INTEGRADO -->
    <div class="home-container" id="home-container">
        <!-- Sidebar de conversas (40% da tela) -->
        <div class="conversations-sidebar" id="conversations-sidebar">
            <!-- Header da sidebar -->
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-name" id="user-name">Usu√°rio</span>
                </div>
                <div class="header-actions">
                    <button id="status-btn" title="Status">‚óè</button>
                    <button id="new-chat-btn" title="Nova conversa">üí¨</button>
                    <button id="delete-account-btn" title="Excluir minha conta" style="color: #dc3545;">üóëÔ∏è</button>
                    <button id="logout-btn" title="Sair">üö™</button>
                </div>
            </div>

            <!-- Guias de Navega√ß√£o -->
            <div class="navigation-tabs">
                <button class="tab-button active" data-tab="chats">üí¨ Chats</button>
                <button class="tab-button" data-tab="friends">üë• Amigos</button>
            </div>

            <!-- Barra de pesquisa -->
            <div class="search-bar">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Pesquisar conversas...">
                </div>
            </div>

            <!-- Conte√∫do das Guias -->
            <div class="tab-content">
                <!-- Guia de Chats -->
                <div id="chats-tab" class="tab-pane active">
                    <div class="conversations-list" id="conversations-list">
                        <div class="conversation-item" data-chat-type="group" data-chat-id="general">
                            <div class="conversation-avatar group-avatar">üë•</div>
                            <div class="conversation-info">
                                <div class="conversation-name">Chat Geral</div>
                                <div class="conversation-preview">Conversa p√∫blica com todos os usu√°rios</div>
                            </div>
                            <div class="conversation-meta">
                                <div class="conversation-time">Agora</div>
                                <div class="unread-count" style="display: none;">0</div>
                            </div>
                        </div>
                        <!-- Outras conversas ser√£o carregadas aqui -->
                    </div>

                    <!-- Bot√£o flutuante para novo grupo -->
                    <button class="floating-action-button" id="new-group-btn">
                        <span>+</span>
                        Criar grupo
                    </button>
                </div>

                <!-- Guia de Amigos -->
                <div id="friends-tab" class="tab-pane">
                    <div class="friends-header">
                        <button id="view-requests-btn" class="view-requests-btn">
                            üì® Ver Pedidos de Amizade
                        </button>
                    </div>
                    
                    <div class="friends-list" id="friends-list">
                        <!-- Lista de amigos ser√° carregada aqui -->
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <h3>Nenhum amigo adicionado</h3>
                            <p>Comece adicionando amigos para conversar</p>
                            <button id="add-first-friend" class="welcome-btn">
                                <span>‚ûï</span>
                                Adicionar Primeiro Amigo
                            </button>
                        </div>
                    </div>

                    <!-- Bot√£o flutuante para adicionar amigo -->
                    <button class="floating-action-button" id="add-friend-btn">
                        <span>+</span>
                        Adicionar Amigo
                    </button>
                </div>
            </div>
        </div>

        <!-- √Årea do Chat Integrado (60% da tela) -->
        <div class="chat-integrated-area" id="chat-integrated-area">
            <!-- Estado inicial: Mensagem de boas-vindas -->
            <div class="welcome-chat-state" id="welcome-chat-state">
                <div class="welcome-icon">üí¨</div>
                <h1>Bem-vindo ao Chat Online</h1>
                <p>Selecione uma conversa para come√ßar a mensagem</p>
                <p>ou inicie um chat privado com um amigo.</p>
                
                <div class="welcome-actions">
                    <button id="create-group-welcome" class="welcome-btn">
                        <span>üë•</span>
                        Criar Grupo
                    </button>
                    <button id="start-private-chat-welcome" class="welcome-btn">
                        <span>üîí</span>
                        Chat Privado
                    </button>
                </div>
            </div>

            <!-- Chat ativo (inicialmente oculto) -->
            <div class="active-chat" id="active-chat" style="display: none;">
                <!-- Header do Chat -->
                <div class="chat-header">
                    <div class="chat-header-info">
                        <button id="back-to-list" class="back-btn">‚Üê</button>
                        <div class="chat-title-container">
                            <h1 id="chat-title">Chat</h1>
                            <div id="chat-info" class="chat-info"></div>
                        </div>
                    </div>
                    <div class="online-users">
                        <h3>Usu√°rios online:</h3>
                        <ul id="online-list"></ul>
                    </div>
                </div>
                
                <!-- √Årea de Mensagens -->
                <div id="messages" class="messages"></div>
                
                <!-- √Årea de Input -->
                <div class="input-area">
                    <button id="attach-btn" title="Anexar imagem">üìé</button>
                    <button id="record-btn" title="Gravar √°udio">üé§</button>
                    <button id="emoji-btn" title="Emojis">üòÄ</button>
                    <input type="text" id="msg-input" placeholder="Digite sua mensagem..." autocomplete="off">
                    <button id="send-btn">Enviar</button>
                    
                    <input type="file" id="file-input" accept="image/*" style="display: none">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criar novo grupo -->
    <div id="create-group-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Criar Novo Grupo</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="group-name">Nome do Grupo</label>
                    <input type="text" id="group-name" placeholder="Digite o nome do grupo">
                </div>
                <div class="form-group">
                    <label for="group-members">Adicionar Membros</label>
                    <div class="members-list" id="members-list">
                        <!-- Lista de membros online ser√° carregada aqui -->
                        <div class="empty-state">
                            <div class="empty-icon">üë§</div>
                            <p>Nenhum usu√°rio online no momento</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-group">Cancelar</button>
                <button id="create-group">Criar Grupo</button>
            </div>
        </div>
    </div>

    <!-- Modal para chat privado -->
    <div id="private-chat-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Iniciar Chat Privado</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="users-list" id="users-list">
                    <!-- Lista de usu√°rios online ser√° carregada aqui -->
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <p>Nenhum usu√°rio online no momento</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-private">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar amigo -->
    <div id="add-friend-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Amigo</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="friend-username">Nome de usu√°rio</label>
                    <input type="text" id="friend-username" placeholder="Digite o nome de usu√°rio do amigo">
                    <div class="form-hint">Digite o nome exato do usu√°rio que deseja adicionar</div>
                </div>
                <div id="friend-search-results" class="search-results">
                    <!-- Resultados da busca aparecer√£o aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-add-friend">Cancelar</button>
                <button id="send-friend-request">Enviar Pedido de Amizade</button>
            </div>
        </div>
    </div>

    <!-- Modal de Pedidos de Amizade -->
    <div id="friend-requests-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pedidos de Amizade</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="friend-requests-list" class="requests-list">
                    <!-- Lista de pedidos ser√° carregada aqui -->
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>Nenhum pedido de amizade pendente</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-requests">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Popup de Emojis -->
    <div id="emoji-modal" class="emoji-modal" style="display: none;">
        <div class="emoji-modal-content">
            <div class="emoji-header">
                <h3>Escolha um Emoji</h3>
                <span id="close-emoji-modal">&times;</span>
            </div>
            <div class="emoji-search">
                <input type="text" id="emoji-search" placeholder="Pesquisar emojis..." autocomplete="off">
            </div>
            <div id="emoji-grid" class="emoji-grid">
                <!-- Emojis ser√£o injetados via JS -->
            </div>
            <div class="emoji-footer">
                <small id="emoji-count">Total: 0 emojis</small>
            </div>
        </div>
    </div>

    <!-- Preview de imagem -->
    <div id="image-preview-modal" class="image-preview-modal" style="display: none;">
        <div class="image-preview-content">
            <div class="image-preview-header">
                <h3>Pr√©-visualiza√ß√£o da Imagem</h3>
                <span id="close-preview-modal">&times;</span>
            </div>
            <div class="image-preview-body">
                <img id="preview-image" src="" alt="Pr√©-visualiza√ß√£o">
            </div>
            <div class="image-preview-footer">
                <button id="cancel-preview">Cancelar</button>
                <button id="send-image">Enviar Imagem</button>
            </div>
        </div>
    </div>

    <!-- Modal de grava√ß√£o de √°udio -->
    <div id="audio-record-modal" class="audio-record-modal" style="display: none;">
        <div class="audio-record-content">
            <div class="audio-record-header">
                <h3>Gravar √Åudio</h3>
                <span id="close-audio-modal">&times;</span>
            </div>
            <div class="audio-record-body">
                <div id="audio-record-visualizer">Clique em "Iniciar Grava√ß√£o"</div>
                <div id="audio-record-timer">00:00</div>
                <div class="audio-record-controls">
                    <button id="start-record-btn">üé§ Iniciar Grava√ß√£o</button>
                    <button id="stop-record-btn" disabled>‚èπÔ∏è Parar Grava√ß√£o</button>
                </div>
                <div id="audio-preview" style="display: none;">
                    <audio controls></audio>
                </div>
            </div>
            <div class="audio-record-footer">
                <button id="cancel-audio">Cancelar</button>
                <button id="send-audio" disabled>Enviar √Åudio</button>
            </div>
        </div>
    </div>

    <!-- Modal de imagem ampliada -->
    <div id="image-fullscreen-modal" class="image-fullscreen-modal" style="display: none;">
        <div class="image-fullscreen-content">
            <img src="" alt="Imagem em tela cheia">
        </div>
    </div>

    <!-- Modal de Exclus√£o de Conta -->
    <div id="delete-account-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #dc3545; color: white;">
                <h3>üö® Excluir Conta Permanentemente</h3>
                <span class="close-modal" id="close-delete-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div style="color: #721c24; background: #f8d7da; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <strong>ATEN√á√ÉO: Esta a√ß√£o √© IRREVERS√çVEL!</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Todas as suas mensagens ser√£o exclu√≠das</li>
                        <li>Seus grupos ser√£o removidos</li>
                        <li>Suas amizades ser√£o perdidas</li>
                        <li>Seus dados ser√£o apagados permanentemente</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="delete-confirmation-input">
                        Digite <strong>CONFIRMAR EXCLUS√ÉO</strong> para prosseguir:
                    </label>
                    <input type="text" id="delete-confirmation-input" 
                        placeholder="CONFIRMAR EXCLUS√ÉO" 
                        style="border: 2px solid #dc3545; text-align: center; font-weight: bold;">
                </div>
                
                <div style="font-size: 12px; color: #666; text-align: center;">
                    ‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-delete-account" style="background: #6c757d;">Cancelar</button>
                <button id="confirm-delete-account" disabled style="background: #dc3545;">
                    üóëÔ∏è Excluir Minha Conta Permanentemente
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/home.js"></script>
    <script src="/static/js/chat-integrated.js"></script>
</body>
</html>

portal.tpl:

<!-- app/views/html/portal.tpl (COM VISUALIZA√á√ÉO DE SENHA) -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal - Chat Online</title>
    <link rel="stylesheet" href="/static/css/portal.css">
</head>
<body>
    <div class="portal-container">
        <div class="portal-header">
            <h1>üí¨ Chat Online</h1>
            <p>Conecte-se com amigos e colegas</p>
        </div>

        <div class="auth-forms">
            <!-- Formul√°rio de Login -->
            <div class="form-container" id="login-container">
                <h2>Login</h2>
                <form id="login-form">
                    <div class="form-group">
                        <input type="text" id="login-username" placeholder="Seu nome de usu√°rio" required>
                    </div>
                    <div class="form-group password-group">
                        <input type="password" id="login-password" placeholder="Sua senha" required>
                        <button type="button" class="toggle-password" id="toggle-login-password">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <button type="submit" class="btn-primary">Entrar</button>
                </form>
                <p class="switch-form">
                    N√£o tem conta? <a href="#" id="show-register">Cadastre-se</a>
                </p>
            </div>

            <!-- Formul√°rio de Cadastro -->
            <div class="form-container" id="register-container" style="display: none;">
                <h2>Cadastro</h2>
                <form id="register-form">
                    <div class="form-group">
                        <input type="text" id="register-username" placeholder="Nome de usu√°rio" required>
                    </div>
                    <div class="form-group password-group">
                        <input type="password" id="register-password" placeholder="Sua senha" required>
                        <button type="button" class="toggle-password" id="toggle-register-password">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <button type="submit" class="btn-primary">Cadastrar</button>
                </form>
                <p class="switch-form">
                    J√° tem conta? <a href="#" id="show-login">Fa√ßa login</a>
                </p>
            </div>
        </div>

        <div id="message-container" class="message-container"></div>
    </div>

    <script src="/static/js/portal.js"></script>
</body>
</html>